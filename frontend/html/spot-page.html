<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>YuMa - Spot trading</title>
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/spot-page.css">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/cards.css">
</head>
<body>

    <header>
        <div class="header-left">
            <div class="logo"><a href="../../index.html">YuMa</a></div>
            <nav class="main-nav">
                <a href="buy_crypto-page.html">Buy Crypto</a>
                <a href="markets.html">Markets</a>
                <div class="dropdown-container">
                    <a href="#" class="nav-link dropdown-toggle">Trade</a>
                    <div class="dropdown-content trade-dropdown">
                        <div class="dropdown-column">
                            <a href="spot-page.html">Spot</a>
                            <a href="#">Margin</a>
                            <a href="#">P2P</a>
                            <a href="#">Convert & Block Trade</a>
                        </div>
                    </div>
                </div>
                <div class="dropdown-container">
                    <a href="#" class="nav-link dropdown-toggle">Futures</a>
                    <div class="dropdown-content futures-dropdown">
                        <a href="futures-page.html">USD‚ìà-M Futures</a>
                        <a href="#">COIN-M Futures</a>
                        <a href="#">Options</a>
                        <a href="#">Leaderboard</a>
                    </div>
                </div>
                <a href="faq.html">FAQ</a>
            </nav>
        </div>
        <nav class="user-nav">
            <a href="sign_up-page.html" id="signUpLinkSpot">Sign up</a>
            <a href="login-page.html" id="loginLinkSpot">Log in</a>
            <a href="profile.html" id="profileLinkSpot" style="display: none;" title="My Profile">Profile</a>
            <a href="#" id="logoutButtonSpot" class="nav-button" style="display: none;">Log out</a>
        </nav>
    </header>

    <div class="background-svg-decorations">
        <img src="../resources/13.svg" alt="Top Left Blob Decoration" class="decor-element decor-blob-tl">
        <img src="../resources/15.svg" alt="Top Left Ring Decoration" class="decor-element decor-ring-tl">
        <img src="../resources/14.svg" alt="Bottom Right Blob Decoration" class="decor-element decor-blob-br">
        <img src="../resources/16.svg" alt="Bottom Right Ring Decoration" class="decor-element decor-ring-br">
    </div>

    <main class="spot-interface-layout">
    <aside class="left-panel panel-column">
        <div class="ui-panel order-book-card">
            <div class="panel-title">Order Book <span id="orderBookSymbol">(BTC/USDT)</span></div>
            <div class="order-book-columns">
                <span>Price (USDT)</span>
                <span>Amount (BTC)</span>
                <span>Total (USDT)</span>
            </div>
            <div class="order-book-content">
                <div class="asks-container">
                    <ul id="asks-list"></ul>
                </div>
                <div class="current-price-display">
                    <span id="currentMarketPrice">0.00</span>
                </div>
                <div class="bids-container">
                    <ul id="bids-list"></ul>
                </div>
            </div>
        </div>
        <div class="ui-panel order-history-placeholder">
            <div class="panel-title">Open Orders / Order History</div>
            <div id="openOrdersContainer" style="padding:1rem; text-align:center; color:#777; flex-grow:1;">
                (Login to see your orders)
            </div>
        </div>
    </aside>

    <section class="center-content panel-column">
        <div class="ui-panel chart-card">
           <div class="tradingview-widget-container" style="height:100%;width:100%">
             <div id="tradingview_widget_spot" class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
             <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
             {
             "autosize": true,
             "symbol": "BINANCE:BTCUSDT",
             "interval": "D",
             "timezone": "Etc/UTC",
             "theme": "dark",
             "style": "1",
             "locale": "en",
             "allow_symbol_change": true,
             "support_host": "https://www.tradingview.com",
             "container_id": "tradingview_widget_spot"
             }
             </script>
           </div>
        </div>
        <div class="ui-panel spot-trading-panel-card">
            <div class="panel-title">Spot Trading</div>
            <div class="trading-form-container">
                <div class="order-type-tabs">
                    <button class="type-tab active" data-type="spot">–°–ø–æ—Ç</button>
                    <button class="type-tab" data-type="cross" disabled>–ö—Ä–æ—Å</button>
                    <button class="type-tab" data-type="isolated" disabled>–Ü–∑–æ–ª—å–æ–≤–∞–Ω–∏–π</button>
                    <button class="type-tab" data-type="grid" disabled>Grid</button>
                </div>

                <div class="execution-type-tabs">
                    <button class="exec-tab active" data-exec="limit">–õ—ñ–º—ñ—Ç</button>
                    <button class="exec-tab" data-exec="market">–ú–∞—Ä–∫–µ—Ç</button>
                    <div class="dropdown-container stop-limit-dropdown">
                         <button class="exec-tab dropdown-toggle" data-exec="stop-limit" disabled>–°—Ç–æ–ø-–ª—ñ–º—ñ—Ç</button>
                    </div>
                    <span class="info-icon">‚ìò</span>
                </div>

                <div class="order-forms-columns">
                    <form class="order-form buy-form" id="buyOrderForm">
                        <div class="price-input-group">
                            <label for="buy-price">–¶—ñ–Ω–∞</label>
                            <span class="market-price-label" style="display: none;">Market Price</span>
                            <div class="input-with-currency">
                                <input type="number" id="buy-price" placeholder="0.00" step="any">
                                <span class="currency" id="buyPriceQuoteCurrency">USDT</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="buy-amount" id="buyAmountLabel">–°—É–º–∞</label>
                            <div class="input-with-currency">
                                <input type="number" id="buy-amount" placeholder="0.0000" step="any">
                                <span class="currency" id="buyAmountCurrency">BTC</span>
                            </div>
                        </div>
                        <div class="balance-slider">
                            <input type="range" min="0" max="100" value="0" class="slider" id="buySlider">
                            <div class="slider-percentage-markers">
                                <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
                            </div>
                        </div>
                        <div class="total-input-group input-group">
                            <label for="buy-total">–í—Å—å–æ–≥–æ</label>
                            <div class="input-with-currency">
                                <input type="number" id="buy-total" placeholder="0.00" step="any" readonly>
                                <span class="currency" id="buyTotalQuoteCurrency">USDT</span>
                            </div>
                        </div>
                         <div class="advanced-options">
                            <input type="checkbox" id="buy-tp-sl" name="buy-tp-sl" disabled>
                            <label for="buy-tp-sl">TP/SL</label>
                        </div>
                        <div class="available-balance">
                            <span>–î–æ—Å—Ç—É–ø–Ω–æ:</span>
                            <span id="buyAvailableQuote">-- USDT</span>
                        </div>
                        <button type="submit" class="action-button buy-button" disabled>–£–≤—ñ–π—Ç–∏ —â–æ–± –ö—É–ø–∏—Ç–∏ <span id="buyButtonBase">BTC</span></button>
                    </form>

                    <form class="order-form sell-form" id="sellOrderForm">
                         <div class="price-input-group">
                            <label for="sell-price">–¶—ñ–Ω–∞</label>
                             <span class="market-price-label" style="display: none;">Market Price</span>
                            <div class="input-with-currency">
                                <input type="number" id="sell-price" placeholder="0.00" step="any">
                                <span class="currency" id="sellPriceQuoteCurrency">USDT</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="sell-amount" id="sellAmountLabel">–°—É–º–∞</label>
                            <div class="input-with-currency">
                                <input type="number" id="sell-amount" placeholder="0.0000" step="any">
                                <span class="currency" id="sellAmountBaseCurrency">BTC</span>
                            </div>
                        </div>
                        <div class="balance-slider">
                            <input type="range" min="0" max="100" value="0" class="slider" id="sellSlider">
                             <div class="slider-percentage-markers">
                                <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
                            </div>
                        </div>
                         <div class="total-input-group input-group">
                            <label for="sell-total">–í—Å—å–æ–≥–æ</label>
                            <div class="input-with-currency">
                                <input type="number" id="sell-total" placeholder="0.00" step="any" readonly>
                                <span class="currency" id="sellTotalQuoteCurrency">USDT</span>
                            </div>
                        </div>
                        <div class="advanced-options">
                            <input type="checkbox" id="sell-tp-sl" name="sell-tp-sl" disabled>
                            <label for="sell-tp-sl">TP/SL</label>
                        </div>
                        <div class="available-balance">
                            <span>–î–æ—Å—Ç—É–ø–Ω–æ:</span>
                            <span id="sellAvailableBase">-- BTC</span>
                        </div>
                        <button type="submit" class="action-button sell-button" disabled>–£–≤—ñ–π—Ç–∏ —â–æ–± –ü—Ä–æ–¥–∞—Ç–∏ <span id="sellButtonBase">BTC</span></button>
                    </form>
                </div>
                <div id="authPromptTrading" style="display: block; text-align: center; padding: 1rem; color: #777;">
                    <a href="login-page.html">–£–≤—ñ–π–¥—ñ—Ç—å</a> –∞–±–æ <a href="sign_up-page.html">–∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—è</a>, —â–æ–± —Ç–æ—Ä–≥—É–≤–∞—Ç–∏
                </div>
                <div id="orderStatusMessage" style="text-align: center; padding: 0.5rem; margin-top: 10px; font-weight: bold;"></div>
            </div>
        </div>
    </section>

     <aside class="right-panel panel-column">
        <div class="ui-panel pair-search-panel">
            <div class="panel-title">Pairs</div>
            <div class="search-pair-wrapper">
                <input type="text" id="pairSearchInput" placeholder="Search pair, e.g. ETH">
                <span class="search-icon">üîç</span>
            </div>
            <div class="pair-categories">
                <button class="category-btn active" data-quote="USDT">USDT</button>
                <button class="category-btn" data-quote="BTC">BTC</button>
                <button class="category-btn" data-quote="ETH">ETH</button>
            </div>
            <ul id="pairList" class="pair-list-scrollable"></ul>
        </div>

        <div class="ui-panel market-trades-card">
            <div class="panel-title">Market Trades <span id="marketTradesSymbol">(BTC/USDT)</span></div>
            <div class="market-trades-columns">
                <span>Price (USDT)</span>
                <span>Amount (BTC)</span>
                <span>Time</span>
            </div>
            <ul id="market-trades-list"></ul>
        </div>
    </aside>
</main>

<script>
// --- START: Auth UI Logic (–¥–ª—è —Ö–µ–¥–µ—Ä–∞ Spot —Å—Ç–æ—Ä—ñ–Ω–∫–∏) ---
function updateHeaderAuthStateSpot() {
    const token = localStorage.getItem('authToken');
    const signUpLink = document.getElementById('signUpLinkSpot');
    const loginLink = document.getElementById('loginLinkSpot');
    const profileLink = document.getElementById('profileLinkSpot');
    const logoutButton = document.getElementById('logoutButtonSpot');
    const authPromptTradingEl = document.getElementById('authPromptTrading');

    if (token) {
        if (signUpLink) signUpLink.style.display = 'none';
        if (loginLink) loginLink.style.display = 'none';
        if (profileLink) profileLink.style.display = 'inline-block';
        if (logoutButton) logoutButton.style.display = 'inline-block';
        if (authPromptTradingEl) authPromptTradingEl.style.display = 'none';
    } else {
        if (signUpLink) signUpLink.style.display = 'inline-block';
        if (loginLink) loginLink.style.display = 'inline-block';
        if (profileLink) profileLink.style.display = 'none';
        if (logoutButton) logoutButton.style.display = 'none';
        if (authPromptTradingEl) authPromptTradingEl.style.display = 'block';
    }
}

function setupLogoutButtonSpot() {
    const logoutButton = document.getElementById('logoutButtonSpot');
    if (logoutButton) {
        if (!logoutButton.dataset.listenerAttached) {
            logoutButton.addEventListener('click', async (event) => {
                event.preventDefault();
                const currentTokenForLogout = localStorage.getItem('authToken');
                localStorage.removeItem('authToken');
                
                userBalancesCache = {}; // –û—á–∏—Å—Ç–∏—Ç–∏ –∫–µ—à –±–∞–ª–∞–Ω—Å—ñ–≤
                openOrdersCache = []; // –û—á–∏—Å—Ç–∏—Ç–∏ –∫–µ—à –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –æ—Ä–¥–µ—Ä—ñ–≤
                updateBalanceDisplay(); // –û–Ω–æ–≤–∏—Ç–∏ UI –±–∞–ª–∞–Ω—Å—ñ–≤ (–ø–æ–∫–∞–∂–µ --)
                renderOpenOrders();     // –û–Ω–æ–≤–∏—Ç–∏ UI –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –æ—Ä–¥–µ—Ä—ñ–≤
                updateHeaderAuthStateSpot();
                updateActionButtonsState(); // –û–Ω–æ–≤–∏—Ç–∏ —Ç–µ–∫—Å—Ç —Ç–∞ —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫

                if (currentTokenForLogout) {
                    try {
                        await fetch('/auth/logout', { // –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —à–ª—è—Ö –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –¥–æ —Ç–≤–æ–≥–æ API –ª–æ–≥–∞—É—Ç—É
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${currentTokenForLogout}` }
                        });
                        console.log('Logout request sent to backend.');
                    } catch (e) {
                        console.error('Backend logout API error:', e);
                    }
                }
                // –ù–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç–∏, —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–ª–∏—à–∏–≤—Å—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ —Å–ø–æ—Ç—É
                // window.location.href = 'login-page.html'; 
            });
            logoutButton.dataset.listenerAttached = 'true';
        }
    }
}
// --- END: Auth UI Logic ---

document.addEventListener('DOMContentLoaded', async () => {
    console.log("DOM fully loaded and parsed. Initializing Spot Page...");

    updateHeaderAuthStateSpot();
    setupLogoutButtonSpot();

    let currentSymbol = 'BTCUSDT';
    let currentPairDetails = { baseAsset: 'BTC', quoteAsset: 'USDT', pricePrecision: 2, quantityPrecision: 6, tickSize: "0.01", stepSize: "0.000001" };

    const asksListEl = document.getElementById('asks-list');
    const bidsListEl = document.getElementById('bids-list');
    const currentMarketPriceEl = document.getElementById('currentMarketPrice');
    const marketTradesListEl = document.getElementById('market-trades-list');
    const orderBookSymbolEl = document.getElementById('orderBookSymbol');
    const marketTradesSymbolEl = document.getElementById('marketTradesSymbol');
    const pairSearchInputEl = document.getElementById('pairSearchInput');
    const pairListEl = document.getElementById('pairList');
    const categoryButtonsContainer = document.querySelector('.pair-categories');
    const tradingViewWidgetContainerId = 'tradingview_widget_spot';

    const buyOrderForm = document.getElementById('buyOrderForm');
    const sellOrderForm = document.getElementById('sellOrderForm');
    const buyPriceInput = document.getElementById('buy-price');
    const buyMarketPriceLabelEl = buyOrderForm.querySelector('.price-input-group .market-price-label');
    const buyPriceQuoteCurrencyEl = document.getElementById('buyPriceQuoteCurrency');
    const buyAmountLabelEl = document.getElementById('buyAmountLabel');
    const buyAmountInput = document.getElementById('buy-amount');
    const buyAmountCurrencyEl = document.getElementById('buyAmountCurrency');
    const buyTotalInput = document.getElementById('buy-total');
    const buyTotalInputGroup = buyOrderForm.querySelector('.total-input-group');
    const buyAvailableQuoteEl = document.getElementById('buyAvailableQuote');
    const buyButton = buyOrderForm.querySelector('.buy-button');
    const buySlider = document.getElementById('buySlider');

    const sellPriceInput = document.getElementById('sell-price');
    const sellMarketPriceLabelEl = sellOrderForm.querySelector('.price-input-group .market-price-label');
    const sellPriceQuoteCurrencyEl = document.getElementById('sellPriceQuoteCurrency');
    const sellAmountLabelEl = document.getElementById('sellAmountLabel');
    const sellAmountInput = document.getElementById('sell-amount');
    const sellAmountBaseCurrencyEl = document.getElementById('sellAmountBaseCurrency');
    const sellTotalInput = document.getElementById('sell-total');
    const sellTotalInputGroup = sellOrderForm.querySelector('.total-input-group');
    const sellAvailableBaseEl = document.getElementById('sellAvailableBase');
    const sellButton = sellOrderForm.querySelector('.sell-button');
    const sellSlider = document.getElementById('sellSlider');

    const orderStatusMessageEl = document.getElementById('orderStatusMessage');
    const openOrdersContainerEl = document.getElementById('openOrdersContainer');

    let allMarketPairsCache = [];
    let userBalancesCache = {}; // { 'BTC': { available: "1.0", total: "1.0", precision: 8, inOrder: "0.0" }, ... }
    let openOrdersCache = [];

    let orderBookSocket = null;
    let tradesSocket = null;
    let tradingWidgetInstance = null;

    const MAX_OB_LEVELS = 15;
    const MAX_TRADES_HISTORY = 25;

    // --- Helper Functions ---
    function getTradingViewWidgetInstanceWhenReady(callback) {
        let attempts = 0; const maxAttempts = 35;
        const checkInterval = setInterval(() => {
            attempts++;
            if (typeof TradingView !== 'undefined' && TradingView.widgets && TradingView.widgets[tradingViewWidgetContainerId] && typeof TradingView.widgets[tradingViewWidgetContainerId].setSymbol === 'function') {
                clearInterval(checkInterval); tradingWidgetInstance = TradingView.widgets[tradingViewWidgetContainerId];
                console.log(`%cTradingView widget (ID: ${tradingViewWidgetContainerId}) obtained.`, "color: green;", tradingWidgetInstance);
                if (callback) callback(tradingWidgetInstance);
            } else if (attempts >= maxAttempts) {
                clearInterval(checkInterval); console.error(`Timeout: TradingView widget (ID: ${tradingViewWidgetContainerId}) not obtained.`);
            }
        }, 300);
    }

    function formatNumberByPrecision(number, precision) {
        const num = parseFloat(number);
        if (isNaN(num) || isNaN(parseInt(precision))) return number?.toString() || '0'; // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ä—è–¥–æ–∫ –∞–±–æ '0'
        return num.toFixed(parseInt(precision));
    }
    
    function formatPrice(price, pairDetailsOrSymbol) {
        if (price === undefined || price === null) return 'N/A';
        const priceNum = parseFloat(price);
        if (isNaN(priceNum)) return 'N/A';
        let precision = typeof pairDetailsOrSymbol === 'object' ? pairDetailsOrSymbol.pricePrecision : (allMarketPairsCache.find(p=>p.symbol===pairDetailsOrSymbol)?.pricePrecision || 2);
        return priceNum.toFixed(precision);
    }

    function formatAmount(amount, pairDetailsOrSymbol) {
        if (amount === undefined || amount === null) return 'N/A';
        const amountNum = parseFloat(amount);
        if (isNaN(amountNum)) return 'N/A';
        let precision = typeof pairDetailsOrSymbol === 'object' ? pairDetailsOrSymbol.quantityPrecision : (allMarketPairsCache.find(p=>p.symbol===pairDetailsOrSymbol)?.quantityPrecision || 6);
        return amountNum.toFixed(precision);
    }

    // --- WebSocket and Data Rendering ---
    function renderOrderBook(bidsData, asksData) {
        if (!asksListEl || !bidsListEl) return;
        asksListEl.innerHTML = ''; bidsListEl.innerHTML = '';
        const asksToShow = (asksData || []).slice(0, MAX_OB_LEVELS).reverse();
        asksToShow.forEach(ask => { /* ... (–∫–æ–¥ –±–µ–∑ –∑–º—ñ–Ω) ... */ });
        const bidsToShow = (bidsData || []).slice(0, MAX_OB_LEVELS);
        bidsToShow.forEach(bid => { /* ... (–∫–æ–¥ –±–µ–∑ –∑–º—ñ–Ω) ... */ });
        if (currentMarketPriceEl && bidsData?.length && asksData?.length) {
            const bestBid = parseFloat(bidsData[0][0]); const bestAsk = parseFloat(asksData[0][0]);
            const midPrice = (bestBid + bestAsk) / 2;
            const oldPrice = parseFloat(currentMarketPriceEl.dataset.lastPrice || "0");
            currentMarketPriceEl.textContent = formatPrice(midPrice, currentPairDetails);
            currentMarketPriceEl.classList.remove('price-up', 'price-down');
            if (midPrice > oldPrice) currentMarketPriceEl.classList.add('price-up');
            else if (midPrice < oldPrice) currentMarketPriceEl.classList.add('price-down');
            currentMarketPriceEl.dataset.lastPrice = midPrice.toString();
            if (buyPriceInput && buyPriceInput.style.display !== 'none' && !buyPriceInput.value) buyPriceInput.value = formatPrice(bestAsk, currentPairDetails);
            if (sellPriceInput && sellPriceInput.style.display !== 'none' && !sellPriceInput.value) sellPriceInput.value = formatPrice(bestBid, currentPairDetails);
        }
    }
    function renderMarketTrade(trade) {
        if (!marketTradesListEl) return;
        const [, quoteAsset] = splitSymbol(currentSymbol);
        const li = document.createElement('li');
        const priceFormatted = formatPrice(trade.p, quoteAsset);
        const amountFormatted = formatAmount(trade.q);
        const tradeTime = new Date(trade.T).toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit', second: '2-digit'});
        const priceClass = trade.m ? 'sell-trade' : 'buy-trade'; // true if seller is maker (sell trade at bid)
        li.innerHTML = `
            <span class="price ${priceClass}">${priceFormatted}</span>
            <span class="amount">${amountFormatted}</span>
            <span class="time">${tradeTime}</span>`;
        marketTradesListEl.prepend(li);
        if (marketTradesListEl.children.length > MAX_TRADES_HISTORY) {
            marketTradesListEl.removeChild(marketTradesListEl.lastChild);
        }
    }

    function setupWebSocket(socketUrl, onOpenMsg, onMessageCallback, onErrorMsg, onCloseMsg) {
        console.log(`Attempting to connect to WebSocket: ${socketUrl}`);
        const socket = new WebSocket(socketUrl);
        socket.onopen = () => console.log(onOpenMsg);
        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                onMessageCallback(data);
            } catch (e) {
                console.error(`Error parsing message from ${socketUrl}:`, e, event.data);
            }
        };
        socket.onerror = (error) => console.error(`${onErrorMsg}: `, error);
        socket.onclose = (event) => console.log(`${onCloseMsg}. Code: ${event.code}, Reason: ${event.reason}, Clean: ${event.wasClean}`);
        return socket;
    }
    
    function connectOrderBookWebSocket(symbolPair) {
        if (orderBookSocket && orderBookSocket.readyState < WebSocket.CLOSING) { 
            orderBookSocket.close(1000, "Changing symbol - Order Book");
        }
        const wsSym = symbolPair.toLowerCase();
        const url = `wss://stream.binance.com:9443/ws/${wsSym}@depth20@100ms`; // –ó–º—ñ–Ω–∏–≤ –Ω–∞ 100ms –¥–ª—è —à–≤–∏–¥—à–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
        orderBookSocket = setupWebSocket(url, `Order Book WS opened for ${symbolPair}.`,
            (data) => { // Binance @depth streams directly give bids/asks
                if (data.bids && data.asks) { 
                    renderOrderBook(data.bids, data.asks);
                } else if (data.b && data.a) { // For some streams (like depthUpdate, though we're not using diff depth here)
                     renderOrderBook(data.b, data.a);
                }
            },
            `Order Book WS Error for ${symbolPair}`, `Order Book WS closed for ${symbolPair}`
        );
    }

    function connectTradesWebSocket(symbolPair) {
        if (tradesSocket && tradesSocket.readyState < WebSocket.CLOSING) {
            tradesSocket.close(1000, "Changing symbol - Market Trades");
        }
        const wsSym = symbolPair.toLowerCase();
        const url = `wss://stream.binance.com:9443/ws/${wsSym}@trade`;
        tradesSocket = setupWebSocket(url, `Market Trades WS opened for ${symbolPair}.`,
            renderMarketTrade, // renderMarketTrade –≤–∂–µ –ø—Ä–∏–π–º–∞—î –¥–∞–Ω—ñ –∑ WS
            `Market Trades WS Error for ${symbolPair}`, `Market Trades WS closed for ${symbolPair}`
        );
    }

    // --- Symbol and Pair Management ---

    // --- Symbol and Pair Management (–∞–±–æ –ø–æ–¥—ñ–±–Ω–∞ —Å–µ–∫—Ü—ñ—è) ---

/**
 * –†–æ–∑–¥—ñ–ª—è—î —Å–∏–º–≤–æ–ª —Ç–æ—Ä–≥–æ–≤–æ—ó –ø–∞—Ä–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "BTCUSDT") –Ω–∞ –±–∞–∑–æ–≤–∏–π –∞–∫—Ç–∏–≤ —Ç–∞ –∞–∫—Ç–∏–≤ –∫–æ—Ç–∏—Ä—É–≤–∞–Ω–Ω—è.
 * –°–ø–æ—á–∞—Ç–∫—É –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –∑–Ω–∞–π—Ç–∏ —Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ –≤ allMarketPairsCache.
 * –Ø–∫—â–æ –Ω–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –µ–≤—Ä–∏—Å—Ç–∏–∫—É –∑ –≤—ñ–¥–æ–º–∏–º–∏ –∫–æ—Ç–∏—Ä—É–≤–∞–ª—å–Ω–∏–º–∏ –∞–∫—Ç–∏–≤–∞–º–∏.
 * @param {string} symbolPairStr - –°–∏–º–≤–æ–ª —Ç–æ—Ä–≥–æ–≤–æ—ó –ø–∞—Ä–∏, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "BTCUSDT".
 * @returns {Array<string>} –ú–∞—Å–∏–≤ –∑ –¥–≤–æ—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤: [baseAsset, quoteAsset]. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, ["BTC", "USDT"].
 *                          –ê–±–æ ["ERR", "ERR"], —è–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–¥—ñ–ª–∏—Ç–∏.
 */
function splitSymbol(symbolPairStr) {
    if (!symbolPairStr || typeof symbolPairStr !== 'string') {
        console.warn(`[splitSymbol] Invalid input: not a string or empty - ${symbolPairStr}`);
        return ["ERR", "ERR"];
    }

    // 1. –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç: —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–∞–π—Ç–∏ –ø–∞—Ä—É –≤ –∫–µ—à—ñ allMarketPairsCache
    //    –¶–µ–π –∫–µ—à –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ –æ–±'—î–∫—Ç–∏ –∑ –ø–æ–ª—è–º–∏ symbol, baseAsset, quoteAsset.
    //    –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ allMarketPairsCache –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –∫–æ—Ä–µ–∫—Ç–Ω–æ —Ñ—É–Ω–∫—Ü—ñ—î—é fetchAllMarketPairs.
    if (allMarketPairsCache && allMarketPairsCache.length > 0) {
        const cachedPair = allMarketPairsCache.find(p => p.symbol === symbolPairStr);
        if (cachedPair && cachedPair.baseAsset && cachedPair.quoteAsset) {
            return [cachedPair.baseAsset, cachedPair.quoteAsset];
        }
    }

    // 2. Fallback-–ª–æ–≥—ñ–∫–∞, —è–∫—â–æ –≤ –∫–µ—à—ñ –Ω–µ–º–∞—î –∞–±–æ –∫–µ—à —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π.
    //    –°–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω–∏—Ö –∫–æ—Ç–∏—Ä—É–≤–∞–ª—å–Ω–∏—Ö –∞–∫—Ç–∏–≤—ñ–≤. –ú–æ–∂–Ω–∞ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏.
    const commonQuotes = [
        "USDT", "FDUSD", "TUSD", "BUSD", "USDC", "DAI", // –°—Ç–µ–π–±–ª–∫–æ—ñ–Ω–∏
        "TRY", "EUR", "GBP", "AUD", "BRL", "RUB", "UAH", "PLN", // –§—ñ–∞—Ç–Ω—ñ
        "BTC", "ETH", "BNB", "XRP" // –û—Å–Ω–æ–≤–Ω—ñ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∏ —è–∫ –∫–æ—Ç–∏—Ä—É–≤–∞–ª—å–Ω—ñ
    ];

    // –ü–µ—Ä–µ–±–∏—Ä–∞—î–º–æ –≤—ñ–¥–æ–º—ñ –∫–æ—Ç–∏—Ä—É–≤–∞–ª—å–Ω—ñ –∞–∫—Ç–∏–≤–∏ –≤—ñ–¥ –Ω–∞–π–¥–æ–≤—à–æ–≥–æ –¥–æ –Ω–∞–π–∫–æ—Ä–æ—Ç—à–æ–≥–æ,
    // —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "BNBTC" —è–∫ "BNB", "TC" –∑–∞–º—ñ—Å—Ç—å "BNB", "TC")
    // –°–æ—Ä—Ç—É—î–º–æ commonQuotes –∑–∞ –¥–æ–≤–∂–∏–Ω–æ—é –≤ –∑–≤–æ—Ä–æ—Ç–Ω—å–æ–º—É –ø–æ—Ä—è–¥–∫—É (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ, –∞–ª–µ –º–æ–∂–µ –¥–æ–ø–æ–º–æ–≥—Ç–∏ –≤ –¥–µ—è–∫–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö)
    // commonQuotes.sort((a, b) => b.length - a.length); 

    for (const quote of commonQuotes) {
        if (symbolPairStr.endsWith(quote) && symbolPairStr.length > quote.length) {
            const base = symbolPairStr.substring(0, symbolPairStr.length - quote.length);
            // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ–± –±–∞–∑–æ–≤–∏–π –∞–∫—Ç–∏–≤ –Ω–µ –±—É–≤ –ø–æ—Ä–æ–∂–Ω—ñ–º
            if (base.length > 0) {
                return [base, quote];
            }
        }
    }

    // –î—É–∂–µ –≥—Ä—É–±–∏–π fallback –¥–ª—è –Ω–µ–≤—ñ–¥–æ–º–∏—Ö –∫–æ–º–±—ñ–Ω–∞—Ü—ñ–π, –Ω–∞–º–∞–≥–∞—î–º–æ—Å—è –≤—ñ–¥—Ä—ñ–∑–∞—Ç–∏ 3 –∞–±–æ 4 —Å–∏–º–≤–æ–ª–∏
    // –¶—è –ª–æ–≥—ñ–∫–∞ –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ—Ç–æ—á–Ω–æ—é –¥–ª—è –¥–µ—è–∫–∏—Ö –µ–∫–∑–æ—Ç–∏—á–Ω–∏—Ö –ø–∞—Ä.
    if (symbolPairStr.length > 6 && symbolPairStr.length <= 12) { // –î–ª—è –¥–æ–≤—à–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤, –¥–µ –π–º–æ–≤—ñ—Ä–Ω—ñ—à–µ 3-4 —Å–∏–º–≤–æ–ª–∏ –∫–æ—Ç–∏—Ä—É–≤–∞–Ω–Ω—è
        let base = symbolPairStr.substring(0, symbolPairStr.length - 4);
        let quote = symbolPairStr.substring(symbolPairStr.length - 4);
        // –ü—Ä–æ—Å—Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ quote –º—ñ—Å—Ç–∏—Ç—å —Ç—ñ–ª—å–∫–∏ –≤–µ–ª–∏–∫—ñ –ª—ñ—Ç–µ—Ä–∏ (—Ç–∏–ø–æ–≤–æ –¥–ª—è —Å–∏–º–≤–æ–ª—ñ–≤)
        if (base.length > 0 && /^[A-Z0-9]+$/.test(quote)) return [base, quote];

        base = symbolPairStr.substring(0, symbolPairStr.length - 3);
        quote = symbolPairStr.substring(symbolPairStr.length - 3);
        if (base.length > 0 && /^[A-Z0-9]+$/.test(quote)) return [base, quote];

    } else if (symbolPairStr.length > 3 && symbolPairStr.length <= 6) { // –î–ª—è –∫–æ—Ä–æ—Ç—à–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤
        const base = symbolPairStr.substring(0, symbolPairStr.length - 3);
        const quote = symbolPairStr.substring(symbolPairStr.length - 3);
         if (base.length > 0 && /^[A-Z0-9]+$/.test(quote)) return [base, quote];
    }


    console.warn(`[splitSymbol] Could not accurately split symbol using common quotes or length heuristics: "${symbolPairStr}". Returning as is or with error.`);
    // –Ø–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ–º–∏–ª–∫—É –∞–±–æ –Ω–∞–º–∞–≥–∞—î–º–æ—Å—è –∑—Ä–æ–±–∏—Ç–∏ –¥—É–∂–µ –≥—Ä—É–±–µ –ø—Ä–∏–ø—É—â–µ–Ω–Ω—è (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
    // –î–ª—è –±–µ–∑–ø–µ–∫–∏ –∫—Ä–∞—â–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –ø–æ–º–∏–ª–∫—É, —â–æ–± –±—É–ª–æ –≤–∏–¥–Ω–æ –ø—Ä–æ–±–ª–µ–º—É.
    // –ê–±–æ, —è–∫ –≤–∞—Ä—ñ–∞–Ω—Ç, —è–∫—â–æ –ø–µ—Ä–µ–¥–±–∞—á–∞—î—Ç—å—Å—è, —â–æ quote –∑–∞–≤–∂–¥–∏ 3 —Å–∏–º–≤–æ–ª–∏:
    // if (symbolPairStr.length > 3) return [symbolPairStr.substring(0, symbolPairStr.length - 3), symbolPairStr.substring(symbolPairStr.length - 3)];
    
    return ["ERR", "ERR"]; // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ–º–∏–ª–∫—É, —è–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–¥—ñ–ª–∏—Ç–∏
}
    
    function updateSymbolDisplay(symbolPair) {
        const pairInfoFromCache = allMarketPairsCache.find(p => p.symbol === symbolPair);
        if (pairInfoFromCache) {
            currentPairDetails = {...pairInfoFromCache};
        } else { // Fallback if not in cache (should ideally not happen after fetchAllMarketPairs)
            const [baseFallback, quoteFallback] = splitSymbol(symbolPair);
            currentPairDetails = { 
                baseAsset: baseFallback, quoteAsset: quoteFallback, 
                pricePrecision: (quoteFallback === 'USDT' || quoteFallback === 'BUSD') ? 2 : 8, 
                quantityPrecision: 6,
                tickSize: "0.01", stepSize: "0.000001" 
            };
        }
        if(buyPriceInput) buyPriceInput.step = currentPairDetails.tickSize || "any";
        if(buyAmountInput) buyAmountInput.step = currentPairDetails.stepSize || "any";
        if(sellPriceInput) sellPriceInput.step = currentPairDetails.tickSize || "any";
        if(sellAmountInput) sellAmountInput.step = currentPairDetails.stepSize || "any";

        if (orderBookSymbolEl) orderBookSymbolEl.textContent = `(${currentPairDetails.baseAsset}/${currentPairDetails.quoteAsset})`;
        if (marketTradesSymbolEl) marketTradesSymbolEl.textContent = `(${currentPairDetails.baseAsset}/${currentPairDetails.quoteAsset})`;
        const obPriceCol = document.querySelector('.order-book-columns span:first-child');
        const obAmountCol = document.querySelector('.order-book-columns span:nth-child(2)');
        const obTotalCol = document.querySelector('.order-book-columns span:last-child');
        const mtPriceCol = document.querySelector('.market-trades-columns span:first-child');
        const mtAmountCol = document.querySelector('.market-trades-columns span:nth-child(2)');

        if(obPriceCol) obPriceCol.textContent = `Price (${quote})`;
        if(obAmountCol) obAmountCol.textContent = `Amount (${base})`;
        if(obTotalCol) obTotalCol.textContent = `Total (${quote})`;
        if(mtPriceCol) mtPriceCol.textContent = `Price (${quote})`;
        if(mtAmountCol) mtAmountCol.textContent = `Amount (${base})`;
    }

    
    
        async function changeTradingPair(newSymbol) {
        if (currentSymbol === newSymbol && tradingWidgetInstance) { // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —ñ tradingWidgetInstance, –±–æ –∑–º—ñ–Ω–∞ —Å–∏–º–≤–æ–ª—É –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫—É –≤–∞–∂–ª–∏–≤–∞
            console.log(`Symbol ${newSymbol} is already active.`);
            return; // –ù—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ, —è–∫—â–æ —Å–∏–º–≤–æ–ª —Ç–æ–π —Å–∞–º–∏–π
        }
        console.log(`Changing trading pair from ${currentSymbol} to: ${newSymbol}`);

        // 1. –ó–∞–∫—Ä–∏–≤–∞—î–º–æ —Å—Ç–∞—Ä—ñ WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è, —è–∫—â–æ –≤–æ–Ω–∏ —î —Ç–∞ –≤—ñ–¥–∫—Ä–∏—Ç—ñ
        if (orderBookSocket && orderBookSocket.readyState === WebSocket.OPEN) {
            console.log(`Closing Order Book WebSocket for ${currentSymbol}`);
            orderBookSocket.close(1000, "Symbol changed - Order Book");
        }
        if (tradesSocket && tradesSocket.readyState === WebSocket.OPEN) {
            console.log(`Closing Market Trades WebSocket for ${currentSymbol}`);
            tradesSocket.close(1000, "Symbol changed - Market Trades");
        }

        // 2. –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Å–∏–º–≤–æ–ª
        currentSymbol = newSymbol;

        // 3. –û—á–∏—â—É—î–º–æ UI –µ–ª–µ–º–µ–Ω—Ç–∏, –ø–æ–≤'—è–∑–∞–Ω—ñ –∑ –¥–∞–Ω–∏–º–∏ —Å—Ç–∞—Ä–æ—ó –ø–∞—Ä–∏
        if (asksListEl) asksListEl.innerHTML = '<li style="text-align:center;color:#777;padding:10px;">Loading...</li>';
        if (bidsListEl) bidsListEl.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ bids, asks –±—É–¥—É—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∞–Ω—ñ
        if (currentMarketPriceEl) currentMarketPriceEl.textContent = '0.00';
        if (marketTradesListEl) marketTradesListEl.innerHTML = '<li style="text-align:center;color:#777;padding:10px;">Loading...</li>';
        
        // 4. –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–∏–º–≤–æ–ª—É —Ç–∞ –¥–µ—Ç–∞–ª–µ–π –ø–∞—Ä–∏ (—Ü–µ –æ–Ω–æ–≤–∏—Ç—å currentPairDetails)
        updateSymbolDisplay(newSymbol); // –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –º–∞—î –æ–Ω–æ–≤–∏—Ç–∏ currentPairDetails –Ω–∞ –æ—Å–Ω–æ–≤—ñ allMarketPairsCache –∞–±–æ splitSymbol

        // 5. –û–Ω–æ–≤–ª—é—î–º–æ –≤–∞–ª—é—Ç–∏ —É —Ñ–æ—Ä–º–∞—Ö —Ç–æ—Ä–≥—ñ–≤–ª—ñ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –Ω–æ–≤–æ—ó –ø–∞—Ä–∏
        // currentPairDetails –≤–∂–µ –æ–Ω–æ–≤–ª–µ–Ω–æ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ updateSymbolDisplay
        updateTradingFormCurrencies(currentPairDetails.baseAsset, currentPairDetails.quoteAsset);

        // 6. –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫ –ö—É–ø–∏—Ç–∏/–ü—Ä–æ–¥–∞—Ç–∏ (—Ç–µ–∫—Å—Ç, –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å)
        updateActionButtonsState();

        // 7. –û–Ω–æ–≤–ª—é—î–º–æ –±–∞–ª–∞–Ω—Å–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –Ω–æ–≤–æ—ó –ø–∞—Ä–∏, –Ø–ö–©–û –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π
        if (isLoggedIn()) {
            console.log("User is logged in, fetching balances for new pair...");
            await fetchUserBalances(); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ –±–∞–ª–∞–Ω—Å–∏, –∞ updateBalanceDisplay –≤—ñ–∑—å–º–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ
        } else {
            console.log("User not logged in, clearing balance display for new pair.");
            updateBalanceDisplay(); // –Ø–∫—â–æ –Ω–µ –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π, –ø—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–∏—Ç–∏ UI –Ω–∞ "--" –¥–ª—è –Ω–æ–≤–æ—ó –ø–∞—Ä–∏
        }
        
        // 8. –û—á–∏—â–∞—î–º–æ –ø–æ–ª—è –≤–≤–æ–¥—É —É —Ñ–æ—Ä–º–∞—Ö —Ç–æ—Ä–≥—ñ–≤–ª—ñ
        clearFormInputs(buyOrderForm);
        clearFormInputs(sellOrderForm);
        // calculateTotal() –≤–∂–µ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ clearFormInputs

        // 9. –û–Ω–æ–≤–ª—é—î–º–æ —Å–∏–º–≤–æ–ª –Ω–∞ –≤—ñ–¥–∂–µ—Ç—ñ TradingView
        if (tradingWidgetInstance && typeof tradingWidgetInstance.setSymbol === 'function') {
            // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –∑ –≤—ñ–¥–∂–µ—Ç–∞, —è–∫—â–æ –º–æ–∂–ª–∏–≤–æ, –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π
            const currentInterval = tradingWidgetInstance.symbolInterval ? tradingWidgetInstance.symbolInterval().interval : "D";
            const tvSymbol = `BINANCE:${newSymbol.toUpperCase()}`; // Binance –∑–∞–∑–≤–∏—á–∞–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –≤–µ–ª–∏–∫—ñ –ª—ñ—Ç–µ—Ä–∏
            
            console.log(`Attempting to set symbol on TradingView widget: ${tvSymbol} with interval ${currentInterval}`);
            try {
                tradingWidgetInstance.setSymbol(tvSymbol, currentInterval, () => {
                    console.log(`%cTradingView symbol successfully changed to ${tvSymbol}`, "color: green; font-weight: bold;");
                });
            } catch (e) {
                console.error(`%cError setting symbol on TradingView widget: ${e.message}`, "color: red; font-weight: bold;");
                // –ú–æ–∂–ª–∏–≤–æ, –≤–∞—Ä—Ç–æ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—ñ–¥–∂–µ—Ç, —è–∫—â–æ —Ü–µ –ø–æ–≤—Ç–æ—Ä—é–≤–∞–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞
            }
        } else {
             console.warn("Cannot change TradingView symbol: widget instance or setSymbol method not available.");
             // –¢—É—Ç –º–æ–∂–Ω–∞ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞—Ç–∏ —ñ–Ω—Å—Ç–∞–Ω—Å —â–µ —Ä–∞–∑, —è–∫—â–æ –≤—ñ–Ω –Ω–µ –±—É–≤ –æ—Ç—Ä–∏–º–∞–Ω–∏–π –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
             if (!tradingWidgetInstance) {
                console.log("Attempting to re-obtain TradingView widget instance...");
                getTradingViewWidgetInstanceWhenReady(widget => {
                    if (widget && typeof widget.setSymbol === 'function') {
                        const currentInterval = widget.symbolInterval ? widget.symbolInterval().interval : "D";
                        const tvSymbol = `BINANCE:${newSymbol.toUpperCase()}`;
                        widget.setSymbol(tvSymbol, currentInterval, () => {
                             console.log(`%cTradingView symbol successfully changed to ${tvSymbol} (after re-obtaining instance)`, "color: green; font-weight: bold;");
                        });
                    }
                });
             }
        }

        // 10. –ó–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º WebSockets —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö
        // –¶–µ –¥–∞—î —á–∞—Å —Å—Ç–∞—Ä–∏–º —Å–æ–∫–µ—Ç–∞–º –∑–∞–∫—Ä–∏—Ç–∏—Å—è –ø–æ–≤–Ω—ñ—Å—Ç—é —ñ –∑–∞–ø–æ–±—ñ–≥–∞—î –º–æ–∂–ª–∏–≤–∏–º –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∞–º
        setTimeout(async () => {
            console.log(`Reconnecting WebSockets and fetching initial data for ${newSymbol} after delay.`);
            await fetchInitialDataForSymbol(newSymbol); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ (–∫–Ω–∏–≥–∞ –æ—Ä–¥–µ—Ä—ñ–≤, –æ—Å—Ç–∞–Ω–Ω—ñ —É–≥–æ–¥–∏)
            connectOrderBookWebSocket(newSymbol);       // –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ WebSocket –¥–ª—è –∫–Ω–∏–≥–∏ –æ—Ä–¥–µ—Ä—ñ–≤
            connectTradesWebSocket(newSymbol);          // –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ WebSocket –¥–ª—è —Ä–∏–Ω–∫–æ–≤–∏—Ö —É–≥–æ–¥
        }, 700); // –ó–±—ñ–ª—å—à–∏–≤ –∑–∞—Ç—Ä–∏–º–∫—É –¥–æ 700ms –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ
    }

    function renderPairList(pairsToRender) {
        if (!pairListEl) return;
        pairListEl.innerHTML = '';
        if (!pairsToRender || pairsToRender.length === 0) {
            pairListEl.innerHTML = '<li style="text-align:center; padding: 10px; color: #707a8a;">No pairs found.</li>';
            return;
        }
        pairsToRender.slice(0, 100).forEach(pair => { // –û–±–º–µ–∂–µ–Ω–Ω—è –¥–æ 100 –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
            const li = document.createElement('li');
            li.dataset.symbol = pair.symbol;
            const [base, quote] = splitSymbol(pair.symbol);
            const priceFormatted = formatPrice(pair.lastPrice, quote); // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ quote –¥–ª—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
            const changeFormatted = pair.priceChangePercent ? `${parseFloat(pair.priceChangePercent).toFixed(2)}%` : " ";
            const changeClass = pair.priceChangePercent ? (parseFloat(pair.priceChangePercent) >= 0 ? 'positive' : 'negative') : '';
            li.innerHTML = `
                <span class="pair-symbol-group"><span class="symbol-main">${base}</span><span class="symbol-quote">/${quote}</span></span>
                <span class="pair-last-price">${priceFormatted}</span>
                <span class="price-change ${changeClass}">${changeFormatted}</span>`;
            li.addEventListener('click', () => changeTradingPair(pair.symbol));
            pairListEl.appendChild(li);
        });
    }

    function filterAndRenderPairs() {
        if (pairSearchInputEl === null && categoryButtonsContainer === null) return;

        const searchTerm = pairSearchInputEl ? pairSearchInputEl.value.toLowerCase().trim() : "";
        const activeCategoryButton = categoryButtonsContainer ? categoryButtonsContainer.querySelector('.category-btn.active') : null;
        const selectedQuote = (activeCategoryButton && activeCategoryButton.dataset.quote) ? activeCategoryButton.dataset.quote : null;

        if (!allMarketPairsCache.length && searchTerm === "" && selectedQuote === null) { // selectedQuote –º–æ–∂–µ –±—É—Ç–∏ null, —è–∫—â–æ "All" –Ω–µ —î –æ–ø—Ü—ñ—î—é
             if(pairListEl) pairListEl.innerHTML = '<li style="text-align:center; padding:10px; color:#707a8a;">Loading pairs...</li>';
             return;
        }
        
        let filteredPairs = allMarketPairsCache;
        if (selectedQuote) { // –§—ñ–ª—å—Ç—Ä—É—î–º–æ, —è–∫—â–æ –≤–∏–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è (–Ω–µ "All")
            filteredPairs = filteredPairs.filter(pair => pair.quoteAsset === selectedQuote);
        }
        if (searchTerm) {
            filteredPairs = filteredPairs.filter(pair => 
                pair.symbol.toLowerCase().includes(searchTerm) || 
                (pair.baseAsset && pair.baseAsset.toLowerCase().includes(searchTerm)) || 
                (pair.quoteAsset && pair.quoteAsset.toLowerCase().includes(searchTerm))
            );
        }
        renderPairList(filteredPairs);
    }

    async function fetchAllMarketPairs() { 
        console.log("Fetching all market pairs for search...");
        if(pairListEl) pairListEl.innerHTML = '<li style="text-align:center; padding:10px; color:#707a8a;">Loading pairs...</li>';
        try {
            // –°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤—Å—ñ –ø–∞—Ä–∏
            const response = await fetch('https://api.binance.com/api/v3/exchangeInfo');
            if (!response.ok) throw new Error(`Failed to fetch exchange info: ${response.status} ${response.statusText}`);
            const data = await response.json();

            // –ü–æ—Ç—ñ–º –æ—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ —Ç—ñ–∫–µ—Ä—ñ–≤ 24hr –¥–ª—è —Ü—ñ–Ω —Ç–∞ –∑–º—ñ–Ω
            const tickerResponse = await fetch('https://api.binance.com/api/v3/ticker/24hr');
            if(!tickerResponse.ok) console.warn(`Could not fetch 24hr ticker data: ${tickerResponse.status}`);
            const tickerData = tickerResponse.ok ? await tickerResponse.json() : [];
            
            const tickerMap = new Map(tickerData.map(t => [t.symbol, t]));

            if (data.symbols) {
                allMarketPairsCache = data.symbols
                    .filter(s => s.status === 'TRADING' && s.isSpotTradingAllowed) // –§—ñ–ª—å—Ç—Ä—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ñ —Å–ø–æ—Ç–æ–≤—ñ –ø–∞—Ä–∏
                    .map(s => {
                        const ticker = tickerMap.get(s.symbol);
                        return {
                            symbol: s.symbol,
                            baseAsset: s.baseAsset,
                            quoteAsset: s.quoteAsset,
                            lastPrice: ticker ? ticker.lastPrice : null,
                            priceChangePercent: ticker ? ticker.priceChangePercent : null
                        };
                    })
                    .sort((a,b) => a.symbol.localeCompare(b.symbol)); // –°–æ—Ä—Ç—É—î–º–æ –∑–∞ –∞–ª—Ñ–∞–≤—ñ—Ç–æ–º
                console.log(`Loaded ${allMarketPairsCache.length} tradable spot pairs.`);
                filterAndRenderPairs(); // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π —Å–ø–∏—Å–æ–∫ (–º–æ–∂–ª–∏–≤–æ, –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–∏–π –∑–∞ USDT)
            } else {
                console.error("No symbols found in exchangeInfo response.");
                if(pairListEl) pairListEl.innerHTML = '<li style="text-align:center; padding:10px; color:#707a8a;">Failed to load pairs.</li>';
            }
        } catch (error) {
            console.error("Error fetching market pairs:", error);
            if(pairListEl) pairListEl.innerHTML = `<li style="text-align:center; padding:10px; color:red;">Error: ${error.message}</li>`;
        }
    }
    
    async function fetchInitialDataForSymbol(symbol) { 
        console.log(`Fetching initial data for ${symbol} via REST API...`);
        try {
            // –ó–∞–ø–∏—Ç –¥–ª—è –∫–Ω–∏–≥–∏ –æ—Ä–¥–µ—Ä—ñ–≤ (depth)
            const depthResponse = await fetch(`https://api.binance.com/api/v3/depth?symbol=${symbol}&limit=50`); // limit 50 –¥–ª—è –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            if (!depthResponse.ok) {
                console.error(`Failed to fetch initial depth for ${symbol}: ${depthResponse.status} ${depthResponse.statusText}`);
            } else {
                const depthData = await depthResponse.json();
                if (depthData.bids && depthData.asks) { renderOrderBook(depthData.bids, depthData.asks); }
            }

            // –ó–∞–ø–∏—Ç –¥–ª—è –æ—Å—Ç–∞–Ω–Ω—ñ—Ö —É–≥–æ–¥ (trades)
            const tradesResponse = await fetch(`https://api.binance.com/api/v3/trades?symbol=${symbol}&limit=${MAX_TRADES_HISTORY}`);
            if (!tradesResponse.ok) {
                 console.error(`Failed to fetch initial trades for ${symbol}: ${tradesResponse.status} ${tradesResponse.statusText}`);
            } else {
                const tradesData = await tradesResponse.json();
                if (marketTradesListEl) marketTradesListEl.innerHTML = ''; // –û—á–∏—â—É—î–º–æ –ø–µ—Ä–µ–¥ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º
                // Binance API –ø–æ–≤–µ—Ä—Ç–∞—î —É–≥–æ–¥–∏ –≤—ñ–¥ –Ω–∞–π—Å—Ç–∞—Ä—ñ—à–æ—ó –¥–æ –Ω–∞–π–Ω–æ–≤—ñ—à–æ—ó, —Ç–æ–º—É —Ä–µ–≤–µ—Ä—Å—É—î–º–æ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                (tradesData || []).reverse().forEach(t => renderMarketTrade({ p: t.price, q: t.qty, T: t.time, m: !t.isBuyerMaker }));
            }
        } catch (error) {
            console.error(`Error fetching initial data for ${symbol}:`, error);
        }
    }

    // --- Trading Form UI and Logic ---
    const orderTypeTabs = document.querySelectorAll('.order-type-tabs .type-tab');
    const executionTypeTabs = document.querySelectorAll('.execution-type-tabs .exec-tab');
    function setActiveTab(tabsNodeList, clickedTab) {
        tabsNodeList.forEach(tab => tab.classList.remove('active'));
        clickedTab.classList.add('active');
    }

    function updateTradingFormsUI(executionType) {
        const [baseAsset, quoteAsset] = splitSymbol(currentSymbol);
        [buyFormEl, sellFormEl].forEach(formEl => {
            if (!formEl) return; 
            const isBuySide = formEl.classList.contains('buy-form');
            
            const priceInput = formEl.querySelector(isBuySide ? '#buy-price' : '#sell-price');
            const marketPriceLabel = formEl.querySelector('.market-price-label'); // –°–ø—ñ–ª—å–Ω–∏–π –∫–ª–∞—Å –¥–ª—è –º—ñ—Ç–∫–∏
            const priceCurrencySpan = formEl.querySelector(isBuySide ? '#buyPriceQuoteCurrency' : '#sellPriceQuoteCurrency');
            const amountLabel = formEl.querySelector(isBuySide ? '#buyAmountLabel' : '#sellAmountLabel');
            const amountInput = formEl.querySelector(isBuySide ? '#buy-amount' : '#sell-amount');
            const amountCurrencySpan = formEl.querySelector(isBuySide ? '#buyAmountCurrency' : '#sellAmountBaseCurrency'); // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ #buyAmountCurrency –¥–ª—è –∫—É–ø—ñ–≤–ª—ñ
            const totalInputGroup = formEl.querySelector('.total-input-group');
            
            formEl.dataset.orderExecutionType = executionType;

            if (executionType === 'market') {
                if(priceInput) { priceInput.style.display = 'none'; priceInput.disabled = true; priceInput.value = ''; }
                if(priceCurrencySpan) priceCurrencySpan.style.display = 'none';
                if(marketPriceLabel) marketPriceLabel.style.display = 'block';
                
                if (isBuySide) { // –î–ª—è –∫—É–ø—ñ–≤–ª—ñ –∑–∞ —Ä–∏–Ω–∫–æ–º, "–°—É–º–∞" —Å—Ç–∞—î "–í—Å—å–æ–≥–æ" —ñ –≤–≤–æ–¥–∏—Ç—å—Å—è –≤ quote
                    if(amountLabel) amountLabel.textContent = '–í—Å—å–æ–≥–æ';
                    if(amountInput) amountInput.placeholder = "0.00"; // –í USDT
                    if(amountCurrencySpan) amountCurrencySpan.textContent = quoteAsset; // –í–∞–ª—é—Ç–∞ –í—Å—å–æ–≥–æ
                    if (totalInputGroup) totalInputGroup.style.display = 'none'; // –•–æ–≤–∞—î–º–æ –ø–æ–ª–µ "–í—Å—å–æ–≥–æ", –±–æ –≤–æ–Ω–æ —Ç–µ–ø–µ—Ä "–°—É–º–∞"
                } else { // –î–ª—è –ø—Ä–æ–¥–∞–∂—É –∑–∞ —Ä–∏–Ω–∫–æ–º, "–°—É–º–∞" –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤ base
                    if(amountLabel) amountLabel.textContent = '–°—É–º–∞';
                    if(amountInput) amountInput.placeholder = "0.0000"; // –í BTC
                    if(amountCurrencySpan) amountCurrencySpan.textContent = baseAsset; // –í–∞–ª—é—Ç–∞ –°—É–º–∏
                    if (totalInputGroup) totalInputGroup.style.display = 'none'; // –¢–∞–∫–æ–∂ —Ö–æ–≤–∞—î–º–æ, –æ—Å–∫—ñ–ª—å–∫–∏ —Å—É–º–∞ –Ω–µ –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è
                }
            } else if (executionType === 'limit') {
                if (priceInput) { priceInput.style.display = 'block'; priceInput.disabled = false; priceInput.placeholder = "0.00"; }
                if (priceCurrencySpan) priceCurrencySpan.style.display = 'inline';
                if (marketPriceLabel) marketPriceLabel.style.display = 'none';

                // –î–ª—è –ª—ñ–º—ñ—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞, "–°—É–º–∞" –∑–∞–≤–∂–¥–∏ –≤ base-–≤–∞–ª—é—Ç—ñ
                if(amountLabel) amountLabel.textContent = '–°—É–º–∞';
                if(amountInput) amountInput.placeholder = "0.0000"; // –í BTC
                if(amountCurrencySpan) amountCurrencySpan.textContent = baseAsset; // –í–∞–ª—é—Ç–∞ –°—É–º–∏
                if (totalInputGroup) totalInputGroup.style.display = 'block'; // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–ª–µ "–í—Å—å–æ–≥–æ"
            }
        });
    }

    orderTypeTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            setActiveTab(orderTypeTabs, e.currentTarget);
            // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –¥–ª—è –∑–º—ñ–Ω–∏ UI, —è–∫—â–æ —Ç–∏–ø–∏ –æ—Ä–¥–µ—Ä—ñ–≤ (–°–ø–æ—Ç, –ö—Ä–æ—Å —ñ —Ç.–¥.) –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ —Ñ–æ—Ä–º–∏
        });
    });

    executionTypeTabs.forEach(tab => {
        if(!tab.classList.contains('dropdown-toggle')) { 
            tab.addEventListener('click', (e) => {
                // –ó–Ω—ñ–º–∞—î–º–æ .active –∑ —É—Å—ñ—Ö –∫–Ω–æ–ø–æ–∫ —Ç–∏–ø—ñ–≤ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, –∫—Ä—ñ–º dropdown-toggle
                document.querySelectorAll('.execution-type-tabs .exec-tab:not(.dropdown-toggle).active')
                    .forEach(t => t.classList.remove('active'));
                e.currentTarget.classList.add('active');
                const execType = e.currentTarget.dataset.exec;
                updateTradingFormsUI(execType);
            });
        }
    });
    
    function updateTradingFormCurrencies(base, quote) {
        // –ö—É–ø—ñ–≤–ª—è
        if(buyPriceQuoteCurrencyEl) buyPriceQuoteCurrencyEl.textContent = quote;
        // buyAmountCurrencyEl –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤ updateTradingFormsUI –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É –æ—Ä–¥–µ—Ä–∞ (–ª—ñ–º—ñ—Ç/–º–∞—Ä–∫–µ—Ç)
        if(buyFormEl && buyFormEl.querySelector('#buyTotalQuoteCurrency')) buyFormEl.querySelector('#buyTotalQuoteCurrency').textContent = quote;
        const buyButtonBaseSpan = document.getElementById('buyButtonBase');
        if(buyButtonBaseSpan) buyButtonBaseSpan.textContent = base;
        if(buyAvailableQuoteEl) buyAvailableQuoteEl.textContent = `-- ${quote}`;


        // –ü—Ä–æ–¥–∞–∂
        if(sellPriceQuoteCurrencyEl) sellPriceQuoteCurrencyEl.textContent = quote;
        if(sellAmountBaseCurrencyEl) sellAmountBaseCurrencyEl.textContent = base; // –î–ª—è –ø—Ä–æ–¥–∞–∂—É —Å—É–º–∞ –∑–∞–≤–∂–¥–∏ –≤ base
        if(sellFormEl && sellFormEl.querySelector('#sellTotalQuoteCurrency')) sellFormEl.querySelector('#sellTotalQuoteCurrency').textContent = quote;
        const sellButtonBaseSpan = document.getElementById('sellButtonBase');
        if(sellButtonBaseSpan) sellButtonBaseSpan.textContent = base;
        if(sellAvailableBaseEl) sellAvailableBaseEl.textContent = `-- ${base}`;


        // –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è UI –¥–ª—è —Ñ–æ—Ä–º –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–∏–ø—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
        const activeExecTab = document.querySelector('.execution-type-tabs .exec-tab.active:not(.dropdown-toggle)');
        if (activeExecTab) {
            updateTradingFormsUI(activeExecTab.dataset.exec);
        } else { // –Ø–∫—â–æ –∂–æ–¥–µ–Ω –Ω–µ –∞–∫—Ç–∏–≤–Ω–∏–π (–º–∞–ª–æ –± –±—É—Ç–∏, –∞–ª–µ –ø—Ä–æ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫)
            updateTradingFormsUI('limit'); // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
        }
    }
    
    function isLoggedIn() { return !!localStorage.getItem('authToken'); }

    function updateActionButtonsState() {
        const { baseAsset } = currentPairDetails;
        const loggedIn = isLoggedIn();
        const buyBtnTextNode = buyButton ? buyButton.firstChild : null;
        const sellBtnTextNode = sellButton ? sellButton.firstChild : null;
        const buyBtnBaseSpan = document.getElementById('buyButtonBase');
        const sellBtnBaseSpan = document.getElementById('sellButtonBase');

        if (loggedIn) {
            if (buyBtnTextNode) buyBtnTextNode.textContent = `–ö—É–ø–∏—Ç–∏ `;
            if (buyBtnBaseSpan) buyBtnBaseSpan.textContent = baseAsset;
            if (buyButton) buyButton.disabled = false;
            if (sellBtnTextNode) sellBtnTextNode.textContent = `–ü—Ä–æ–¥–∞—Ç–∏ `;
            if (sellBtnBaseSpan) sellBtnBaseSpan.textContent = baseAsset;
            if (sellButton) sellButton.disabled = false;
            if (document.getElementById('authPromptTrading')) document.getElementById('authPromptTrading').style.display = 'none';
        } else {
            if (buyBtnTextNode) buyBtnTextNode.textContent = `–£–≤—ñ–π—Ç–∏ —â–æ–± –ö—É–ø–∏—Ç–∏ `;
            if (buyBtnBaseSpan) buyBtnBaseSpan.textContent = baseAsset;
            if (buyButton) buyButton.disabled = true;
            if (sellBtnTextNode) sellBtnTextNode.textContent = `–£–≤—ñ–π—Ç–∏ —â–æ–± –ü—Ä–æ–¥–∞—Ç–∏ `;
            if (sellBtnBaseSpan) sellBtnBaseSpan.textContent = baseAsset;
            if (sellButton) sellButton.disabled = true;
            if (document.getElementById('authPromptTrading')) document.getElementById('authPromptTrading').style.display = 'block';
        }
    }

    // --- User Balances ---
    async function fetchUserBalances() {
        if (!isLoggedIn()) {
            console.log("User not logged in. Clearing balance cache and display.");
            userBalancesCache = {}; 
            updateBalanceDisplay(); 
            return;
        }
        const token = localStorage.getItem('authToken');
        try {
            console.log(`Fetching user balances from /api/user/balances...`);
            // –í–ê–ñ–õ–ò–í–û: –Ø–∫—â–æ –±–µ–∫–µ–Ω–¥ –Ω–∞ —ñ–Ω—à–æ–º—É –ø–æ—Ä—Ç—É, –≤–∫–∞–∂–∏ –ø–æ–≤–Ω–∏–π URL, –Ω–∞–ø—Ä. 'http://localhost:3001/api/user/balances'
            const response = await fetch('/api/user/balances', { 
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `Failed to fetch balances: ${response.status}` }));
                throw new Error(errorData.message || `HTTP error ${response.status}`);
            }
            const data = await response.json();
            if (data.success && data.balances) {
                userBalancesCache = data.balances;
                console.log("User balances fetched and cached:", userBalancesCache);
            } else {
                console.warn("Failed to fetch balances or data missing:", data.message || "No balances data");
                userBalancesCache = {};
            }
        } catch (error) {
            console.error("Error fetching user balances:", error.message);
            userBalancesCache = {};
        } finally {
            updateBalanceDisplay();
        }
    }

    function updateBalanceDisplay() {
        const { baseAsset, quoteAsset } = currentPairDetails;
        const baseAssetInfo = userBalancesCache[baseAsset];
        const quoteAssetInfo = userBalancesCache[quoteAsset];

        const baseBalanceAvailable = baseAssetInfo ? parseFloat(baseAssetInfo.available) : undefined;
        const basePrecision = baseAssetInfo ? parseInt(baseAssetInfo.precision) : (baseAsset === 'BTC' || baseAsset === 'ETH' ? 8 : 6);
        const quoteBalanceAvailable = quoteAssetInfo ? parseFloat(quoteAssetInfo.available) : undefined;
        const quotePrecision = quoteAssetInfo ? parseInt(quoteAssetInfo.precision) : (quoteAsset === 'USDT' ? 2 : 8);

        if (buyAvailableQuoteEl) {
            buyAvailableQuoteEl.textContent = quoteBalanceAvailable !== undefined ? `${formatNumberByPrecision(quoteBalanceAvailable, quotePrecision)} ${quoteAsset}` : `-- ${quoteAsset}`;
        }
        if (sellAvailableBaseEl) {
            sellAvailableBaseEl.textContent = baseBalanceAvailable !== undefined ? `${formatNumberByPrecision(baseBalanceAvailable, basePrecision)} ${baseAsset}` : `-- ${baseAsset}`;
        }
    }

    // --- Order Creation and Management ---
    function clearFormInputs(formToClear) { // –ó–º—ñ–Ω–∏–≤ –Ω–∞–∑–≤—É –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –¥–ª—è —è—Å–Ω–æ—Å—Ç—ñ
        if (formToClear) {
            formToClear.reset(); // –°–∫–∏–¥–∞—î –≤—Å—ñ –ø–æ–ª—è —Ñ–æ—Ä–º–∏ –¥–æ —ó—Ö–Ω—ñ—Ö –∑–Ω–∞—á–µ–Ω—å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º (–∞–±–æ –ø–æ—Ä–æ–∂–Ω—ñ—Ö)
            
            // –î–æ–¥–∞—Ç–∫–æ–≤–æ –æ—á–∏—Å—Ç–∏–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è, —è–∫—â–æ reset –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–≤ —ñ–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –¥–µ—è–∫–∏—Ö —ñ–Ω–ø—É—Ç—ñ–≤
            const priceInput = formToClear.querySelector('input[type="number"][id$="-price"]'); // –ó–Ω–∞—Ö–æ–¥–∏—Ç—å buy-price –∞–±–æ sell-price
            const amountInput = formToClear.querySelector('input[type="number"][id$="-amount"]'); // –ó–Ω–∞—Ö–æ–¥–∏—Ç—å buy-amount –∞–±–æ sell-amount
            const totalInput = formToClear.querySelector('input[type="number"][id$="-total"]');   // –ó–Ω–∞—Ö–æ–¥–∏—Ç—å buy-total –∞–±–æ sell-total
            
            if(priceInput) priceInput.value = '';
            if(amountInput) amountInput.value = '';
            if(totalInput) totalInput.value = ''; // Total –∑–∞–∑–≤–∏—á–∞–π readonly, –∞–ª–µ reset –º–æ–∂–µ –Ω–µ –æ—á–∏—Å—Ç–∏—Ç–∏

        } else { // –Ø–∫—â–æ —Ñ–æ—Ä–º–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–∞, –æ—á–∏—Å—Ç–∏—Ç–∏ –æ–±–∏–¥–≤—ñ (–∞–ª–µ –∫—Ä–∞—â–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É)
            if (buyOrderForm) clearFormInputs(buyOrderForm);
            if (sellOrderForm) clearFormInputs(sellOrderForm);
        }
        calculateTotal(); // –û–Ω–æ–≤–∏—Ç–∏ Total, —è–∫–∏–π —Ç–µ–ø–µ—Ä –º–∞—î –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º –∞–±–æ –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤–∞–Ω–∏–º
        
        // –°–∫–∏–Ω—É—Ç–∏ —Å–ª–∞–π–¥–µ—Ä–∏
        if (buySlider) buySlider.value = 0;
        if (sellSlider) sellSlider.value = 0;
    }

    function displayOrderStatus(message, isSuccess) {
        if (!orderStatusMessageEl) {
            console.warn("orderStatusMessageEl not found, cannot display message:", message);
            return;
        }
        orderStatusMessageEl.textContent = message;
        orderStatusMessageEl.className = 'order-status-message'; // –°–∫–∏–¥–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∫–ª–∞—Å–∏
        if (isSuccess) {
            orderStatusMessageEl.classList.add('success');
        } else {
            orderStatusMessageEl.classList.add('error');
        }
        orderStatusMessageEl.style.display = 'block';

        // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –¥–µ—è–∫–∏–π —á–∞—Å
        setTimeout(() => {
            if (orderStatusMessageEl) {
                orderStatusMessageEl.textContent = '';
                orderStatusMessageEl.style.display = 'none';
                orderStatusMessageEl.className = 'order-status-message'; // –°–∫–∏–¥–∞—î–º–æ –∫–ª–∞—Å–∏
            }
        }, 7000); // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑–Ω–∏–∫–∞—î —á–µ—Ä–µ–∑ 7 —Å–µ–∫—É–Ω–¥
    }

    function renderOpenOrders() {
        if (!openOrdersContainerEl) {
            console.warn("openOrdersContainerEl not found, cannot render open orders.");
            return;
        }

        if (!isLoggedIn()) {
            openOrdersContainerEl.innerHTML = '<div style="padding:1rem; text-align:center; color:#777;">Login to see your orders.</div>';
            return;
        }

        if (openOrdersCache.length === 0) {
            openOrdersContainerEl.innerHTML = '<div style="padding:1rem; text-align:center; color:#777;">No open orders.</div>';
            return;
        }

        // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ (–º–æ–∂–Ω–∞ –≤–∏–Ω–µ—Å—Ç–∏ –≤ HTML, —è–∫—â–æ —Å—Ç–∞—Ç–∏—á–Ω–æ)
        let headerHtml = `
            <div class="open-orders-header" style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid #444; font-weight: bold; font-size: 0.85em;">
                <span style="flex-basis: 25%;">Pair</span>
                <span style="flex-basis: 15%; text-align: center;">Type</span>
                <span style="flex-basis: 15%; text-align: center;">Side</span>
                <span style="flex-basis: 20%; text-align: right;">Price</span>
                <span style="flex-basis: 25%; text-align: right;">Amount</span>
            </div>`;
        
        let ordersHtml = openOrdersCache.map(order => {
            const [base, quote] = order.pair.includes('/') ? order.pair.split('/') : splitSymbol(order.pair);
            const priceDisplay = order.type === 'market' ? 'Market' : formatPrice(order.price, { pricePrecision: currentPairDetails.pricePrecision, quoteAsset: quote });
            // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ amount (base) –∞–±–æ amount_quote –¥–ª—è market buy
            const amountDisplayValue = order.type === 'market' && order.side === 'buy' && order.amount_quote
                                     ? parseFloat(order.amount_quote)
                                     : parseFloat(order.amount); 
            const amountDisplayUnit = order.type === 'market' && order.side === 'buy' && order.amount_quote ? quote : base;
            const amountPrecision = order.type === 'market' && order.side === 'buy' && order.amount_quote 
                                    ? currentPairDetails.pricePrecision // –¢–æ—á–Ω—ñ—Å—Ç—å –¥–ª—è quote –≤–∞–ª—é—Ç–∏
                                    : currentPairDetails.quantityPrecision; // –¢–æ—á–Ω—ñ—Å—Ç—å –¥–ª—è base –≤–∞–ª—é—Ç–∏
            
            const formattedAmount = isNaN(amountDisplayValue) ? 'N/A' : formatNumberByPrecision(amountDisplayValue, amountPrecision);


            return `
                <li style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid #333; font-size:0.8em; align-items: center;">
                    <span style="flex-basis: 25%;">${order.pair}</span>
                    <span style="flex-basis: 15%; text-align: center; text-transform: capitalize;">${order.type}</span>
                    <span style="flex-basis: 15%; text-align: center; text-transform: capitalize;" class="${order.side === 'buy' ? 'buy-text' : 'sell-text'}">${order.side}</span>
                    <span style="flex-basis: 20%; text-align: right;">${priceDisplay}</span>
                    <span style="flex-basis: 25%; text-align: right;">${formattedAmount} ${amountDisplayUnit}</span>
                </li>
            `;
        }).join('');

        openOrdersContainerEl.innerHTML = `
            ${headerHtml}
            <ul style="list-style:none; padding:0; margin:0; max-height: 200px; overflow-y: auto;">
                ${ordersHtml}
            </ul>`;
    }
    
    async function handleCreateOrder(event, side) {
        event.preventDefault();
        if (!isLoggedIn()) { displayOrderStatus("Please log in to trade.", false); return; }

        const form = side === 'buy' ? buyOrderForm : sellOrderForm;
        const executionType = form.dataset.orderExecutionType || 'limit';
        const { baseAsset, quoteAsset, pricePrecision, quantityPrecision } = currentPairDetails;

        let price = executionType === 'limit' ? parseFloat(form.querySelector(side === 'buy' ? '#buy-price' : '#sell-price').value) : null;
        let amountBase, amountQuote;

        if (executionType === 'limit') {
            amountBase = parseFloat(form.querySelector(side === 'buy' ? '#buy-amount' : '#sell-amount').value);
            if (isNaN(price) || price <= 0) { displayOrderStatus("Invalid price for limit order.", false); return; }
            if (isNaN(amountBase) || amountBase <= 0) { displayOrderStatus("Invalid amount for limit order.", false); return; }
            amountQuote = price * amountBase;
        } else { // market
            if (side === 'buy') {
                amountQuote = parseFloat(form.querySelector('#buy-amount').value); // –£ –ø–æ–ª—ñ "amount" —Ç–µ–ø–µ—Ä –≤–≤–æ–¥–∏—Ç—å—Å—è —Å—É–º–∞ –≤ QUOTE
                if (isNaN(amountQuote) || amountQuote <= 0) { displayOrderStatus("Invalid total for market buy order.", false); return; }
                amountBase = null; // –†–æ–∑—Ä–∞—Ö—É—î—Ç—å—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º/—Ä–∏–Ω–∫–æ–º
            } else { // Market Sell
                amountBase = parseFloat(form.querySelector('#sell-amount').value);
                if (isNaN(amountBase) || amountBase <= 0) { displayOrderStatus("Invalid amount for market sell order.", false); return; }
                amountQuote = null; // –†–æ–∑—Ä–∞—Ö—É—î—Ç—å—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º/—Ä–∏–Ω–∫–æ–º
            }
        }
        
        // –ö–ª—ñ—î–Ω—Ç—Å—å–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å—É
        if (side === 'buy') {
            const availableQuote = userBalancesCache[quoteAsset] ? parseFloat(userBalancesCache[quoteAsset].available) : 0;
            const neededQuote = executionType === 'limit' ? amountQuote : amountQuote; // –î–ª—è –º–∞—Ä–∫–µ—Ç –±–∞–π amountQuote - —Ü–µ —Ç–µ —â–æ –≤–≤—ñ–≤ —é–∑–µ—Ä
            if (neededQuote > availableQuote) {
                displayOrderStatus(`Insufficient ${quoteAsset}. Need ${formatNumberByPrecision(neededQuote, pricePrecision)}, have ${formatNumberByPrecision(availableQuote, pricePrecision)}.`, false);
                return;
            }
        } else { // sell
            const availableBase = userBalancesCache[baseAsset] ? parseFloat(userBalancesCache[baseAsset].available) : 0;
            if (amountBase > availableBase) {
                 displayOrderStatus(`Insufficient ${baseAsset}. Need ${formatNumberByPrecision(amountBase, quantityPrecision)}, have ${formatNumberByPrecision(availableBase, quantityPrecision)}.`, false);
                return;
            }
        }

        const orderPayload = {
            pair: currentSymbol, type: executionType, side: side,
            price: price !== null ? formatNumberByPrecision(price, pricePrecision) : null,
            amount: amountBase !== null ? formatNumberByPrecision(amountBase, quantityPrecision) : null,
            amount_quote: amountQuote !== null ? formatNumberByPrecision(amountQuote, pricePrecision) : null,
        };
        console.log("Order Payload:", orderPayload);
        displayOrderStatus("Placing order...", true);
        
        try {
            const token = localStorage.getItem('authToken');
            // –í–ê–ñ–õ–ò–í–û: –Ø–∫—â–æ –±–µ–∫–µ–Ω–¥ –Ω–∞ —ñ–Ω—à–æ–º—É –ø–æ—Ä—Ç—É, –≤–∫–∞–∂–∏ –ø–æ–≤–Ω–∏–π URL, –Ω–∞–ø—Ä. 'http://localhost:3001/api/orders/create'
            const response = await fetch('/api/orders/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(orderPayload)
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `Order creation failed: ${response.status}` }));
                throw new Error(errorData.message || `HTTP error ${response.status}`);
            }
            const createdOrder = await response.json();

            if (createdOrder.success && createdOrder.order) { // –ü—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î { success: true, order: {...} }
                displayOrderStatus(`Order ${side} ${currentSymbol} placed successfully! ID: ${createdOrder.order.id}`, true);
                openOrdersCache.unshift(createdOrder.order);
                if (openOrdersCache.length > 5) openOrdersCache.pop();
                renderOpenOrders();
                await fetchUserBalances(); // –û–Ω–æ–≤–∏—Ç–∏ –±–∞–ª–∞–Ω—Å–∏ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
                clearFormInputs(form);
            } else {
                 throw new Error(createdOrder.message || "Order creation reported as failed by server.");
            }
        } catch (error) {
            console.error("Error creating order:", error);
            displayOrderStatus(error.message || "Failed to place order.", false);
        }
    }
        // --- Trading Form UI and Logic ---
    // ... (—ñ–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó —Ü—ñ—î—ó —Å–µ–∫—Ü—ñ—ó, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, updateTradingFormsUI) ...

    /**
     * –†–æ–∑—Ä–∞—Ö–æ–≤—É—î —Ç–∞ –æ–Ω–æ–≤–ª—é—î –ø–æ–ª–µ "–í—Å—å–æ–≥–æ" (total) –¥–ª—è –ª—ñ–º—ñ—Ç–Ω–∏—Ö –æ—Ä–¥–µ—Ä—ñ–≤
     * –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤–≤–µ–¥–µ–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å —Ü—ñ–Ω–∏ —Ç–∞ —Å—É–º–∏.
     */
    function calculateTotal() {
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∏–∑–Ω–∞—á–µ–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ —Ç–∞ currentPairDetails
        if (!buyPriceInput || !buyAmountInput || !buyTotalInput || 
            !sellPriceInput || !sellAmountInput || !sellTotalInput || 
            !currentPairDetails || !currentPairDetails.pricePrecision === undefined) {
            // console.warn("[calculateTotal] Required elements or currentPairDetails not fully initialized.");
            return;
        }

        const buyPrice = parseFloat(buyPriceInput.value);
        const buyAmount = parseFloat(buyAmountInput.value);
        const sellPrice = parseFloat(sellPriceInput.value);
        const sellAmount = parseFloat(sellAmountInput.value);

        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –¥–ª—è —Ñ–æ—Ä–º–∏ –∫—É–ø—ñ–≤–ª—ñ (Buy)
        if (buyOrderForm && buyOrderForm.dataset.orderExecutionType === 'limit') {
            if (!isNaN(buyPrice) && !isNaN(buyAmount) && buyPrice > 0 && buyAmount > 0) {
                const total = buyPrice * buyAmount;
                buyTotalInput.value = formatNumberByPrecision(total, currentPairDetails.pricePrecision);
            } else {
                buyTotalInput.value = ''; // –û—á–∏—â–∞—î–º–æ, —è–∫—â–æ –¥–∞–Ω—ñ –Ω–µ–≤–∞–ª—ñ–¥–Ω—ñ
            }
        } else if (buyOrderForm && buyOrderForm.dataset.orderExecutionType !== 'market') {
            // –î–ª—è —ñ–Ω—à–∏—Ö —Ç–∏–ø—ñ–≤ (—è–∫—â–æ –±—É–¥—É—Ç—å), –∞–±–æ —è–∫—â–æ –Ω–µ –ª—ñ–º—ñ—Ç —ñ –Ω–µ –º–∞—Ä–∫–µ—Ç (–Ω–µ –º–∞—î –±—É—Ç–∏)
             buyTotalInput.value = '';
        }
        // –î–ª—è market buy, –ø–æ–ª–µ "Total" –∞–±–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ, –∞–±–æ "Amount" —î –ø–æ–ª–µ–º Total, —Ç–æ–º—É —Ç—É—Ç –Ω–µ —á—ñ–ø–∞—î–º–æ

        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –¥–ª—è —Ñ–æ—Ä–º–∏ –ø—Ä–æ–¥–∞–∂—É (Sell)
        if (sellOrderForm && sellOrderForm.dataset.orderExecutionType === 'limit') {
            if (!isNaN(sellPrice) && !isNaN(sellAmount) && sellPrice > 0 && sellAmount > 0) {
                const total = sellPrice * sellAmount;
                sellTotalInput.value = formatNumberByPrecision(total, currentPairDetails.pricePrecision);
            } else {
                sellTotalInput.value = ''; // –û—á–∏—â–∞—î–º–æ, —è–∫—â–æ –¥–∞–Ω—ñ –Ω–µ–≤–∞–ª—ñ–¥–Ω—ñ
            }
        } else if (sellOrderForm && sellOrderForm.dataset.orderExecutionType !== 'market') {
            sellTotalInput.value = '';
        }
        // –î–ª—è market sell, –ø–æ–ª–µ "Total" –∑–∞–∑–≤–∏—á–∞–π –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ, —Å—É–º–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–∏–Ω–∫–æ–≤–æ—ó —Ü—ñ–Ω–∏
    }

    // –ù–∞–≤—ñ—à—É—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π 'input' –Ω–∞ –ø–æ–ª—è —Ü—ñ–Ω–∏ —Ç–∞ —Å—É–º–∏
    // –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –ø–µ—Ä–µ—Ä–∞—Ö—É–Ω–∫—É "–í—Å—å–æ–≥–æ"
    [buyPriceInput, buyAmountInput, sellPriceInput, sellAmountInput].forEach(inputElement => {
        if (inputElement) {
            inputElement.addEventListener('input', calculateTotal);
        }
    });


    /**
     * –ù–∞–ª–∞—à—Ç–æ–≤—É—î –ª–æ–≥—ñ–∫—É —Ä–æ–±–æ—Ç–∏ —Å–ª–∞–π–¥–µ—Ä—ñ–≤ –±–∞–ª–∞–Ω—Å—É –¥–ª—è —Ñ–æ—Ä–º –∫—É–ø—ñ–≤–ª—ñ —Ç–∞ –ø—Ä–æ–¥–∞–∂—É.
     */
    function setupSliders() {
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∏–∑–Ω–∞—á–µ–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ —Ç–∞ –∫–µ—à—ñ
        if (!buySlider || !sellSlider || !userBalancesCache || !currentPairDetails) {
            console.warn("[setupSliders] Required elements or caches not fully initialized.");
            return;
        }

        // --- –°–ª–∞–π–¥–µ—Ä –¥–ª—è —Ñ–æ—Ä–º–∏ –∫—É–ø—ñ–≤–ª—ñ (Buy) ---
        buySlider.addEventListener('input', (e) => {
            const percentage = parseInt(e.target.value); // –í—ñ–¥—Å–æ—Ç–æ–∫ –≤—ñ–¥ 0 –¥–æ 100
            const quoteAsset = currentPairDetails.quoteAsset;
            const quoteAssetInfo = userBalancesCache[quoteAsset];
            
            if (!quoteAssetInfo || quoteAssetInfo.available === undefined) {
                buyAmountInput.value = '';
                if (buyTotalInput) buyTotalInput.value = '';
                return;
            }

            const availableQuote = parseFloat(quoteAssetInfo.available);
            const quotePrecision = parseInt(quoteAssetInfo.precision) || currentPairDetails.pricePrecision || 2;

            const executionType = buyOrderForm.dataset.orderExecutionType || 'limit';

            if (executionType === 'limit') {
                const price = parseFloat(buyPriceInput.value);
                if (availableQuote > 0 && price > 0) {
                    const totalToSpend = (availableQuote * percentage) / 100;
                    const amountToBuyBase = totalToSpend / price;
                    
                    buyAmountInput.value = formatNumberByPrecision(amountToBuyBase, currentPairDetails.quantityPrecision);
                    buyTotalInput.value = formatNumberByPrecision(totalToSpend, quotePrecision);
                } else {
                    buyAmountInput.value = '';
                    buyTotalInput.value = '';
                }
            } else if (executionType === 'market') {
                // –î–ª—è Market Buy, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∫–∞–∑—É—î 'amount_quote' (—Å–∫—ñ–ª—å–∫–∏ USDT –≤–∏—Ç—Ä–∞—Ç–∏—Ç–∏)
                // –ü–æ–ª–µ 'buyAmountInput' –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è —Ü—ñ—î—ó —Å—É–º–∏ (amount_quote)
                const totalToSpend = (availableQuote * percentage) / 100;
                buyAmountInput.value = formatNumberByPrecision(totalToSpend, quotePrecision);
                // –ü–æ–ª–µ Total –¥–ª—è Market Buy –∑–∞–∑–≤–∏—á–∞–π –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ –∞–±–æ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è
            }
        });

        // --- –°–ª–∞–π–¥–µ—Ä –¥–ª—è —Ñ–æ—Ä–º–∏ –ø—Ä–æ–¥–∞–∂—É (Sell) ---
        sellSlider.addEventListener('input', (e) => {
            const percentage = parseInt(e.target.value);
            const baseAsset = currentPairDetails.baseAsset;
            const baseAssetInfo = userBalancesCache[baseAsset];

            if (!baseAssetInfo || baseAssetInfo.available === undefined) {
                sellAmountInput.value = '';
                if (sellTotalInput) sellTotalInput.value = '';
                return;
            }
            
            const availableBase = parseFloat(baseAssetInfo.available);
            const basePrecision = parseInt(baseAssetInfo.precision) || currentPairDetails.quantityPrecision || 6;
            const quotePrecision = currentPairDetails.pricePrecision || 2;

            const executionType = sellOrderForm.dataset.orderExecutionType || 'limit';

            if (availableBase > 0) {
                const amountToSellBase = (availableBase * percentage) / 100;
                sellAmountInput.value = formatNumberByPrecision(amountToSellBase, basePrecision);

                if (executionType === 'limit') {
                    const price = parseFloat(sellPriceInput.value);
                    if (price > 0) {
                        const totalReceived = price * amountToSellBase;
                        sellTotalInput.value = formatNumberByPrecision(totalReceived, quotePrecision);
                    } else {
                        sellTotalInput.value = '';
                    }
                }
                // –î–ª—è Market Sell, –ø–æ–ª–µ Total –∑–∞–∑–≤–∏—á–∞–π –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ, —Å—É–º–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–∏–Ω–∫–æ–≤–æ—ó —Ü—ñ–Ω–∏
            } else {
                sellAmountInput.value = '';
                sellTotalInput.value = '';
            }
        });
    }

    if (buyOrderForm) buyOrderForm.addEventListener('submit', (e) => handleCreateOrder(e, 'buy'));
    if (sellOrderForm) sellOrderForm.addEventListener('submit', (e) => handleCreateOrder(e, 'sell'));
    if (pairSearchInputEl) pairSearchInputEl.addEventListener('input', filterAndRenderPairs);
    if (categoryButtonsContainer) { categoryButtonsContainer.addEventListener('click', (e) => { /* ... */ }); }

    // --- Page Initialization ---
    async function initializePage() {
        console.log("Initializing Spot Page logic...");
        updateHeaderAuthStateSpot();
        await fetchAllMarketPairs();
        updateSymbolDisplay(currentSymbol);
        updateTradingFormCurrencies(currentPairDetails.baseAsset, currentPairDetails.quoteAsset);
        updateActionButtonsState();
        if (isLoggedIn()) {
            await fetchUserBalances();
            // –¢—É—Ç –º–æ–∂–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç—ñ –æ—Ä–¥–µ—Ä–∏, —è–∫—â–æ —î —Ç–∞–∫–∏–π –µ–Ω–¥–ø–æ—ñ–Ω—Ç
            // await fetchOpenOrders(); 
        } else {
            updateBalanceDisplay(); // –ü–æ–∫–∞–∑–∞—Ç–∏ "--" —è–∫—â–æ –Ω–µ –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π
            renderOpenOrders(); // –ü–æ–∫–∞–∑–∞—Ç–∏ "Login to see..."
        }
        renderOpenOrders(); // –ü–æ—á–∞—Ç–∫–æ–≤–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º)
        setupSliders();
        await fetchInitialDataForSymbol(currentSymbol);
        connectOrderBookWebSocket(currentSymbol);
        connectTradesWebSocket(currentSymbol);
        getTradingViewWidgetInstanceWhenReady(/* callback */);
    }

    initializePage();
});
</script>

</body>
</html>
