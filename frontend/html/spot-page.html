<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>YuMa - Spot trading</title>
    <link rel="stylesheet" href="../css/header.css"> <!-- –£–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π —Ö–µ–¥–µ—Ä -->
    <link rel="stylesheet" href="../css/spot-page.css">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/cards.css">
</head>
<body>

    <header> <!-- HTML-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö–µ–¥–µ—Ä–∞, –∞–Ω–∞–ª–æ–≥—ñ—á–Ω–∞ markets.html -->
        <div class="header-left">
            <div class="logo"><a href="../../index.html">YuMa</a></div>
            <nav class="main-nav">
                <a href="buy_crypto-page.html">Buy Crypto</a>
                <a href="markets.html">Markets</a>
                <div class="dropdown-container">
                    <a href="#" class="nav-link dropdown-toggle">Trade</a>
                    <div class="dropdown-content trade-dropdown">
                        <div class="dropdown-column">
                            <!-- –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å active –¥–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è -->
                            <a href="spot-page.html" class="active">Spot</a>
                            <a href="#">Margin</a>
                            <a href="#">P2P</a>
                            <a href="#">Convert & Block Trade</a>
                        </div>
                    </div>
                </div>
                <div class="dropdown-container">
                    <a href="#" class="nav-link dropdown-toggle">Futures</a>
                    <div class="dropdown-content futures-dropdown">
                        <a href="futures-page.html">USD‚ìà-M Futures</a>
                        <a href="#">COIN-M Futures</a>
                        <a href="#">Options</a>
                        <a href="#">Leaderboard</a>
                    </div>
                </div>
                <a href="#">FAQ</a>
            </nav>
        </div>
        <nav class="user-nav">
            <!-- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç—ñ –∂ ID, —â–æ —ñ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ markets –¥–ª—è —É–Ω—ñ—Ñ—ñ–∫–∞—Ü—ñ—ó —Å–∫—Ä–∏–ø—Ç–∞ -->
            <a href="sign_up-page.html" id="signUpLinkMarkets">Sign up</a>
            <a href="login-page.html" id="loginLinkMarkets">Log in</a>
            <a href="profile.html" id="profileLinkAccount" style="display: none;" title="My Profile">Profile</a>
            <a id="logoutButtonOrders" class="nav-button" style="display: none;">Log out</a>
        </nav>
    </header>
    <div class="background-svg-decorations">
        <img src="../resources/13.svg" alt="Top Left Blob Decoration" class="decor-element decor-blob-tl">
        <img src="../resources/15.svg" alt="Top Left Ring Decoration" class="decor-element decor-ring-tl"> <!-- –£–í–ê–ì–ê: –¢–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–ª–∞ 15.svg —Ç—É—Ç, –º–æ–∂–ª–∏–≤–æ, –º–∞–ª–æ –±—É—Ç–∏ 14.svg? -->
        <img src="../resources/14.svg" alt="Bottom Right Blob Decoration" class="decor-element decor-blob-br"> <!-- –£–í–ê–ì–ê: –¢–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–ª–∞ 14.svg —Ç—É—Ç, –º–æ–∂–ª–∏–≤–æ, –º–∞–ª–æ –±—É—Ç–∏ 15.svg? -->
        <img src="../resources/16.svg" alt="Bottom Right Ring Decoration" class="decor-element decor-ring-br">
    </div>

    <div class="page-specific-title">
        <h1>Spot Trading</h1>
    </div>

    <main class="spot-interface-layout">
    <aside class="left-panel panel-column">
        <div class="ui-panel order-book-card">
            <div class="panel-title">Order Book <span id="orderBookSymbol">(BTC/USDT)</span></div>
            <div class="order-book-columns">
                <span>Price (USDT)</span>
                <span>Amount (BTC)</span>
                <span>Total (USDT)</span>
            </div>
            <div class="order-book-content">
                <div class="asks-container">
                    <ul id="asks-list">
                        <!-- –ó–∞—è–≤–∫–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∂ (asks) –±—É–¥—É—Ç—å —Ç—É—Ç -->
                    </ul>
                </div>
                <div class="current-price-display">
                    <span id="currentMarketPrice">0.00</span> <!-- –î–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó —Ü—ñ–Ω–∏ –º—ñ–∂ asks/bids -->
                </div>
                <div class="bids-container">
                    <ul id="bids-list">
                        <!-- –ó–∞—è–≤–∫–∏ –Ω–∞ –∫—É–ø—ñ–≤–ª—é (bids) –±—É–¥—É—Ç—å —Ç—É—Ç -->
                    </ul>
                </div>
            </div>
        </div>
        <div class="ui-panel order-history-placeholder"> 
            <div class="panel-title">Open Orders / Order History</div>
            <div style="padding:1rem; text-align:center; color:#777; flex-grow:1;">
                (Content for open orders, order history, trade history will be here with tabs)
            </div>
        </div>
    </aside>

    <section class="center-content panel-column">
        <div class="ui-panel chart-card">
           <!-- TradingView Widget BEGIN -->
            <div class="tradingview-widget-container" style="height:100%;width:100%">
              <div id="tradingview_widget_target_div" class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
              {
              "autosize": true,
              "symbol": "BINANCE:BTCUSDT",
              "interval": "D",
              "timezone": "Etc/UTC",
              "theme": "light",
              "style": "1",
              "locale": "en",
              "allow_symbol_change": true,
              "support_host": "https://www.tradingview.com"
            }
              </script>
            </div>
            <!-- TradingView Widget END -->
        </div>
        <div class="ui-panel spot-trading-panel-card">
            <div class="panel-title">Spot Trading</div>
            <div class="trading-form-container">
                <div class="order-type-tabs">
                    <button class="type-tab active" data-type="spot">–°–ø–æ—Ç</button>
                    <button class="type-tab" data-type="cross">–ö—Ä–æ—Å</button>
                    <button class="type-tab" data-type="isolated">–Ü–∑–æ–ª—å–æ–≤–∞–Ω–∏–π</button>
                    <button class="type-tab" data-type="grid">Grid</button>
                </div>

                <div class="execution-type-tabs">
                    <button class="exec-tab active" data-exec="limit">–õ—ñ–º—ñ—Ç</button>
                    <button class="exec-tab" data-exec="market">–ú–∞—Ä–∫–µ—Ç</button>
                    <div class="dropdown-container stop-limit-dropdown">
                         <button class="exec-tab dropdown-toggle" data-exec="stop-limit">–°—Ç–æ–ø-–ª—ñ–º—ñ—Ç</button>
                    </div>
                    <span class="info-icon">‚ìò</span>
                </div>

                <div class="order-forms-columns">
                    <div class="order-form buy-form" data-order-execution-type="limit">
                        <div class="input-group price-input-group">
                            <label for="buy-price">–¶—ñ–Ω–∞</label>
                            <div class="input-with-currency">
                                <input type="number" id="buy-price" placeholder="0.00">
                                <span class="currency" id="buyPriceQuoteCurrency">USDT</span>
                            </div>
                             <span class="market-price-label" style="display: none;">–†–∏–Ω–∫–æ–≤–∞ —Ü—ñ–Ω–∞</span>
                        </div>
                        <div class="input-group">
                            <label for="buy-amount" id="buyAmountLabel">–°—É–º–∞</label>
                            <div class="input-with-currency">
                                <input type="number" id="buy-amount" placeholder="0.0000">
                                <span class="currency" id="buyAmountCurrency">BTC</span>
                            </div>
                        </div>
                        <div class="balance-slider">
                            <input type="range" min="0" max="100" value="0" class="slider" id="buySlider">
                            <div class="slider-percentage-markers">
                                <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
                            </div>
                        </div>
                        <div class="input-group total-input-group">
                            <label for="buy-total">–í—Å—å–æ–≥–æ</label>
                            <div class="input-with-currency">
                                <input type="number" id="buy-total" placeholder="0.00" readonly>
                                <span class="currency" id="buyTotalQuoteCurrency">USDT</span>
                            </div>
                        </div>
                         <div class="advanced-options">
                            <input type="checkbox" id="buy-tp-sl" name="buy-tp-sl">
                            <label for="buy-tp-sl">TP/SL</label>
                        </div>
                        <div class="available-balance">
                            <span>–î–æ—Å—Ç—É–ø–Ω–æ:</span>
                            <span id="buyAvailableQuote">-- USDT</span>
                        </div>
                        <button class="action-button buy-button">–ö—É–ø–∏—Ç–∏ <span id="buyButtonBase">BTC</span></button>
                    </div>

                    <div class="order-form sell-form" data-order-execution-type="limit">
                        <div class="input-group price-input-group">
                            <label for="sell-price">–¶—ñ–Ω–∞</label>
                            <div class="input-with-currency">
                                <input type="number" id="sell-price" placeholder="0.00">
                                <span class="currency" id="sellPriceQuoteCurrency">USDT</span>
                            </div>
                            <span class="market-price-label" style="display: none;">–†–∏–Ω–∫–æ–≤–∞ —Ü—ñ–Ω–∞</span>
                        </div>
                        <div class="input-group">
                            <label for="sell-amount" id="sellAmountLabel">–°—É–º–∞</label>
                            <div class="input-with-currency">
                                <input type="number" id="sell-amount" placeholder="0.0000">
                                <span class="currency" id="sellAmountBaseCurrency">BTC</span>
                            </div>
                        </div>
                        <div class="balance-slider">
                            <input type="range" min="0" max="100" value="0" class="slider" id="sellSlider">
                             <div class="slider-percentage-markers">
                                <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
                            </div>
                        </div>
                         <div class="input-group total-input-group">
                            <label for="sell-total">–í—Å—å–æ–≥–æ</label>
                            <div class="input-with-currency">
                                <input type="number" id="sell-total" placeholder="0.00" readonly>
                                <span class="currency" id="sellTotalQuoteCurrency">USDT</span>
                            </div>
                        </div>
                        <div class="advanced-options">
                            <input type="checkbox" id="sell-tp-sl" name="sell-tp-sl">
                            <label for="sell-tp-sl">TP/SL</label>
                        </div>
                        <div class="available-balance">
                            <span>–î–æ—Å—Ç—É–ø–Ω–æ:</span>
                            <span id="sellAvailableBase">-- BTC</span>
                        </div>
                        <button class="action-button sell-button">–ü—Ä–æ–¥–∞—Ç–∏ <span id="sellButtonBase">BTC</span></button>
                    </div>
                </div>
                <div class="auth-prompt" style="display: none; text-align: center; padding: 1rem; color: #777;">
                    –£–≤—ñ–π–¥—ñ—Ç—å –∞–±–æ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—è, —â–æ–± —Ç–æ—Ä–≥—É–≤–∞—Ç–∏
                </div>
            </div>
        </div>
    </section>

     <aside class="right-panel panel-column">
        <div class="ui-panel pair-search-panel">
            <div class="panel-title">Pairs</div>
            <div class="search-pair-wrapper">
                <input type="text" id="pairSearchInput" placeholder="Search pair, e.g. ETH">
                <span class="search-icon">üîç</span>
            </div>
            <div class="pair-categories">
                <button class="category-btn active" data-quote="USDT">USDT</button>
                <button class="category-btn" data-quote="BTC">BTC</button>
                <button class="category-btn" data-quote="ETH">ETH</button>
            </ul>
        </div>
        <div class="ui-panel market-trades-card">
            <div class="panel-title">Market Trades <span id="marketTradesSymbol">(BTC/USDT)</span></div>
            <div class="market-trades-columns">
                <span>Price (USDT)</span>
                <span>Amount (BTC)</span>
                <span>Time</span>
            </div>
            <ul id="market-trades-list"></ul>
        </div>
    </aside>
</main>

<script>
// --- START: Auth UI Logic (–¥–ª—è —Ö–µ–¥–µ—Ä–∞) ---
function updateHeaderAuthState() {
    const token = localStorage.getItem('authToken');
    const signUpLink = document.getElementById('signUpLinkMarkets'); // ID –∑ HTML
    const loginLink = document.getElementById('loginLinkMarkets');   // ID –∑ HTML
    const profileLink = document.getElementById('profileLinkAccount'); // ID –∑ HTML
    const logoutButton = document.getElementById('logoutButtonOrders');   // ID –∑ HTML

    if (token) {
        if (signUpLink) signUpLink.style.display = 'none';
        if (loginLink) loginLink.style.display = 'none';
        if (profileLink) profileLink.style.display = 'inline-block'; // 'inline-block' –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç—ñ —è–∫ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
        if (logoutButton) logoutButton.style.display = 'inline-block'; // 'inline-block' –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç—ñ —è–∫ –∫–Ω–æ–ø–∫–∞/–ø–æ—Å–∏–ª–∞–Ω–Ω—è
    } else {
        if (signUpLink) signUpLink.style.display = 'inline-block';
        if (loginLink) loginLink.style.display = 'inline-block';
        if (profileLink) profileLink.style.display = 'none';
        if (logoutButton) logoutButton.style.display = 'none';
    }

    // userGreetingMarkets –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –Ω–∞ —Ü—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ, —Ç–æ–º—É –∫–æ–¥, —â–æ –π–æ–≥–æ —Å—Ç–æ—Å—É—î—Ç—å—Å—è, –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω —Ç—É—Ç,
    // –∞–ª–µ —è–∫—â–æ –≤—ñ–Ω —î –≤ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ–π —Ñ—É–Ω–∫—Ü—ñ—ó, —Ç–æ –≤—ñ–Ω –ø—Ä–æ—Å—Ç–æ –Ω–µ –∑–Ω–∞–π–¥–µ –µ–ª–µ–º–µ–Ω—Ç —ñ –Ω–µ –≤–∏–∫–ª–∏—á–µ –ø–æ–º–∏–ª–∫—É.
}

function setupLogoutButton() {
    const logoutButton = document.getElementById('logoutButtonOrders');
    if (logoutButton) {
        if (!logoutButton.dataset.listenerAttached) { // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –Ω–∞–≤—ñ—à—É–≤–∞–Ω–Ω—é —Å–ª—É—Ö–∞—á–∞
            logoutButton.addEventListener('click', async (event) => {
                event.preventDefault();
                const currentTokenForLogout = localStorage.getItem('authToken');
                localStorage.removeItem('authToken');
                
                // –û—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É, —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–æ–≥–æ –¥–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ (—è–∫—â–æ —î, –∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ markets.html)
                if (typeof window.allMarketPairsCache !== 'undefined') {
                    window.allMarketPairsCache = []; // –ù–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ —Å–ø–æ—Ç —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ `allMarketPairsCache`
                }
                // –ú–æ–∂–ª–∏–≤–æ, —Ç–∞–∫–æ–∂ –∑–∞–∫—Ä–∏—Ç–∏ WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è, —è–∫—â–æ –≤–æ–Ω–∏ –∑–∞–ª–µ–∂–∞—Ç—å –≤—ñ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó

                updateHeaderAuthState(); // –û–Ω–æ–≤–ª—é—î–º–æ –≤–∏–≥–ª—è–¥ —Ö–µ–¥–µ—Ä–∞

                try {
                    if (currentTokenForLogout) {
                        // –ü–µ—Ä–µ–¥–±–∞—á–∞—î—Ç—å—Å—è, —â–æ '/auth/logout' - —Ü–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —à–ª—è—Ö –¥–æ API
                        await fetch('/auth/logout', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${currentTokenForLogout}` }
                        });
                    }
                } catch (e) {
                    console.error('Logout API error', e);
                }
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –ª–æ–≥—ñ–Ω—É (–ø–µ—Ä–µ–¥–±–∞—á–∞—î—Ç—å—Å—è, —â–æ –≤–æ–Ω–∞ –≤ —Ç—ñ–π –∂–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó)
                window.location.href = 'login-page.html';
            });
            logoutButton.dataset.listenerAttached = 'true';
        }
    }
}
// --- END: Auth UI Logic ---

document.addEventListener('DOMContentLoaded', async () => {
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Å—Ç–∞–Ω —Ö–µ–¥–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    updateHeaderAuthState();
    setupLogoutButton();

    console.log("DOM fully loaded and parsed. Initializing Spot Page...");

    let currentSymbol = 'BTCUSDT'; // –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å–∏–º–≤–æ–ª

    // –ï–ª–µ–º–µ–Ω—Ç–∏ DOM
    const asksListEl = document.getElementById('asks-list');
    const bidsListEl = document.getElementById('bids-list');
    const currentMarketPriceEl = document.getElementById('currentMarketPrice');
    const marketTradesListEl = document.getElementById('market-trades-list');
    const orderBookSymbolEl = document.getElementById('orderBookSymbol');
    const marketTradesSymbolEl = document.getElementById('marketTradesSymbol');
    const pairSearchInputEl = document.getElementById('pairSearchInput');
    const pairListEl = document.getElementById('pairList');
    const categoryButtonsContainer = document.querySelector('.pair-categories');
    // ID —Ü—ñ–ª—å–æ–≤–æ–≥–æ div –¥–ª—è TradingView –≤—ñ–¥–∂–µ—Ç—É, —è–∫–∏–π –≤–∂–µ —î –≤ HTML
    const tradingViewWidgetTargetDivIdFromHTML = 'tradingview_widget_target_div';


    // –ï–ª–µ–º–µ–Ω—Ç–∏ —Ñ–æ—Ä–º —Ç–æ—Ä–≥—ñ–≤–ª—ñ
    const buyFormEl = document.querySelector('.buy-form');
    const sellFormEl = document.querySelector('.sell-form');
    // –ö—É–ø—ñ–≤–ª—è
    const buyPriceInput = document.getElementById('buy-price');
    // –í–∞–∂–ª–∏–≤–æ: buyMarketPriceLabelEl –±—É–¥–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ –ø—ñ–∑–Ω—ñ—à–µ, –≤ updateTradingFormsUI, —Ç–∞–∫ —è–∫ –≤–æ–Ω–æ —î –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ buyFormEl
    const buyPriceQuoteCurrencyEl = document.getElementById('buyPriceQuoteCurrency');
    const buyAmountLabelEl = document.getElementById('buyAmountLabel'); // –ó–º—ñ–Ω–µ–Ω–æ –∑ sellAmountLabel
    const buyAmountInput = document.getElementById('buy-amount');
    const buyAmountCurrencyEl = document.getElementById('buyAmountCurrency'); // –ó–º—ñ–Ω–µ–Ω–æ –∑ buyAmountBaseCurrency
    // –í–∞–∂–ª–∏–≤–æ: buyTotalInputGroup –±—É–¥–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ –ø—ñ–∑–Ω—ñ—à–µ
    // –ü—Ä–æ–¥–∞–∂
    const sellPriceInput = document.getElementById('sell-price');
    // –í–∞–∂–ª–∏–≤–æ: sellMarketPriceLabelEl –±—É–¥–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ –ø—ñ–∑–Ω—ñ—à–µ
    const sellPriceQuoteCurrencyEl = document.getElementById('sellPriceQuoteCurrency');
    const sellAmountLabelEl = document.getElementById('sellAmountLabel');
    const sellAmountInput = document.getElementById('sell-amount');
    const sellAmountBaseCurrencyEl = document.getElementById('sellAmountBaseCurrency');
    // –í–∞–∂–ª–∏–≤–æ: sellTotalInputGroup –±—É–¥–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ –ø—ñ–∑–Ω—ñ—à–µ
    
    // –ö–Ω–æ–ø–∫–∏ –ö—É–ø–∏—Ç–∏/–ü—Ä–æ–¥–∞—Ç–∏
    const buyButton = document.querySelector('.buy-button');
    const sellButton = document.querySelector('.sell-button');


    let allMarketPairsCache = [];
    let orderBookSocket = null;
    let tradesSocket = null;
    let tradingWidgetInstance = null; 

    const MAX_OB_LEVELS = 15;
    const MAX_TRADES_HISTORY = 25;

    // --- –í–ó–ê–Ñ–ú–û–î–Ü–Ø –ó –Ü–°–ù–£–Æ–ß–ò–ú TRADINGVIEW WIDGET ---
    function getTradingViewWidgetInstanceWhenReady(callback) {
        let attempts = 0;
        const maxAttempts = 35; 
        const checkInterval = setInterval(() => {
            attempts++;
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ TradingView –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è —ñ —á–∏ –≤—ñ–¥–∂–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∏–π –∑–∞ –π–æ–≥–æ ID
            // –î–ª—è –≤—ñ–¥–∂–µ—Ç—ñ–≤, –≤–±—É–¥–æ–≤–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ HTML <script>, –µ–∫–∑–µ–º–ø–ª—è—Ä —á–∞—Å—Ç–æ –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ TradingView.widgets
            // –ö—Ä–∞—â–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏, —á–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—ñ–¥–∂–µ—Ç–∞ –±—É–≤ –æ–±—Ä–æ–±–ª–µ–Ω–∏–π —Å–∫—Ä–∏–ø—Ç–æ–º TradingView
            const widgetContainer = document.getElementById(tradingViewWidgetTargetDivIdFromHTML);
            if (typeof TradingView !== 'undefined' && TradingView.ready && widgetContainer && widgetContainer.querySelector('iframe')) { // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ iframe
                // –Ø–∫—â–æ –º–∏ –Ω–µ –º–æ–∂–µ–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä—è–º–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä, –º–∏ –º–æ–∂–µ–º–æ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –≤–∑–∞—î–º–æ–¥—ñ—è—Ç–∏ –∑ –Ω–∏–º —á–µ—Ä–µ–∑ postMessage, 
                // –∞–±–æ, —è–∫—â–æ –≤—ñ–¥–∂–µ—Ç –¥–æ–∑–≤–æ–ª—è—î –∑–º—ñ–Ω—É —Å–∏–º–≤–æ–ª—É —á–µ—Ä–µ–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–µ.
                // –î–ª—è –≤—ñ–¥–∂–µ—Ç—É Advanced Chart, –∑–º—ñ–Ω–∞ —Å–∏–º–≤–æ–ª—É –∑–∞–∑–≤–∏—á–∞–π –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –π–æ–≥–æ API, —è–∫—â–æ —î –µ–∫–∑–µ–º–ø–ª—è—Ä.
                // –Ø–∫—â–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ –Ω–µ–º–∞—î, –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –≤—ñ–¥–∂–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–Ω–æ.
                // –ü–æ–∫–∏ —â–æ, –ø—Ä–∏–ø—É—Å—Ç–∏–º–æ, —â–æ `allow_symbol_change: true` —ñ `tradingWidgetInstance.setSymbol` –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º—É—Ç—å, —è–∫—â–æ –µ–∫–∑–µ–º–ø–ª—è—Ä –≤–¥–∞—Å—Ç—å—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏.
                // –Ø–∫—â–æ –Ω—ñ, —Ü—è —Ñ—É–Ω–∫—Ü—ñ—è –ø—Ä–æ—Å—Ç–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —â–æ –≤—ñ–¥–∂–µ—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è.
                console.log("%cTradingView widget HTML structure seems ready (iframe found).", "color: orange; font-weight: bold;");
                
                // –°–ø—Ä–æ–±–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä (–º–æ–∂–µ –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –¥–ª—è HTML-–≤–±—É–¥–æ–≤–∞–Ω–∏—Ö)
                if (TradingView.widgets && TradingView.widgets[tradingViewWidgetTargetDivIdFromHTML]) {
                     tradingWidgetInstance = TradingView.widgets[tradingViewWidgetTargetDivIdFromHTML];
                     console.log("%cTradingView widget instance obtained successfully!", "color: green; font-weight: bold;", tradingWidgetInstance);
                } else {
                     console.warn("Could not obtain a direct TradingView widget instance via ID. Symbol changes might require re-creating the widget if `setSymbol` on a generic object fails.");
                     // –°—Ç–≤–æ—Ä—é—î–º–æ "—Ñ–∞–Ω—Ç–æ–º–Ω–∏–π" –æ–±'—î–∫—Ç, —â–æ–± —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ setSymbol, —è–∫—â–æ TradingView.onready –Ω–∞–¥–∞—î API
                     if (window.tvWidget) tradingWidgetInstance = window.tvWidget; // –Ø–∫—â–æ –≤—ñ–¥–∂–µ—Ç –∑–±–µ—Ä—ñ–≥–∞—î —Å–µ–±–µ –≥–ª–æ–±–∞–ª—å–Ω–æ
                }

                clearInterval(checkInterval);
                if (callback && typeof callback === 'function') {
                    callback(tradingWidgetInstance);
                }
            } else if (attempts >= maxAttempts) {
                clearInterval(checkInterval);
                console.error("Timeout or failure: TradingView widget (container id:", tradingViewWidgetTargetDivIdFromHTML, ") did not initialize as expected (iframe not found or TradingView not ready).");
            }
        }, 300);
    }
    
    // --- –§–£–ù–ö–¶–Ü–á –§–û–†–ú–ê–¢–£–í–ê–ù–ù–Ø ---
    function formatPrice(price, symbolQuoteOrFullSymbol) {
        let quote = '';
        if (symbolQuoteOrFullSymbol) {
            const parts = splitSymbol(symbolQuoteOrFullSymbol); 
            quote = parts[1];
        }

        if (price === undefined || price === null) return 'N/A';
        const priceNum = parseFloat(price);
        if (isNaN(priceNum)) return 'N/A';

        if (['USDT', 'FDUSD', 'BUSD', 'USDC', 'DAI', 'TUSD'].includes(quote)) {
            if (priceNum === 0) return "0.00"; 
            if (priceNum >= 100) return priceNum.toFixed(2);
            if (priceNum >= 1) return priceNum.toFixed(3);
            if (priceNum >= 0.001) return priceNum.toFixed(4); 
            if (priceNum >= 0.00001) return priceNum.toFixed(5);
            return priceNum.toFixed(6);
        } else if (['BTC', 'ETH', 'BNB'].includes(quote)) {
            return priceNum.toFixed(8);
        }
        if (priceNum >= 1) return priceNum.toFixed(4);
        return priceNum.toFixed(8);
    }

    function formatAmount(amount) {
        if (amount === undefined || amount === null) return 'N/A';
        const amountNum = parseFloat(amount);
        if (isNaN(amountNum)) return 'N/A';
        if (amountNum === 0) return "0.0000";
        if (amountNum < 0.0001 && amountNum > 0) return amountNum.toPrecision(2); 
        if (amountNum < 1) return amountNum.toFixed(6);
        return amountNum.toFixed(4);
    }

    // --- –§–£–ù–ö–¶–Ü–á –û–ù–û–í–õ–ï–ù–ù–Ø UI (OrderBook, MarketTrades) ---
    function renderOrderBook(bidsData, asksData) {
        if (!asksListEl || !bidsListEl) { console.error("Order book list elements not found!"); return; }
        const [, quoteAsset] = splitSymbol(currentSymbol); 

        asksListEl.innerHTML = '';
        bidsListEl.innerHTML = '';

        const asksToShow = (asksData || []).slice(0, MAX_OB_LEVELS).reverse();
        asksToShow.forEach(ask => {
            const [price, quantity] = ask;
            const li = document.createElement('li');
            const priceFormatted = formatPrice(price, quoteAsset);
            const amountFormatted = formatAmount(quantity);
            const total = formatPrice((parseFloat(price) * parseFloat(quantity)), quoteAsset);
            li.innerHTML = `
                <span class="price ask-price">${priceFormatted}</span>
                <span class="amount">${amountFormatted}</span>
                <span class="total">${total}</span>`;
            const totalAsksQuantity = (asksData || []).reduce((sum, item) => sum + parseFloat(item[1] || 0), 0);
            const depthPercentage = (parseFloat(quantity || 0) / (totalAsksQuantity || 1)) * 200;
            li.style.background = `linear-gradient(to left, rgba(239, 68, 68, 0.15) ${Math.min(depthPercentage,100)}%, transparent ${Math.min(depthPercentage,100)}%)`;
            asksListEl.appendChild(li);
        });

        const bidsToShow = (bidsData || []).slice(0, MAX_OB_LEVELS);
        bidsToShow.forEach(bid => {
            const [price, quantity] = bid;
            const li = document.createElement('li');
            const priceFormatted = formatPrice(price, quoteAsset);
            const amountFormatted = formatAmount(quantity);
            const total = formatPrice((parseFloat(price) * parseFloat(quantity)), quoteAsset);
            li.innerHTML = `
                <span class="price bid-price">${priceFormatted}</span>
                <span class="amount">${amountFormatted}</span>
                <span class="total">${total}</span>`;
            const totalBidsQuantity = (bidsData || []).reduce((sum, item) => sum + parseFloat(item[1] || 0), 0);
            const depthPercentage = (parseFloat(quantity || 0) / (totalBidsQuantity || 1)) * 200;
            li.style.background = `linear-gradient(to right, rgba(16, 185, 129, 0.15) ${Math.min(depthPercentage,100)}%, transparent ${Math.min(depthPercentage,100)}%)`;
            bidsListEl.appendChild(li);
        });

        if (currentMarketPriceEl && bidsData && bidsData.length > 0 && asksData && asksData.length > 0) {
            const bestBid = parseFloat(bidsData[0][0]);
            const bestAsk = parseFloat(asksData[0][0]);
            const midPrice = (bestBid + bestAsk) / 2;
            currentMarketPriceEl.textContent = formatPrice(midPrice, quoteAsset);
            currentMarketPriceEl.classList.remove('price-up', 'price-down');
            const lastPrice = parseFloat(currentMarketPriceEl.dataset.lastPrice);
            if (!isNaN(lastPrice)) {
                if (lastPrice < midPrice ) currentMarketPriceEl.classList.add('price-up');
                else if (lastPrice > midPrice ) currentMarketPriceEl.classList.add('price-down');
            }
            currentMarketPriceEl.dataset.lastPrice = midPrice.toString();
        }
    }

    function renderMarketTrade(trade) {
        if (!marketTradesListEl) return;
        const [, quoteAsset] = splitSymbol(currentSymbol); 
        const li = document.createElement('li');
        const priceFormatted = formatPrice(trade.p, quoteAsset);
        const amountFormatted = formatAmount(trade.q);
        const tradeTime = new Date(trade.T).toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit', second: '2-digit'});
        const priceClass = trade.m ? 'sell-trade' : 'buy-trade';
        li.innerHTML = `
            <span class="price ${priceClass}">${priceFormatted}</span>
            <span class="amount">${amountFormatted}</span>
            <span class="time">${tradeTime}</span>`;
        marketTradesListEl.prepend(li);
        if (marketTradesListEl.children.length > MAX_TRADES_HISTORY) {
            marketTradesListEl.removeChild(marketTradesListEl.lastChild);
        }
    }

    // --- –§–£–ù–ö–¶–Ü–á –î–õ–Ø WEBSOCKET ---
    function setupWebSocket(socketUrl, onOpenMsg, onMessageCallback, onErrorMsg, onCloseMsg) {
        console.log(`Attempting to connect to WebSocket: ${socketUrl}`);
        const socket = new WebSocket(socketUrl);
        socket.onopen = () => console.log(onOpenMsg);
        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                onMessageCallback(data);
            } catch (e) {
                console.error(`Error parsing message from ${socketUrl}:`, e, event.data);
            }
        };
        socket.onerror = (error) => console.error(`${onErrorMsg}: `, error);
        socket.onclose = (event) => console.log(`${onCloseMsg}. Code: ${event.code}, Reason: ${event.reason}, Clean: ${event.wasClean}`);
        return socket;
    }
    
    function connectOrderBookWebSocket(symbolPair) {
        if (orderBookSocket && orderBookSocket.readyState < WebSocket.CLOSING) { 
            orderBookSocket.close(1000, "Changing symbol - Order Book");
        }
        const wsSym = symbolPair.toLowerCase();
        const url = `wss://stream.binance.com:9443/ws/${wsSym}@depth20@1000ms`;
        orderBookSocket = setupWebSocket(url, `Order Book WS opened for ${symbolPair}.`,
            (data) => {
                if (data.bids && data.asks) { 
                    renderOrderBook(data.bids, data.asks);
                } else if (data.b && data.a) { 
                     renderOrderBook(data.b, data.a);
                } else if (data.e === 'depthUpdate') {
                    // –î–∏—Ñ–µ—Ä–µ–Ω—Ü—ñ–π–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∫–ª–∞–¥–Ω—ñ—à—ñ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –±–µ–∑ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ —Å–Ω–µ–ø—à–æ—Ç—É —á–µ—Ä–µ–∑ REST
                    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏, —Ü–µ–π –ø—Ä–∏–∫–ª–∞–¥ –æ—á—ñ–∫—É—î –ø–æ–≤–Ω—ñ —Å–Ω–µ–ø—à–æ—Ç–∏ –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î REST –¥–ª—è –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ.
                    console.warn("[OrderBook WS]: Received differential 'depthUpdate'. Full snapshot logic preferred for this example implementation.");
                }
            },
            `Order Book WS Error for ${symbolPair}`, `Order Book WS closed for ${symbolPair}`
        );
    }

    function connectTradesWebSocket(symbolPair) {
        if (tradesSocket && tradesSocket.readyState < WebSocket.CLOSING) {
            tradesSocket.close(1000, "Changing symbol - Market Trades");
        }
        const wsSym = symbolPair.toLowerCase();
        const url = `wss://stream.binance.com:9443/ws/${wsSym}@trade`;
        tradesSocket = setupWebSocket(url, `Market Trades WS opened for ${symbolPair}.`,
            renderMarketTrade,
            `Market Trades WS Error for ${symbolPair}`, `Market Trades WS closed for ${symbolPair}`
        );
    }
    
    // --- –§–£–ù–ö–¶–Ü–á –î–õ–Ø –†–û–ë–û–¢–ò –ó –ü–ê–†–ê–ú–ò ---
    function updateSymbolDisplay(symbolPair) {
        const [base, quote] = splitSymbol(symbolPair);
        if (orderBookSymbolEl) orderBookSymbolEl.textContent = `(${base}/${quote})`;
        if (marketTradesSymbolEl) marketTradesSymbolEl.textContent = `(${base}/${quote})`;
        
        const obPriceCol = document.querySelector('.order-book-columns span:first-child');
        const obAmountCol = document.querySelector('.order-book-columns span:nth-child(2)');
        const obTotalCol = document.querySelector('.order-book-columns span:last-child');
        const mtPriceCol = document.querySelector('.market-trades-columns span:first-child');
        const mtAmountCol = document.querySelector('.market-trades-columns span:nth-child(2)');

        if(obPriceCol) obPriceCol.textContent = `Price (${quote})`;
        if(obAmountCol) obAmountCol.textContent = `Amount (${base})`;
        if(obTotalCol) obTotalCol.textContent = `Total (${quote})`;
        if(mtPriceCol) mtPriceCol.textContent = `Price (${quote})`;
        if(mtAmountCol) mtAmountCol.textContent = `Amount (${base})`;
    }

    function splitSymbol(symbolPair) {
        if (!symbolPair || typeof symbolPair !== 'string') return ["ERR", "ERR"];
        const commonQuotes = ["USDT", "FDUSD", "BUSD", "USDC", "DAI", "TUSD", "BTC", "ETH", "BNB", "TRY", "EUR", "GBP", "UAH", "PLN"];
        for (const quote of commonQuotes) {
            if (symbolPair.endsWith(quote) && symbolPair.length > quote.length) {
                const base = symbolPair.substring(0, symbolPair.length - quote.length);
                return [base, quote];
            }
        }
        // Fallback for less common quote assets (e.g. 3 or 4 chars)
        if (symbolPair.length > 4) return [symbolPair.substring(0,symbolPair.length-4), symbolPair.substring(symbolPair.length-4)];
        if (symbolPair.length > 3) return [symbolPair.substring(0,symbolPair.length-3), symbolPair.substring(symbolPair.length-3)];
        return [symbolPair, ""]; // Should not happen for valid pairs
    }

    async function changeTradingPair(newSymbol) {
        console.log(`Attempting to change trading pair to: ${newSymbol}`);
        if (currentSymbol === newSymbol && tradingWidgetInstance) {
            console.log(`Symbol ${newSymbol} is already active.`);
            return;
        }
        
        if (orderBookSocket && orderBookSocket.readyState === WebSocket.OPEN) orderBookSocket.close(1000, "Symbol changed - OB");
        if (tradesSocket && tradesSocket.readyState === WebSocket.OPEN) tradesSocket.close(1000, "Symbol changed - MT");
        
        currentSymbol = newSymbol; 
        
        if(asksListEl) asksListEl.innerHTML = '<li style="text-align:center;color:#777;padding:10px;">Loading...</li>';
        if(bidsListEl) bidsListEl.innerHTML = '';
        if(currentMarketPriceEl) currentMarketPriceEl.textContent = '0.00';
        if(marketTradesListEl) marketTradesListEl.innerHTML = '<li style="text-align:center;color:#777;padding:10px;">Loading...</li>';
        
        updateSymbolDisplay(newSymbol);
        const [base, quote] = splitSymbol(newSymbol);
        updateTradingFormCurrencies(base, quote);
        updateActionButtonsState();

        // –°–ø—Ä–æ–±–∞ –æ–Ω–æ–≤–∏—Ç–∏ —Å–∏–º–≤–æ–ª TradingView –≤—ñ–¥–∂–µ—Ç–∞
        // –¶–µ —Å–ø—Ä–∞—Ü—é—î, —è–∫—â–æ tradingWidgetInstance –±—É–ª–æ –æ—Ç—Ä–∏–º–∞–Ω–æ –∞–±–æ —î –≥–ª–æ–±–∞–ª—å–Ω–∏–π API
        if (tradingWidgetInstance && typeof tradingWidgetInstance.setSymbol === 'function') {
            const currentInterval = (tradingWidgetInstance.options && tradingWidgetInstance.options.interval) ? tradingWidgetInstance.options.interval : "D"; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ "D" —è–∫ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –∑ HTML
            tradingWidgetInstance.setSymbol(`BINANCE:${newSymbol}`, currentInterval, () => {
                console.log(`%cTradingView symbol successfully changed to BINANCE:${newSymbol}`, "color: green; font-weight: bold;");
            });
        } else if (window.TradingView && typeof TradingView.changeSymbol === 'function') { // –î–µ—è–∫—ñ –≤–µ—Ä—Å—ñ—ó –º–æ–∂—É—Ç—å –º–∞—Ç–∏ –≥–ª–æ–±–∞–ª—å–Ω–∏–π API
             TradingView.changeSymbol(`BINANCE:${newSymbol}`);
             console.log(`%cAttempted TradingView symbol change via global API to BINANCE:${newSymbol}`, "color: orange; font-weight: bold;");
        } else {
             console.warn("Cannot change TradingView symbol automatically: widget instance or setSymbol method not available. Manual page reload or re-creation of widget might be needed for symbol change.");
             // –Ø–∫—â–æ –≤—ñ–¥–∂–µ—Ç –≤–±—É–¥–æ–≤–∞–Ω–∏–π —á–µ—Ä–µ–∑ HTML, –º–æ–∂–µ –∑–Ω–∞–¥–æ–±–∏—Ç–∏—Å—è –π–æ–≥–æ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–ª—è –∑–º—ñ–Ω–∏ —Å–∏–º–≤–æ–ª—É.
             // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏, –º–∏ –Ω–µ –±—É–¥–µ–º–æ —Ü—å–æ–≥–æ —Ä–æ–±–∏—Ç–∏ —Ç—É—Ç.
             // –ú–æ–∂–Ω–∞ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–∫—Ä–∏–ø—Ç –≤—ñ–¥–∂–µ—Ç–∞, –∞–ª–µ —Ü–µ —Å–∫–ª–∞–¥–Ω—ñ—à–µ.
             const widgetContainer = document.getElementById(tradingViewWidgetTargetDivIdFromHTML);
             if (widgetContainer) {
                widgetContainer.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                new TradingView.widget({ // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –≤—ñ–¥–∂–µ—Ç
                    "container_id": tradingViewWidgetTargetDivIdFromHTML,
                    "autosize": true,
                    "symbol": `BINANCE:${newSymbol}`,
                    "interval": "D",
                    "timezone": "Etc/UTC",
                    "theme": "light",
                    "style": "1",
                    "locale": "en",
                    "allow_symbol_change": true,
                    "support_host": "https://www.tradingview.com"
                });
                console.log(`%cRe-created TradingView widget for symbol BINANCE:${newSymbol}`, "color: blue; font-weight: bold;");
             }
        }

        setTimeout(async () => {
            console.log(`Reconnecting WebSockets and fetching initial data for ${newSymbol}`);
            connectOrderBookWebSocket(newSymbol);
            connectTradesWebSocket(newSymbol);
            await fetchInitialDataForSymbol(newSymbol);
        }, 500);
    }

    function renderPairList(pairsToRender) {
        if (!pairListEl) return;
        pairListEl.innerHTML = '';
        if (!pairsToRender || pairsToRender.length === 0) {
            pairListEl.innerHTML = '<li style="text-align:center; padding: 10px; color: #707a8a;">No pairs found.</li>';
            return;
        }
        pairsToRender.slice(0, 100).forEach(pair => { // –û–±–º–µ–∂—É—î–º–æ –¥–æ 100 –¥–ª—è —à–≤–∏–¥–∫–æ–¥—ñ—ó
            const li = document.createElement('li');
            li.dataset.symbol = pair.symbol;
            const [base, quote] = splitSymbol(pair.symbol);
            const priceFormatted = formatPrice(pair.lastPrice, quote); // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ lastPrice –∑ ticker
            const changeFormatted = pair.priceChangePercent ? `${parseFloat(pair.priceChangePercent).toFixed(2)}%` : " ";
            const changeClass = pair.priceChangePercent ? (parseFloat(pair.priceChangePercent) >= 0 ? 'positive' : 'negative') : '';
            
            li.innerHTML = `
                <span class="pair-symbol-group"><span class="symbol-main">${base}</span><span class="symbol-quote">/${quote}</span></span>
                <span class="pair-last-price">${priceFormatted}</span>
                <span class="price-change ${changeClass}">${changeFormatted}</span>`;
            li.addEventListener('click', () => changeTradingPair(pair.symbol));
            pairListEl.appendChild(li);
        });
    }

    function filterAndRenderPairs() {
        if (pairSearchInputEl === null && categoryButtonsContainer === null) return; 

        const searchTerm = pairSearchInputEl ? pairSearchInputEl.value.toLowerCase().trim() : "";
        const activeCategoryButton = categoryButtonsContainer ? categoryButtonsContainer.querySelector('.category-btn.active') : null;
        const selectedQuote = (activeCategoryButton && activeCategoryButton.dataset.quote) ? activeCategoryButton.dataset.quote : "USDT"; // USDT –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º

        if (!allMarketPairsCache.length && searchTerm === "" && selectedQuote === "USDT") { // –ê–±–æ —ñ–Ω—à–∏–π –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π
             if(pairListEl) pairListEl.innerHTML = '<li style="text-align:center; padding:10px; color:#707a8a;">Loading pairs...</li>';
             return;
        }
        
        let filteredPairs = allMarketPairsCache;
        if (selectedQuote && selectedQuote !== "All") { // "All" - —è–∫—â–æ –±—É–¥–µ —Ç–∞–∫–∞ –∫–Ω–æ–ø–∫–∞
            filteredPairs = filteredPairs.filter(pair => pair.quoteAsset === selectedQuote);
        }
        if (searchTerm) {
            filteredPairs = filteredPairs.filter(pair => 
                pair.symbol.toLowerCase().includes(searchTerm) || 
                (pair.baseAsset && pair.baseAsset.toLowerCase().includes(searchTerm)) || 
                (pair.quoteAsset && pair.quoteAsset.toLowerCase().includes(searchTerm)) // –®—É–∫–∞—î–º–æ —ñ –≤ quoteAsset
            );
        }
        renderPairList(filteredPairs);
    }

    async function fetchAllMarketPairs() { 
        console.log("Fetching all market pairs for search...");
        if(pairListEl) pairListEl.innerHTML = '<li style="text-align:center; padding:10px; color:#707a8a;">Loading pairs...</li>';
        try {
            // –û—Ç—Ä–∏–º—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤—Å—ñ —Å–∏–º–≤–æ–ª–∏
            const response = await fetch('https://api.binance.com/api/v3/exchangeInfo');
            if (!response.ok) throw new Error(`Failed to fetch exchange info: ${response.status} ${response.statusText}`);
            const data = await response.json();
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ 24hr ticker –¥–ª—è —Ü—ñ–Ω —Ç–∞ –∑–º—ñ–Ω
            const tickerResponse = await fetch('https://api.binance.com/api/v3/ticker/24hr');
            if(!tickerResponse.ok) console.warn(`Could not fetch 24hr ticker data: ${tickerResponse.status}`);
            const tickerData = tickerResponse.ok ? await tickerResponse.json() : [];
            const tickerMap = new Map(tickerData.map(t => [t.symbol, t]));

            if (data.symbols) {
                allMarketPairsCache = data.symbols
                    .filter(s => s.status === 'TRADING' && s.isSpotTradingAllowed) // –¢—ñ–ª—å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ñ —Å–ø–æ—Ç –ø–∞—Ä–∏
                    .map(s => {
                        const ticker = tickerMap.get(s.symbol); // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π ticker
                        return {
                            symbol: s.symbol,
                            baseAsset: s.baseAsset,
                            quoteAsset: s.quoteAsset,
                            lastPrice: ticker ? ticker.lastPrice : null, // –ë–µ—Ä–µ–º–æ —Ü—ñ–Ω—É –∑ ticker
                            priceChangePercent: ticker ? ticker.priceChangePercent : null // –ë–µ—Ä–µ–º–æ –∑–º—ñ–Ω—É –∑ ticker
                        };
                    })
                    .sort((a,b) => a.symbol.localeCompare(b.symbol)); // –°–æ—Ä—Ç—É—î–º–æ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ
                console.log(`Loaded ${allMarketPairsCache.length} tradable spot pairs.`);
                filterAndRenderPairs(); // –û–¥—Ä–∞–∑—É —Ñ—ñ–ª—å—Ç—Ä—É—î–º–æ —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º USDT)
            } else {
                console.error("No symbols found in exchangeInfo response.");
                if(pairListEl) pairListEl.innerHTML = '<li style="text-align:center; padding:10px; color:#707a8a;">Failed to load pairs.</li>';
            }
        } catch (error) {
            console.error("Error fetching market pairs:", error);
            if(pairListEl) pairListEl.innerHTML = `<li style="text-align:center; padding:10px; color:red;">Error: ${error.message}</li>`;
        }
    }
    
    async function fetchInitialDataForSymbol(symbol) { 
        console.log(`Fetching initial data for ${symbol} via REST API...`);
        try {
            const [base, quote] = splitSymbol(symbol); // –î–ª—è –º–æ–∂–ª–∏–≤–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ –ª–æ–≥–∞—Ö –∞–±–æ UI
            // –ó–∞–ø–∏—Ç –¥–ª—è Order Book
            const depthResponse = await fetch(`https://api.binance.com/api/v3/depth?symbol=${symbol}&limit=50`); // limit=50 –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–ª—è –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
            if (!depthResponse.ok) {
                console.error(`Failed to fetch initial depth for ${symbol}: ${depthResponse.status} ${depthResponse.statusText}`);
            } else {
                const depthData = await depthResponse.json();
                if (depthData.bids && depthData.asks) { renderOrderBook(depthData.bids, depthData.asks); }
            }

            // –ó–∞–ø–∏—Ç –¥–ª—è –æ—Å—Ç–∞–Ω–Ω—ñ—Ö —É–≥–æ–¥
            const tradesResponse = await fetch(`https://api.binance.com/api/v3/trades?symbol=${symbol}&limit=${MAX_TRADES_HISTORY}`);
            if (!tradesResponse.ok) {
                 console.error(`Failed to fetch initial trades for ${symbol}: ${tradesResponse.status} ${tradesResponse.statusText}`);
            } else {
                const tradesData = await tradesResponse.json();
                if (marketTradesListEl) marketTradesListEl.innerHTML = ''; // –û—á–∏—â—É—î–º–æ —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º
                // Binance API –ø–æ–≤–µ—Ä—Ç–∞—î —É–≥–æ–¥–∏ –≤—ñ–¥ –Ω–∞–π—Å—Ç–∞—Ä—ñ—à–æ—ó –¥–æ –Ω–∞–π–Ω–æ–≤—ñ—à–æ—ó –≤ –º–∞—Å–∏–≤—ñ, —Ç–æ–º—É –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è "–Ω–∞–π–Ω–æ–≤—ñ—à—ñ –∑–≤–µ—Ä—Ö—É" —ó—Ö —Ç—Ä–µ–±–∞ –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∏ –∞–±–æ –¥–æ–¥–∞–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ prepend
                (tradesData || []).reverse().forEach(t => renderMarketTrade({ p: t.price, q: t.qty, T: t.time, m: !t.isBuyerMaker })); // isBuyerMaker: true = sell, false = buy. WebSocket `m` is true for maker (seller).
            }
        } catch (error) {
            console.error(`Error fetching initial data for ${symbol}:`, error);
        }
    }
    
    // --- –õ–û–ì–Ü–ö–ê –î–õ–Ø –í–ö–õ–ê–î–û–ö –ù–ê –ü–ê–ù–ï–õ–Ü –¢–û–†–ì–Ü–í–õ–Ü ---
    const orderTypeTabs = document.querySelectorAll('.order-type-tabs .type-tab');
    const executionTypeTabs = document.querySelectorAll('.execution-type-tabs .exec-tab');

    function setActiveTab(tabsNodeList, clickedTab) {
        tabsNodeList.forEach(tab => tab.classList.remove('active'));
        clickedTab.classList.add('active');
    }

    function updateTradingFormsUI(executionType) {
        const [baseAsset, quoteAsset] = splitSymbol(currentSymbol);
        [buyFormEl, sellFormEl].forEach(formEl => {
            if (!formEl) return; 
            const isBuySide = formEl.classList.contains('buy-form');
            
            const priceInput = formEl.querySelector(isBuySide ? '#buy-price' : '#sell-price');
            const marketPriceLabel = formEl.querySelector('.market-price-label'); // –ó–∞–≥–∞–ª—å–Ω–∏–π –∫–ª–∞—Å –¥–ª—è –æ–±–æ—Ö —Ñ–æ—Ä–º
            const priceCurrencySpan = formEl.querySelector(isBuySide ? '#buyPriceQuoteCurrency' : '#sellPriceQuoteCurrency');
            const amountLabel = formEl.querySelector(isBuySide ? '#buyAmountLabel' : '#sellAmountLabel');
            const amountInput = formEl.querySelector(isBuySide ? '#buy-amount' : '#sell-amount');
            const amountCurrencySpan = formEl.querySelector(isBuySide ? '#buyAmountCurrency' : '#sellAmountBaseCurrency'); // buyAmountCurrency –¥–ª—è Buy, sellAmountBaseCurrency –¥–ª—è Sell
            const totalInputGroup = formEl.querySelector('.total-input-group'); // –ó–∞–≥–∞–ª—å–Ω–∏–π –∫–ª–∞—Å
            
            formEl.dataset.orderExecutionType = executionType; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∏–ø –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

            if (executionType === 'market') {
                if(priceInput) { priceInput.style.display = 'none'; priceInput.disabled = true; priceInput.value = ''; }
                if(priceCurrencySpan) priceCurrencySpan.style.display = 'none';
                if(marketPriceLabel) marketPriceLabel.style.display = 'block'; // –ü–æ–∫–∞–∑—É—î–º–æ "–†–∏–Ω–∫–æ–≤–∞ —Ü—ñ–Ω–∞"
                
                if (isBuySide) { // –î–ª—è –∫—É–ø—ñ–≤–ª—ñ –∑–∞ —Ä–∏–Ω–∫–æ–º, –≤–≤–æ–¥–∏–º–æ —Å—É–º—É –≤ QUOTE –≤–∞–ª—é—Ç—ñ
                    if(amountLabel) amountLabel.textContent = '–í—Å—å–æ–≥–æ';
                    if(amountInput) amountInput.placeholder = "0.00"; // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è USDT
                    if(amountCurrencySpan) amountCurrencySpan.textContent = quoteAsset; // –í–∞–ª—é—Ç–∞ USDT
                    if (totalInputGroup) totalInputGroup.style.display = 'none'; // –•–æ–≤–∞—î–º–æ –ø–æ–ª–µ "–í—Å—å–æ–≥–æ"
                } else { // –î–ª—è –ø—Ä–æ–¥–∞–∂—É –∑–∞ —Ä–∏–Ω–∫–æ–º, –≤–≤–æ–¥–∏–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å BASE –≤–∞–ª—é—Ç–∏
                    if(amountLabel) amountLabel.textContent = '–°—É–º–∞';
                    if(amountInput) amountInput.placeholder = "0.0000"; // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è BTC
                    if(amountCurrencySpan) amountCurrencySpan.textContent = baseAsset; // –í–∞–ª—é—Ç–∞ BTC
                    if (totalInputGroup) totalInputGroup.style.display = 'none'; // –•–æ–≤–∞—î–º–æ –ø–æ–ª–µ "–í—Å—å–æ–≥–æ"
                }
            } else if (executionType === 'limit') { // –î–ª—è –ª—ñ–º—ñ—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
                if (priceInput) { priceInput.style.display = 'block'; priceInput.disabled = false; priceInput.placeholder = "0.00"; } // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–ª–µ —Ü—ñ–Ω–∏
                if (priceCurrencySpan) priceCurrencySpan.style.display = 'inline';
                if (marketPriceLabel) marketPriceLabel.style.display = 'none'; // –•–æ–≤–∞—î–º–æ "–†–∏–Ω–∫–æ–≤–∞ —Ü—ñ–Ω–∞"
                
                // –î–ª—è –ª—ñ–º—ñ—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ (—ñ –∫—É–ø—ñ–≤–ª—è, —ñ –ø—Ä–æ–¥–∞–∂) –≤–≤–æ–¥–∏–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å BASE –≤–∞–ª—é—Ç–∏
                if(amountLabel) amountLabel.textContent = '–°—É–º–∞';
                if(amountInput) amountInput.placeholder = "0.0000"; // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è BTC
                if(amountCurrencySpan) amountCurrencySpan.textContent = baseAsset; // –í–∞–ª—é—Ç–∞ BTC
                if (totalInputGroup) totalInputGroup.style.display = 'block'; // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–ª–µ "–í—Å—å–æ–≥–æ"
            }
            // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –¥–ª—è —ñ–Ω—à–∏—Ö —Ç–∏–ø—ñ–≤ –æ—Ä–¥–µ—Ä—ñ–≤ (stop-limit —Ç–æ—â–æ)
        });
    }

    orderTypeTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            setActiveTab(orderTypeTabs, e.currentTarget);
            // –ú–æ–∂–ª–∏–≤–æ, —è–∫–∞—Å—å –¥–æ–¥–∞—Ç–∫–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ç–∏–ø—É —Ç–æ—Ä–≥—ñ–≤–ª—ñ (–°–ø–æ—Ç/–ö—Ä–æ—Å/–Ü–∑–æ–ª—å–æ–≤–∞–Ω–∏–π)
        });
    });

    executionTypeTabs.forEach(tab => {
        if(!tab.classList.contains('dropdown-toggle')) { // –Ü–≥–Ω–æ—Ä—É—î–º–æ –∫–Ω–æ–ø–∫–∏, —â–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—é—Ç—å dropdown
            tab.addEventListener('click', (e) => {
                // –ó–Ω—ñ–º–∞—î–º–æ active –∑ —É—Å—ñ—Ö –∫–Ω–æ–ø–æ–∫ —Ç–∏–ø—ñ–≤ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (–∫—Ä—ñ–º dropdown-toggle)
                document.querySelectorAll('.execution-type-tabs .exec-tab:not(.dropdown-toggle).active')
                    .forEach(t => t.classList.remove('active'));
                e.currentTarget.classList.add('active'); // –†–æ–±–∏–º–æ –∞–∫—Ç–∏–≤–Ω–æ—é –Ω–∞—Ç–∏—Å–Ω—É—Ç—É
                const execType = e.currentTarget.dataset.exec;
                updateTradingFormsUI(execType);
            });
        }
    });
    
    function updateTradingFormCurrencies(base, quote) {
        // –§–æ—Ä–º–∞ –∫—É–ø—ñ–≤–ª—ñ
        if(buyPriceQuoteCurrencyEl) buyPriceQuoteCurrencyEl.textContent = quote;
        const currentBuyExecType = buyFormEl ? buyFormEl.dataset.orderExecutionType : 'limit';
        if(buyAmountLabelEl) {
            if(currentBuyExecType === 'limit') {
                buyAmountLabelEl.textContent = '–°—É–º–∞';
                if(buyAmountCurrencyEl) buyAmountCurrencyEl.textContent = base;
            } else if (currentBuyExecType === 'market') {
                buyAmountLabelEl.textContent = '–í—Å—å–æ–≥–æ';
                if(buyAmountCurrencyEl) buyAmountCurrencyEl.textContent = quote;
            }
        }
        const buyTotalQuoteCurrencyEl = buyFormEl ? buyFormEl.querySelector('#buyTotalQuoteCurrency') : null;
        if(buyTotalQuoteCurrencyEl) buyTotalQuoteCurrencyEl.textContent = quote;
        const buyButtonBaseSpan = buyButton ? buyButton.querySelector('#buyButtonBase') : null; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ ID span
        if (buyButtonBaseSpan) buyButtonBaseSpan.textContent = base;


        // –§–æ—Ä–º–∞ –ø—Ä–æ–¥–∞–∂—É
        if(sellPriceQuoteCurrencyEl) sellPriceQuoteCurrencyEl.textContent = quote;
        if(sellAmountLabelEl) sellAmountLabelEl.textContent = '–°—É–º–∞'; // –ó–∞–≤–∂–¥–∏ "–°—É–º–∞" –¥–ª—è –ø—Ä–æ–¥–∞–∂—É
        if(sellAmountBaseCurrencyEl) sellAmountBaseCurrencyEl.textContent = base;
        const sellTotalQuoteCurrencyEl = sellFormEl ? sellFormEl.querySelector('#sellTotalQuoteCurrency') : null;
        if(sellTotalQuoteCurrencyEl) sellTotalQuoteCurrencyEl.textContent = quote;
        const sellButtonBaseSpan = sellButton ? sellButton.querySelector('#sellButtonBase') : null; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ ID span
        if (sellButtonBaseSpan) sellButtonBaseSpan.textContent = base;
        
        // –û–Ω–æ–≤–ª—é—î–º–æ UI —Ñ–æ—Ä–º –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–∏–ø—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
        const activeExecTab = document.querySelector('.execution-type-tabs .exec-tab.active:not(.dropdown-toggle)');
        if (activeExecTab) {
            updateTradingFormsUI(activeExecTab.dataset.exec);
        } else {
            updateTradingFormsUI('limit'); // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º, —è–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –≤–∏–±—Ä–∞–Ω–æ
        }
    }
    
    // --- –û–ë–†–û–ë–ù–ò–ö–ò –ü–û–î–Ü–ô –î–õ–Ø –ö–ù–û–ü–û–ö –ö–£–ü–Ü–í–õ–Ü/–ü–†–û–î–ê–ñ–£ ---
    function isLoggedIn() {
        return !!localStorage.getItem('authToken'); 
    }

    function updateActionButtonsState() {
        const [baseAsset, ] = splitSymbol(currentSymbol);
        const authPrompt = document.querySelector('.auth-prompt');

        if (isLoggedIn()) {
            if (buyButton) buyButton.firstChild.textContent = `–ö—É–ø–∏—Ç–∏ `; 
            // buyButtonBase span –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤ updateTradingFormCurrencies
            
            if (sellButton) sellButton.firstChild.textContent = `–ü—Ä–æ–¥–∞—Ç–∏ `;
            // sellButtonBase span –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤ updateTradingFormCurrencies

            if (authPrompt) authPrompt.style.display = 'none';
            if (buyFormEl) buyFormEl.style.opacity = '1';
            if (sellFormEl) sellFormEl.style.opacity = '1';
            if (buyButton) buyButton.disabled = false;
            if (sellButton) sellButton.disabled = false;

        } else {
            if (buyButton) buyButton.firstChild.textContent = `–£–≤—ñ–π—Ç–∏, —â–æ–± –ö—É–ø–∏—Ç–∏ `;
            if (sellButton) sellButton.firstChild.textContent = `–£–≤—ñ–π—Ç–∏, —â–æ–± –ü—Ä–æ–¥–∞—Ç–∏ `;

            if (authPrompt) authPrompt.style.display = 'block';
            // –ú–æ–∂–Ω–∞ —Ç–∞–∫–æ–∂ –∑—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ä–º–∏ –Ω–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∏–º–∏ –∞–±–æ –∑–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ –ø–æ–ª—è
            if (buyFormEl) buyFormEl.style.opacity = '0.5';
            if (sellFormEl) sellFormEl.style.opacity = '0.5';
            // –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç–∏ –Ω–∞ –ª–æ–≥—ñ–Ω, —Ç–æ–º—É —ó—Ö –Ω–µ –±–ª–æ–∫—É—î–º–æ,
            // –∞–ª–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ —ó—Ö –ø–æ–≤–µ–¥—ñ–Ω–∫—É –∞–±–æ –≤–∏–≥–ª—è–¥
        }
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–∑–≤–∏ –≤–∞–ª—é—Ç–∏ –≤ –∫–Ω–æ–ø–∫–∞—Ö (–≤ span) —Ä–æ–±–∏—Ç—å—Å—è –≤ updateTradingFormCurrencies
        const buyButtonBase = document.getElementById('buyButtonBase');
        if (buyButtonBase) buyButtonBase.textContent = baseAsset;
        const sellButtonBase = document.getElementById('sellButtonBase');
        if (sellButtonBase) sellButtonBase.textContent = baseAsset;
    }

    if (buyButton) {
        buyButton.addEventListener('click', () => {
            if (isLoggedIn()) {
                // –¢—É—Ç –±—É–¥–µ –ª–æ–≥—ñ–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ—Ä–¥–µ—Ä–∞ –Ω–∞ –∫—É–ø—ñ–≤–ª—é
                alert(`–î—ñ—è "–ö—É–ø–∏—Ç–∏ ${currentSymbol}" (–¥–ª—è –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞).`);
            } else {
                window.location.href = 'login-page.html'; 
            }
        });
    }

    if (sellButton) {
        sellButton.addEventListener('click', () => {
            if (isLoggedIn()) {
                // –¢—É—Ç –±—É–¥–µ –ª–æ–≥—ñ–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ—Ä–¥–µ—Ä–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∂
                alert(`–î—ñ—è "–ü—Ä–æ–¥–∞—Ç–∏ ${currentSymbol}" (–¥–ª—è –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞).`);
            } else {
                window.location.href = 'login-page.html';
            }
        });
    }
    
    // --- –û–ë–†–û–ë–ù–ò–ö–ò –ü–û–î–Ü–ô –î–õ–Ø –ü–û–®–£–ö–£ –ü–ê–† ---
    if (pairSearchInputEl) pairSearchInputEl.addEventListener('input', filterAndRenderPairs);
    if (categoryButtonsContainer) {
        categoryButtonsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('category-btn')) {
                const currentlyActive = categoryButtonsContainer.querySelector('.category-btn.active');
                if (currentlyActive) currentlyActive.classList.remove('active');
                e.target.classList.add('active');
                filterAndRenderPairs();
            }
        });
    }

    // --- –ü–û–ß–ê–¢–ö–û–í–ï –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –°–¢–û–†–Ü–ù–ö–ò ---
    async function initializePage() {
        console.log("Initializing Spot Page (with HTML-embedded TradingView widget)...");
        const [base, quote] = splitSymbol(currentSymbol);
        updateSymbolDisplay(currentSymbol); 
        updateTradingFormCurrencies(base, quote); 
        updateTradingFormsUI('limit'); // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –õ—ñ–º—ñ—Ç —è–∫ —Ç–∏–ø –æ—Ä–¥–µ—Ä–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
        updateActionButtonsState(); // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫ —ñ —Ñ–æ—Ä–º
        
        await fetchAllMarketPairs(); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ –ø–∞—Ä –¥–ª—è –ø–æ—à—É–∫—É
        await fetchInitialDataForSymbol(currentSymbol); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ—ó –ø–∞—Ä–∏
        
        connectOrderBookWebSocket(currentSymbol);
        connectTradesWebSocket(currentSymbol);
        
        // –û—Ç—Ä–∏–º—É—î–º–æ –µ–∫–∑–µ–º–ø–ª—è—Ä –≤—ñ–¥–∂–µ—Ç–∞ TradingView, –∫–æ–ª–∏ –≤—ñ–Ω –±—É–¥–µ –≥–æ—Ç–æ–≤–∏–π
        getTradingViewWidgetInstanceWhenReady((widget) => {
            if (widget) {
                 console.log("TradingView widget instance is accessible for potential future interactions.", widget);
            } else {
                 console.log("TradingView widget seems initialized (iframe found), but direct instance was not obtained.");
            }
            console.log("Spot page fully initialized.");
        });
    }

    initializePage();
});
</script>

</body>
</html>
