<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>YuMa - –†–∏–Ω–∫–∏</title>
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/markets.css"> <!-- –í–∞—à —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏–π CSS –¥–ª—è —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ -->
    <style>
        /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ/—Ç–∏–º—á–∞—Å–æ–≤—ñ —Å—Ç–∏–ª—ñ */
        .market-page-layout { padding: 2rem; }
        .asset-selector-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            overflow-x: auto; /* –î–ª—è —Å–∫—Ä–æ–ª—É, —è–∫—â–æ –±–∞–≥–∞—Ç–æ –≤–∞–ª—é—Ç */
            padding-bottom: 1rem; /* –©–æ–± —Å–∫—Ä–æ–ª–±–∞—Ä –Ω–µ –Ω–∞–ª—ñ–∑–∞–≤ */
        }
        .asset-button {
            padding: 0.8rem 1.5rem;
            border: 1px solid #ccc;
            border-radius: 0.6rem;
            background-color: #f9f9f9;
            cursor: pointer;
            font-size: 1.4rem;
            white-space: nowrap;
        }
        .asset-button:hover, .asset-button.active {
            background-color: #e0e0e0;
            border-color: #bbb;
        }
        .popular-pairs-section, .filtered-pairs-section {
            margin-bottom: 3rem;
        }
        .section-title {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        /* –°—Ç–∏–ª—ñ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ —Ä–∏–Ω–∫—ñ–≤ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –ø—Ä–∏–∫–ª–∞–¥—ñ–≤ */
        .custom-table-wrapper { margin-top: 1rem; }
        .custom-table-header, .custom-table-row { display: flex; align-items: center; padding: 1rem 0.5rem; border-bottom: 1px solid #eee; }
        .custom-table-header { font-weight: bold; color: #555; font-size: 1.3rem; background-color: #f9f9f9;}
        .custom-table-header span, .custom-table-row span { flex: 1; padding: 0 0.8rem; text-align: left; white-space: nowrap; }
        .custom-table-row:last-child { border-bottom: none; }
        .custom-table-row:hover { background-color: #f5f5f5; }
        .custom-table-header span.col-fav, .custom-table-row span.col-fav { flex-basis: 6rem; flex-grow: 0; text-align: center;}
        .custom-table-header span.col-pair, .custom-table-row span.col-pair { flex-grow: 1.5; }
        .custom-table-header span.col-name, .custom-table-row span.col-name { flex-grow: 2; }
        .custom-table-header span.col-price, .custom-table-row span.col-price { flex-grow: 1.2; text-align: right;}
        .custom-table-header span.col-change, .custom-table-row span.col-change { flex-grow: 1; text-align: right;}
        .custom-table-header span.col-action, .custom-table-row span.col-action { flex-grow: 1; text-align: center;}

        .favourite-btn { cursor: pointer; font-size: 1.8rem; color: #ccc; border: none; background: none; padding: 0.2rem 0.5rem; }
        .favourite-btn.is-favourite { color: #ffc107; }
        .positive-change { color: green; }
        .negative-change { color: red; }
        .action-link { color: #007bff; text-decoration: none; font-size: 1.4rem; }
        .action-link:hover { text-decoration: underline; }
        .no-data-placeholder { text-align: center; padding: 2rem; color: #777; font-style: italic; }
    </style>
</head>
<body>
    <header>
        <div class="logo"><a href="../../index.html">YuMa</a></div>
        <nav class="header-nav">
            <a href="buy_crypto-page.html" class="nav-button">Buy Crypto</a>
            <a href="markets.html" class="nav-button active">Markets</a>
            <a href="trading-page.html" class="nav-button">Trade</a>
        </nav>
        <div class="header-actions">
            <button class="btn-deposit nav-button">Deposit</button>
            <div class="icon-placeholder dark-square"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder user-profile-icon"><a href="profile.html" title="Profile">üë§</a></div>
            <div class="icon-placeholder"></div>
            <button id="logoutButtonMarkets" class="nav-button" style="display: none;">Log out</button>
        </div>
    </header>

    <main class="market-page-layout">
        <nav class="asset-selector-bar" id="assetSelectorBar">
            <!-- –ö–Ω–æ–ø–∫–∏-–∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏ –¥–ª—è –≤–∏–±–æ—Ä—É –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ —Å—é–¥–∏ -->
            <div class="no-data-placeholder">Loading assets...</div>
        </nav>

        <section class="popular-pairs-section">
            <h2 class="section-title">Popular Pairs</h2>
            <div class="custom-table-wrapper" id="popularPairsTable">
                <div class="custom-table-header">
                    <span class="col-fav">Fav</span>
                    <span class="col-pair">Pair</span>
                    <span class="col-name">Name</span>
                    <span class="col-price">Last Price</span>
                    <span class="col-change">24h Change</span>
                    <span class="col-action">Action</span>
                </div>
                <div class="no-data-placeholder">Loading popular pairs...</div>
            </div>
        </section>

        <section class="filtered-pairs-section">
            <h2 class="section-title" id="filteredPairsTitle">All Markets</h2>
            <div class="custom-table-wrapper" id="filteredPairsTable">
                 <div class="custom-table-header">
                    <span class="col-fav">Fav</span>
                    <span class="col-pair">Pair</span>
                    <span class="col-name">Name</span>
                    <span class="col-price">Last Price</span>
                    <span class="col-change">24h Change</span>
                    <span class="col-action">Action</span>
                </div>
                <div class="no-data-placeholder">Select a base asset or view all markets.</div>
            </div>
        </section>
    </main>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('authToken');
    const assetSelectorBar = document.getElementById('assetSelectorBar');
    const popularPairsTable = document.getElementById('popularPairsTable');
    const filteredPairsTable = document.getElementById('filteredPairsTable');
    const filteredPairsTitle = document.getElementById('filteredPairsTitle');
    const logoutButton = document.getElementById('logoutButtonMarkets');

    if (token && logoutButton) {
        logoutButton.style.display = 'inline-block';
        logoutButton.addEventListener('click', () => { /* ... –ª–æ–≥—ñ–∫–∞ –≤–∏—Ö–æ–¥—É ... */ });
    }

    async function fetchProtectedData(url, options = {}) { /* ... –≤–∞—à–∞ —Ñ—É–Ω–∫—Ü—ñ—è fetchProtectedData ... */ }

    function renderMarketTable(containerElement, markets, title) {
        const header = containerElement.querySelector('.custom-table-header');
        containerElement.innerHTML = '';
        if (header) containerElement.appendChild(header);
        if (title && filteredPairsTitle && containerElement === filteredPairsTable) {
            filteredPairsTitle.textContent = title;
        }

        if (!markets || markets.length === 0) {
            containerElement.insertAdjacentHTML('beforeend', `<div class="no-data-placeholder">No markets found${title ? ' for ' + title.replace('Markets for ', '') : ''}.</div>`);
            return;
        }
        markets.forEach(market => {
            const row = document.createElement('div');
            row.classList.add('custom-table-row');
            const isFav = token ? market.isFavourite : false;
            const price = market.currentPrice ? `$${parseFloat(market.currentPrice).toFixed(2)}` : 'N/A';
            const change = market.change24hPercent ? parseFloat(market.change24hPercent).toFixed(2) + '%' : 'N/A';
            const changeClass = market.change24hPercent ? (parseFloat(market.change24hPercent) >= 0 ? 'positive-change' : 'negative-change') : '';

            row.innerHTML = `
                <span class="col-fav">
                    ${token ? `<button class="favourite-btn ${isFav ? 'is-favourite' : ''}" data-market-id="${market.id}" title="${isFav ? 'Remove' : 'Add'} Fav">${isFav ? '‚òÖ' : '‚òÜ'}</button>` : '‚òÜ'}
                </span>
                <span class="col-pair">${market.symbol}</span>
                <span class="col-name">${market.name || `${market.base_asset}/${market.quote_asset}`}</span>
                <span class="col-price">${price}</span>
                <span class="col-change ${changeClass}">${change}</span>
                <span class="col-action"><a href="trading-page.html?pair=${market.symbol.replace('/', '_')}" class="action-link">Trade</a></span>
            `;
            containerElement.appendChild(row);
        });
        if (token) {
            containerElement.querySelectorAll('.favourite-btn').forEach(button => {
                button.addEventListener('click', toggleFavourite);
            });
        }
    }

    async function toggleFavourite(event) {
    console.log('[ToggleFavourite] Button clicked. Event target:', event.currentTarget);
    const currentToken = localStorage.getItem('authToken'); // –ó–∞–≤–∂–¥–∏ –æ—Ç—Ä–∏–º—É—î–º–æ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Ç–æ–∫–µ–Ω

    if (!currentToken) {
        alert('Please log in to manage your favourites.');
        console.warn('[ToggleFavourite] No token, prompting login.');
        window.location.href = 'login-page.html'; // –ê–±–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —à–ª—è—Ö –¥–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –≤—Ö–æ–¥—É
        return;
    }

    const button = event.currentTarget;
    const marketIdString = button.dataset.marketId; // data-market-id –∑ HTML –µ–ª–µ–º–µ–Ω—Ç–∞
    
    if (!marketIdString) {
        console.error('[ToggleFavourite] Market ID is missing from button dataset.');
        alert('Could not identify the market. Please try again.');
        return;
    }
    const marketId = parseInt(marketIdString, 10);
    if (isNaN(marketId)) {
        console.error('[ToggleFavourite] Invalid Market ID:', marketIdString);
        alert('Invalid market identifier.');
        return;
    }

    const isCurrentlyFavourite = button.classList.contains('is-favourite');
    const method = isCurrentlyFavourite ? 'DELETE' : 'POST';
    const url = isCurrentlyFavourite ? `/api/favourites/${marketId}` : '/api/favourites';

    console.log(`[ToggleFavourite] Action for Market ID: ${marketId}. Currently Favourite: ${isCurrentlyFavourite}. Method: ${method}. URL: ${url}`);

    try {
        const fetchOptions = { 
            method: method, 
            requiresAuth: true // –¶–µ–π –∑–∞–ø–∏—Ç —Ç–æ—á–Ω–æ –≤–∏–º–∞–≥–∞—î –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
        };
        if (method === 'POST') {
            fetchOptions.body = JSON.stringify({ marketPairId: marketId });
        }

        const data = await fetchApiData(url, fetchOptions); // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–∞—à—É –æ–±–≥–æ—Ä—Ç–∫—É
        console.log('[ToggleFavourite] Response from server:', data);

        if (data.success) {
            console.log(`[ToggleFavourite] Successfully updated favourite status for Market ID: ${marketId}. New status: ${!isCurrentlyFavourite}`);
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –≤–∏–≥–ª—è–¥ –∫–Ω–æ–ø–∫–∏, –Ω–∞ —è–∫—É –∫–ª—ñ–∫–Ω—É–ª–∏
            button.classList.toggle('is-favourite');
            button.innerHTML = button.classList.contains('is-favourite') ? '‚òÖ' : '‚òÜ';
            button.title = button.classList.contains('is-favourite') ? 'Remove from Favourites' : 'Add to Favourites';
            
            // –û–Ω–æ–≤–ª—é—î–º–æ isFavourite –≤ –∫–µ—à—ñ allMarketsDataCache, —è–∫—â–æ –≤—ñ–Ω –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
            // —ñ —è–∫—â–æ —Ü–µ–π –µ–ª–µ–º–µ–Ω—Ç —î –≤ –∫–µ—à—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ markets.html)
            if (typeof allMarketsDataCache !== 'undefined' && Array.isArray(allMarketsDataCache)) {
                const marketInCache = allMarketsDataCache.find(m => m.id === marketId); // –ü–æ—Ä—ñ–≤–Ω—é—î–º–æ —á–∏—Å–ª–∞
                if (marketInCache) {
                    marketInCache.isFavourite = !isCurrentlyFavourite;
                    console.log(`[ToggleFavourite] Updated 'isFavourite' in allMarketsDataCache for marketId ${marketId} to ${marketInCache.isFavourite}`);
                } else {
                    console.warn(`[ToggleFavourite] MarketId ${marketId} not found in allMarketsDataCache to update.`);
                }
            } else {
                 console.warn(`[ToggleFavourite] allMarketsDataCache is not defined or not an array. Skipping cache update.`);
            }


            // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—É –∫–Ω–æ–ø–∫—É –≤ –Ü–ù–®–Ü–ô —Ç–∞–±–ª–∏—Ü—ñ, —è–∫—â–æ –≤–æ–Ω–∞ —Ç–∞–º —î
            // –¶–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ, —è–∫—â–æ —É –≤–∞—Å —î —Ç–∞–±–ª–∏—Ü—è "Popular Pairs" —Ç–∞ "All Markets/Filtered" –Ω–∞ –æ–¥–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
            let otherTableContainer = null;
            if (button.closest('#popularPairsTable')) {
                otherTableContainer = document.getElementById('filteredPairsTable');
            } else if (button.closest('#filteredPairsTable')) {
                otherTableContainer = document.getElementById('popularPairsTable');
            } else if (button.closest('#favouriteMarketsTable')) { // –î–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ profile.html
                // –Ø–∫—â–æ –º–∏ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –ø—Ä–æ—Ñ—ñ–ª—é —ñ –≤–∏–¥–∞–ª—è—î–º–æ –∑ —É–ª—é–±–ª–µ–Ω–∏—Ö, —Ç–æ –ø—Ä–æ—Å—Ç–æ –≤–∏–¥–∞–ª—è—î–º–æ —Ä—è–¥–æ–∫
                if (isCurrentlyFavourite) { // –¢–æ–±—Ç–æ, —è–∫—â–æ –º–∏ —â–æ–π–Ω–æ –≤–∏–¥–∞–ª–∏–ª–∏
                    button.closest('.custom-table-row').remove();
                     // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –Ω–µ –∑–∞–ª–∏—à–∏–ª–æ—Å—è –∂–æ–¥–Ω–æ–≥–æ —É–ª—é–±–ª–µ–Ω–æ–≥–æ
                    const favTable = document.getElementById('favouriteMarketsTable');
                    if (favTable && favTable.querySelectorAll('.custom-table-row').length === 0) {
                        const header = favTable.querySelector('.custom-table-header');
                        favTable.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ –≤—Å–µ
                        if(header) favTable.appendChild(header);
                        favTable.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">You have no favourite markets yet. <a href="markets.html">Add some</a>!</div>');
                    }
                    return; // –ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ —à—É–∫–∞—Ç–∏ –∫–Ω–æ–ø–∫—É –≤ —ñ–Ω—à—ñ–π —Ç–∞–±–ª–∏—Ü—ñ
                }
            }


            if (otherTableContainer) {
                const correspondingButton = otherTableContainer.querySelector(`.favourite-btn[data-market-id="${marketId}"]`);
                if (correspondingButton) {
                    const newIsFavouriteStatus = !isCurrentlyFavourite;
                    correspondingButton.classList.toggle('is-favourite', newIsFavouriteStatus);
                    correspondingButton.innerHTML = newIsFavouriteStatus ? '‚òÖ' : '‚òÜ';
                    correspondingButton.title = newIsFavouriteStatus ? 'Remove from Favourites' : 'Add to Favourites';
                    console.log(`[ToggleFavourite] Updated corresponding button in other table for Market ID: ${marketId}`);
                }
            }

        } else {
            // data.message –º–∞—î –±—É—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ñ—É–Ω–∫—Ü—ñ—î—é fetchApiData
            alert(data.message || 'Failed to update favourites. Server returned an error.');
            console.error('[ToggleFavourite] Server failed to update favourites:', data.message);
        }
    } catch (error) { // –¶–µ–π catch —Å–ø—Ä–∞—Ü—é—î –¥–ª—è –ø–æ–º–∏–ª–æ–∫, —è–∫—ñ –ø–æ–≤–µ—Ä–Ω—É–ª–∞ fetchApiData —è–∫ –≤—ñ–¥—Ö–∏–ª–µ–Ω–∏–π Promise
        console.error('[ToggleFavourite] Error in toggleFavourite (from fetchApiData reject or other critical error):', error);
        alert(error.message || 'An unexpected error occurred while updating favourites.');
    }
}    
    async function loadBaseAssets() {
        try {
            const data = await fetchProtectedData('/api/assets/base', {requiresAuth: !!token});
            if (data.success && data.baseAssets) {
                assetSelectorBar.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
                const allMarketsButton = document.createElement('button');
                allMarketsButton.classList.add('asset-button', 'active'); // "All" –∞–∫—Ç–∏–≤–Ω–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                allMarketsButton.textContent = 'All';
                allMarketsButton.addEventListener('click', () => {
                    document.querySelectorAll('.asset-button.active').forEach(b => b.classList.remove('active'));
                    allMarketsButton.classList.add('active');
                    loadFilteredMarkets(null); // null –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö
                });
                assetSelectorBar.appendChild(allMarketsButton);

                data.baseAssets.forEach(asset => {
                    const button = document.createElement('button');
                    button.classList.add('asset-button');
                    button.textContent = asset;
                    button.dataset.asset = asset;
                    button.addEventListener('click', () => {
                        document.querySelectorAll('.asset-button.active').forEach(b => b.classList.remove('active'));
                        button.classList.add('active');
                        loadFilteredMarkets(asset);
                    });
                    assetSelectorBar.appendChild(button);
                });
            }
        } catch (error) {
            console.error('Error loading base assets:', error);
            assetSelectorBar.innerHTML = '<div class="no-data-placeholder">Failed to load assets.</div>';
        }
    }

    async function loadPopularPairs() {
        try {
            const data = await fetchProtectedData('/api/markets?popularOnly=true', {requiresAuth: !!token});
            if (data.success && data.markets) {
                renderMarketTable(popularPairsTable, data.markets);
            }
        } catch (error) {
            console.error('Error loading popular pairs:', error);
            popularPairsTable.querySelector('.no-data-placeholder').textContent = 'Error loading popular pairs.';
        }
    }

    async function loadFilteredMarkets(baseAsset = null) {
        let url = '/api/markets';
        if (baseAsset) {
            url += `?baseAsset=${baseAsset}`;
        }
        const title = baseAsset ? `Markets for ${baseAsset}` : 'All Markets';
        if (filteredPairsTable.querySelector('.no-data-placeholder')) {
           filteredPairsTable.querySelector('.no-data-placeholder').textContent = `Loading ${title.toLowerCase()}...`;
        } else {
            const header = filteredPairsTable.querySelector('.custom-table-header');
            filteredPairsTable.innerHTML = '';
            if (header) filteredPairsTable.appendChild(header);
            filteredPairsTable.insertAdjacentHTML('beforeend', `<div class="no-data-placeholder">Loading ${title.toLowerCase()}...</div>`);
        }


        try {
            const data = await fetchProtectedData(url, {requiresAuth: !!token});
            if (data.success && data.markets) {
                renderMarketTable(filteredPairsTable, data.markets, title);
            }
        } catch (error) {
            console.error(`Error loading markets for ${baseAsset || 'all'}:`, error);
             if (filteredPairsTable.querySelector('.no-data-placeholder')) {
                filteredPairsTable.querySelector('.no-data-placeholder').textContent = `Error loading ${title.toLowerCase()}.`;
             }
        }
    }

    // –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    loadBaseAssets();
    loadPopularPairs();
    loadFilteredMarkets(); // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ —Ä–∏–Ω–∫–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º

});
</script>
</body>
</html>