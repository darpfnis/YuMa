<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>YuMa - Spot Trading</title>
    <!-- –í–ò–ü–†–ê–í–õ–ï–ù–û –®–õ–Ø–•–ò –î–û CSS -->
    <link rel="stylesheet" href="../css/header.css"> <!-- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π header.css -->
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/markets.css"> <!-- –Ø–∫—â–æ —Ç—É—Ç —Å—Ç–∏–ª—ñ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ —Ä–∏–Ω–∫—ñ–≤ -->
    <!-- <link rel="stylesheet" href="../css/spot-page.css"> -- –Ø–∫—â–æ —î —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏–π CSS –¥–ª—è —Å–ø–æ—Ç—É -->
    <style>
        /* –¢–∏–º—á–∞—Å–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ñ–≤ —ñ–∫–æ–Ω–æ–∫ —Ç–∞ –∫–Ω–æ–ø–∫–∏ —É–ª—é–±–ª–µ–Ω–æ–≥–æ */
        .header-actions .icon-placeholder, .spot-header .spot-icon-link span {
            display: inline-block;
            width: 28px; /* –¢—Ä–æ—Ö–∏ –º–µ–Ω—à–µ, –Ω—ñ–∂ —É profile.html */
            height: 28px;
            border: 1px solid #777; /* –°–≤—ñ—Ç–ª—ñ—à–∞ —Ä–∞–º–∫–∞ –Ω–∞ —Ç–µ–º–Ω–æ–º—É —Ñ–æ–Ω—ñ */
            background-color: #555; /* –¢–µ–º–Ω—ñ—à–∏–π —Ñ–æ–Ω –¥–ª—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ */
            border-radius: 4px;
            margin-left: 8px;
            color: white; /* –î–ª—è —Ç–µ–∫—Å—Ç—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ, —è–∫—â–æ –±—É–¥–µ */
            text-align: center;
            line-height: 28px; /* –î–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É/—ñ–∫–æ–Ω–∫–∏ */
            text-decoration: none;
        }
        .header-actions .user-profile-icon a, .spot-header .spot-icon-link a {
            display: block;
            width: 100%;
            height: 100%;
            text-decoration: none;
            color: white; /* –ö–æ–ª—ñ—Ä —ñ–∫–æ–Ω–∫–∏/—Ç–µ–∫—Å—Ç—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ */
        }

        .favourite-btn {
            cursor: pointer;
            font-size: 1.8rem;
            color: #ccc; /* –ù–µ–∞–∫—Ç–∏–≤–Ω–∞ */
            border: none;
            background: none;
            padding: 0.2rem 0.5rem;
        }
        .favourite-btn.is-favourite {
            color: #ffc107; /* –ê–∫—Ç–∏–≤–Ω–∞ (–∂–æ–≤—Ç–∞) */
        }
        .positive-change { color: green; }
        .negative-change { color: red; }
        .coin-symbol-small { color: #777; font-size: 0.85em; margin-left: 0.3em; }

        /* –°—Ç–∏–ª—ñ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ —Ä–∏–Ω–∫—ñ–≤, —Å—Ö–æ–∂—ñ –Ω–∞ —Ç—ñ, —â–æ –≤ profile.html */
        .markets-list-full {
            background-color: #fff; /* –°–≤—ñ—Ç–ª–∏–π —Ñ–æ–Ω –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç—É */
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            color: #333; /* –¢–µ–º–Ω–∏–π —Ç–µ–∫—Å—Ç –Ω–∞ —Å–≤—ñ—Ç–ª–æ–º—É —Ñ–æ–Ω—ñ */
        }
        .custom-table-wrapper {
            margin-top: 15px;
        }
        .custom-table-header, .custom-table-row {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid #eee;
        }
        .custom-table-header {
            font-weight: bold;
            color: #555;
            font-size: 1.4rem; /* –ê–¥–∞–ø—Ç—É—î–º–æ —Ä–æ–∑–º—ñ—Ä */
            background-color: #f9f9f9;
        }
        .custom-table-header span, .custom-table-row span {
            flex: 1;
            padding: 0 8px;
            text-align: left;
            white-space: nowrap;
        }
        .custom-table-header span:first-child, .custom-table-row span:first-child { flex-basis: 60px; flex-grow: 0; text-align: center;} /* –î–ª—è –∫–Ω–æ–ø–∫–∏ Favourite */
        .custom-table-header span:nth-child(2), .custom-table-row span:nth-child(2) { flex-grow: 2;} /* –î–ª—è Pair */


        .custom-table-row:hover { background-color: #f5f5f5; }
        .no-data-placeholder { text-align: center; padding: 20px; color: #777; font-style: italic;}
        .action-link { color: #007bff; text-decoration: none; font-size: 1.4rem; }
        .action-link:hover { text-decoration: underline; }
        .main-display-card { /* –ó–∞–º—ñ—Å—Ç—å —Ü—å–æ–≥–æ –±—É–¥–µ —Ç–∞–±–ª–∏—Ü—è */
            display: none;
        }
    </style>
</head>
<body>

    <header> <!-- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ö–µ–¥–µ—Ä–∞ –∑ profile.html –¥–ª—è —É–∑–≥–æ–¥–∂–µ–Ω–æ—Å—Ç—ñ -->
        <div class="logo"><a href="../../index.html">YuMa</a></div>
        <nav class="header-nav">
            <a href="buy_crypto-page.html" class="nav-button">Buy Crypto</a>
            <a href="markets.html" class="nav-button">Markets</a>
            <!-- –î–æ–¥–∞–º–æ —Å–ø–∞–¥–Ω—ñ –º–µ–Ω—é, —è–∫ –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ -->
             <div class="dropdown-container">
                <a href="#" class="nav-link dropdown-toggle nav-button">Trade</a> <!-- –î–æ–¥–∞–≤ –∫–ª–∞—Å nav-button -->
                <div class="dropdown-content trade-dropdown">
                    <a href="spot-page.html">Spot</a>
                    <a href="#">Margin</a>
                </div>
            </div>
            <div class="dropdown-container">
                <a href="#" class="nav-link dropdown-toggle nav-button">Futures</a> <!-- –î–æ–¥–∞–≤ –∫–ª–∞—Å nav-button -->
                <div class="dropdown-content futures-dropdown">
                    <a href="futures-page.html">USD‚ìà-M Futures</a>
                    <a href="#">COIN-M Futures</a>
                </div>
            </div>
        </nav>
        <div class="header-actions">
            <button class="btn-deposit nav-button">Deposit</button>
            <div class="icon-placeholder dark-square"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder"></div>
            <!-- –ó–∞–º—ñ–Ω—é—î–º–æ –æ–¥–∏–Ω –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –Ω–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ø—Ä–æ—Ñ—ñ–ª—å -->
            <div class="icon-placeholder user-profile-icon">
                <a href="profile.html" title="Profile">üë§</a> <!-- –Ü–∫–æ–Ω–∫–∞ –∞–±–æ —Ç–µ–∫—Å—Ç –ø—Ä–æ—Ñ—ñ–ª—é -->
            </div>
            <div class="icon-placeholder"></div>
            <button id="logoutButtonSpot" class="nav-button" style="display: none;">Log out</button>
        </div>
    </header>

    <main class="spot-main-content" style="max-width: 1200px; margin: 20px auto; padding: 0 20px;">
        <section class="content-header">
            <h2>Spot Markets</h2>
            <input type="text" id="searchSpotMarkets" placeholder="Search Pair..." class="search-input" style="max-width: 300px;">
        </section>

        <section class="markets-list-full">
            <div class="custom-table-wrapper" id="spotMarketsTable">
                <div class="custom-table-header">
                    <span>Fav</span>
                    <span>Pair</span>
                    <span>Name</span>
                    <span>Last Price</span>
                    <span>24h Change</span>
                    <span>Action</span>
                </div>
                <div class="no-data-placeholder">Loading markets...</div>
                <!-- –†—è–¥–∫–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
            </div>
        </section>
    </main>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    console.log('[SpotPage] DOMContentLoaded. Script loaded.');
    const token = localStorage.getItem('authToken');
    const spotMarketsTable = document.getElementById('spotMarketsTable');
    const logoutButton = document.getElementById('logoutButtonSpot');
    const searchInput = document.getElementById('searchSpotMarkets');
    let allSpotMarkets = []; // –î–ª—è –∫–µ—à—É–≤–∞–Ω–Ω—è —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ –≤–∏—Ö–æ–¥—É
    if (!token) {
        // –î–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —Ä–∏–Ω–∫—ñ–≤ –º–æ–∂–Ω–∞ –Ω–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç–∏, –∞ –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏—Ö
        // –∞–±–æ –ø–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è "Log in to add favourites"
        console.warn('[SpotPage] No token found. Favourite functionality will be limited.');
        if(logoutButton) logoutButton.style.display = 'none';
    } else {
        if(logoutButton) logoutButton.style.display = 'inline-block';
        logoutButton.addEventListener('click', async () => {
            localStorage.removeItem('authToken');
            try {
                await fetch('/auth/logout', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }});
            } catch(e) { console.error('Logout API error', e); }
            window.location.href = 'login-page.html'; // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ –ª–æ–≥—ñ–Ω
        });
    }

    async function fetchProtectedData(url, options = {}) {
        const currentToken = localStorage.getItem('authToken');
        // –Ø–∫—â–æ –∑–∞–ø–∏—Ç –Ω–µ –≤–∏–º–∞–≥–∞—î —Ç–æ–∫–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–∞–≥–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ —Ä–∏–Ω–∫—ñ–≤),
        // –º–æ–∂–Ω–∞ –Ω–µ –¥–æ–¥–∞–≤–∞—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization, –∞–±–æ —Å–µ—Ä–≤–µ—Ä –º–∞—î —Ü–µ –æ–±—Ä–æ–±–ª—è—Ç–∏.
        // –î–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è/–≤–∏–¥–∞–ª–µ–Ω–Ω—è —É–ª—é–±–ª–µ–Ω–∏—Ö —Ç–æ–∫–µ–Ω –ø–æ—Ç—Ä—ñ–±–µ–Ω.
        const headers = { 'Content-Type': 'application/json' };
        if (currentToken && options.requiresAuth) { // –î–æ–¥–∞—î–º–æ –Ω–æ–≤–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä requiresAuth
            headers['Authorization'] = `Bearer ${currentToken}`;
        }

        const fetchOptions = { ...options, headers: { ...headers, ...options.headers } };
        const response = await fetch(url, fetchOptions);

        if (!response.ok) {
            if ((response.status === 401 || response.status === 403) && options.requiresAuth) {
                localStorage.removeItem('authToken');
                window.location.href = 'login-page.html';
                return Promise.reject(new Error('Unauthorized or Forbidden.'));
            }
            const errorData = await response.json().catch(() => ({ message: `HTTP error! Status: ${response.status}` }));
            return Promise.reject(errorData);
        }
        return response.json();
    }

    function renderSpotMarkets(markets) {
        const header = spotMarketsTable.querySelector('.custom-table-header');
        spotMarketsTable.innerHTML = '';
        if (header) spotMarketsTable.appendChild(header);

        if (!markets || markets.length === 0) {
            spotMarketsTable.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">No markets available.</div>');
            return;
        }

        markets.forEach(market => {
            const row = document.createElement('div');
            row.classList.add('custom-table-row');
            row.dataset.marketId = market.id;

            const isFav = token ? market.isFavourite : false; // –ö–Ω–æ–ø–∫–∞ —É–ª—é–±–ª–µ–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–∞ —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏—Ö

            const price = market.currentPrice ? `$${parseFloat(market.currentPrice).toFixed(2)}` : 'N/A';
            const change = market.change24hPercent ? parseFloat(market.change24hPercent).toFixed(2) + '%' : 'N/A';
            const changeClass = market.change24hPercent ? (parseFloat(market.change24hPercent) >= 0 ? 'positive-change' : 'negative-change') : '';

            row.innerHTML = `
                <span>
                    ${token ? `<button class="favourite-btn ${isFav ? 'is-favourite' : ''}" data-market-id="${market.id}" title="${isFav ? 'Remove from Favourites' : 'Add to Favourites'}">${isFav ? '‚òÖ' : '‚òÜ'}</button>` : '‚òÜ'}
                </span>
                <span class="coin-name">${market.symbol}</span>
                <span>${market.name || `${market.base_asset}/${market.quote_asset}`}</span>
                <span>${price}</span>
                <span class="${changeClass}">${change}</span>
                <span><a href="trading-page.html?pair=${market.symbol.replace('/', '_')}" class="action-link">Trade</a></span>
            `;
            spotMarketsTable.appendChild(row);
        });

        if (token) { // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π
            document.querySelectorAll('.favourite-btn').forEach(button => {
                button.addEventListener('click', toggleFavourite);
            });
        }
    }

    async function toggleFavourite(event) {
        if (!token) { // –ü–æ–¥–≤—ñ–π–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
            alert('Please log in to manage your favourites.');
            window.location.href = 'login-page.html';
            return;
        }
        const button = event.currentTarget;
        const marketId = button.dataset.marketId;
        const isCurrentlyFavourite = button.classList.contains('is-favourite');
        const method = isCurrentlyFavourite ? 'DELETE' : 'POST';
        const url = isCurrentlyFavourite ? `/api/favourites/${marketId}` : '/api/favourites';

        try {
            const fetchOptions = { method: method, requiresAuth: true }; // –í–∫–∞–∑—É—î–º–æ, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è
            if (method === 'POST') {
                fetchOptions.body = JSON.stringify({ marketPairId: parseInt(marketId) });
            }
            const data = await fetchProtectedData(url, fetchOptions);

            if (data.success) {
                button.classList.toggle('is-favourite');
                button.innerHTML = button.classList.contains('is-favourite') ? '‚òÖ' : '‚òÜ';
                button.title = button.classList.contains('is-favourite') ? 'Remove from Favourites' : 'Add to Favourites';
                console.log(data.message);
            } else {
                alert(data.message || 'Failed to update favourites.');
            }
        } catch (error) {
            console.error('Error toggling favourite:', error);
            alert(error.message || 'An error occurred. Please try again.');
        }
    }
    
    function filterAndRenderSpotMarkets() {
        const searchTerm = searchInput.value.toLowerCase();
        const filtered = allSpotMarkets.filter(market => 
            market.symbol.toLowerCase().includes(searchTerm) || 
            (market.name && market.name.toLowerCase().includes(searchTerm)) ||
            market.base_asset.toLowerCase().includes(searchTerm) ||
            market.quote_asset.toLowerCase().includes(searchTerm)
        );
        renderSpotMarkets(filtered);
    }

    async function loadAllSpotMarkets() {
        console.log('[SpotPage] Attempting to load all spot markets data...');
        const placeholder = spotMarketsTable.querySelector('.no-data-placeholder');
        try {
            // –î–ª—è /api/markets –ø–µ—Ä–µ–¥–∞—î–º–æ requiresAuth: true, —è–∫—â–æ –≤—ñ–Ω –∑–∞—Ö–∏—â–µ–Ω–∏–π
            // –Ø–∫—â–æ —Ü–µ–π –µ–Ω–¥–ø–æ—ñ–Ω—Ç –ø—É–±–ª—ñ—á–Ω–∏–π, —Ç–æ requiresAuth: false –∞–±–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏
            const data = await fetchProtectedData('/api/markets', { requiresAuth: !!token });
            if (placeholder) placeholder.remove();

            if (data.success && data.markets) {
                allSpotMarkets = data.markets;
                filterAndRenderSpotMarkets();
                console.log('[SpotPage] Spot markets data rendered.');
            } else {
                 if (placeholder) placeholder.textContent = data.message || 'Could not load markets.';
                console.error('[SpotPage] Failed to load markets:', data.message);
            }
        } catch (error) {
            console.error('[SpotPage] Error loading spot markets:', error);
            if (placeholder) placeholder.textContent = 'Error loading markets. Please try again.';
        }
    }
    
    if(searchInput) searchInput.addEventListener('input', filterAndRenderSpotMarkets);

    loadAllSpotMarkets();
});
</script>
</body>
</html>