<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - YuMa</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/header.css"> <!-- –Ø–∫—â–æ —É –≤–∞—Å —î –æ–∫—Ä–µ–º–∏–π —Ñ–∞–π–ª –¥–ª—è —Ö–µ–¥–µ—Ä–∞ -->
    <link rel="stylesheet" href="../css/global.css"> <!-- –ó–∞–≥–∞–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ -->
    <!-- <link rel="stylesheet" href="../css/profile.css"> -- –Ø–∫—â–æ —î —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ -->
    <style>
        /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —ñ–∫–æ–Ω–∫–∏ —É–ª—é–±–ª–µ–Ω–æ–≥–æ —Ç–∞ –∑–º—ñ–Ω —Ü—ñ–Ω–∏ (–º–æ–∂–Ω–∞ –≤–∏–Ω–µ—Å—Ç–∏ –≤ CSS) */
        .favourite-btn, .remove-favourite-btn {
            cursor: pointer;
            font-size: 1.8rem;
            color: #ccc; /* –ù–µ–∞–∫—Ç–∏–≤–Ω–∞ */
            border: none;
            background: none;
            padding: 0.2rem 0.5rem;
        }
        .favourite-btn.is-favourite, .remove-favourite-btn.is-favourite {
            color: #ffc107; /* –ê–∫—Ç–∏–≤–Ω–∞ (–∂–æ–≤—Ç–∞) */
        }
        .positive-change {
            color: green;
        }
        .negative-change {
            color: red;
        }
        .coin-symbol-small {
            color: #777;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo"><a href="../../index.html">YuMa</a></div>
        <nav class="header-nav">
            <a href="buy_crypto-page.html" class="nav-button">Buy Crypto</a>
            <a href="markets.html" class="nav-button">Markets</a>
            <a href="trading-page.html" class="nav-button">Trade</a>
        </nav>
        <div class="header-actions">
            <button class="btn-deposit nav-button">Deposit</button>
            <div class="icon-placeholder dark-square"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder user-profile-icon"><a href="profile.html" title="Profile" style="text-decoration:none; color:inherit;">üë§</a></div>
            <button id="logoutButton" class="nav-button" style="display: none;">Log out</button>
        </div>
    </header>

    <div class="page-wrapper-profile">
        <aside class="sidebar">
            <nav>
                <a href="profile.html" class="sidebar-button active">dashboard</a>
                <a href="assets.html" class="sidebar-button">assets</a>
                <a href="order.html" class="sidebar-button">order</a>
                <a href="account.html" class="sidebar-button">account</a>
                <a href="settings.html" class="sidebar-button">settings</a>
            </nav>
        </aside>

        <main class="main-content-profile">
            <section class="user-info-header">
                <div class="user-avatar-placeholder" id="userAvatar">picture</div>
                <div class="user-details">
                    <h2 id="userName">Loading...</h2>
                    <span class="uid-placeholder" id="userUID">UID: Loading...</span>
                </div>
            </section>

            <section class="dashboard-cards">
                <div class="profile-card card-balance">
                    <p>Estimated Balance</p>
                    <h3 id="estimatedBalance">$0.00 USD</h3>
                </div>
                <div class="profile-card card-chart">
                    <p>Portfolio Chart</p>
                    <div id="portfolioChartPlaceholder" style="width:100%; height:150px; background:#f0f0f0; display:flex; align-items:center; justify-content:center;">Chart Area</div>
                </div>
            </section>

            <section class="markets-section">
                <h3>My Favourite Markets</h3>
                <div class="market-filters">
                    <!-- –§—ñ–ª—å—Ç—Ä–∏ –º–æ–∂–Ω–∞ –∑–∞–ª–∏—à–∏—Ç–∏, —è–∫—â–æ –≤–æ–Ω–∏ –±—É–¥—É—Ç—å –∑–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞—Ç–∏—Å—è –¥–æ —É–ª—é–±–ª–µ–Ω–∏—Ö, –∞–±–æ –ø—Ä–∏–±—Ä–∞—Ç–∏ -->
                    <button class="filter-button active" data-filter="favourite">Favourite</button>
                    <!-- <button class="filter-button" data-filter="holding">Holding</button> -->
                </div>
                <div class="custom-table-wrapper" id="favouriteMarketsTable">
                    <div class="custom-table-header">
                        <span>Coin</span>
                        <span>Last Price</span>
                        <span>24h Change</span>
                        <span>Action</span>
                    </div>
                    <div class="no-data-placeholder">Loading favourite markets...</div>
                    <!-- –†—è–¥–∫–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </div>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('authToken');
    const userNameElement = document.getElementById('userName');
    const userUIDElement = document.getElementById('userUID');
    const estimatedBalanceElement = document.getElementById('estimatedBalance');
    const favouriteMarketsTable = document.getElementById('favouriteMarketsTable');
    const logoutButton = document.getElementById('logoutButton');

    if (!token) {
        window.location.href = 'login-page.html'; // –®–ª—è—Ö –¥–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –≤—Ö–æ–¥—É
        return;
    }

    if (logoutButton) {
        logoutButton.style.display = 'inline-block';
        logoutButton.addEventListener('click', async () => {
            // –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ: –ø–æ–≤—ñ–¥–æ–º–∏—Ç–∏ —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ –≤–∏—Ö—ñ–¥
            try {
                await fetch('/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (error) {
                console.error('Error during logout API call:', error);
            }
            localStorage.removeItem('authToken');
            localStorage.removeItem('userEmailForMVP'); // –Ø–∫—â–æ –≤–∏ —â–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏ —Ü–µ
            window.location.href = 'login-page.html'; // –®–ª—è—Ö –¥–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –≤—Ö–æ–¥—É
        });
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø–∏—Ç—ñ–≤ –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
    async function fetchProtectedData(url) {
        const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) {
            if (response.status === 401 || response.status === 403) { // –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π –∞–±–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ
                localStorage.removeItem('authToken');
                window.location.href = 'login-page.html';
                return Promise.reject(new Error('Unauthorized or Forbidden'));
            }
            const errorData = await response.json().catch(() => ({ message: `HTTP error! status: ${response.status}` }));
            return Promise.reject(errorData);
        }
        return response.json();
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–æ—Ñ—ñ–ª—é
    async function loadProfileData() {
        try {
            const data = await fetchProtectedData('/api/profile');
            if (data.success && data.profile) {
                if (userNameElement) userNameElement.textContent = data.profile.username || data.profile.email.split('@')[0];
                if (userUIDElement) userUIDElement.textContent = `UID: ${data.profile.uid || 'N/A'}`;
            } else {
                console.error('Failed to load profile data:', data.message);
            }
        } catch (error) {
            console.error('Error fetching profile data:', error.message || error);
        }
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É
    async function loadBalance() {
        try {
            const data = await fetchProtectedData('/api/balance');
            if (data.success) {
                if (estimatedBalanceElement) estimatedBalanceElement.textContent = `$${parseFloat(data.balance).toFixed(2)} USD`;
            } else {
                console.error('Failed to load balance:', data.message);
                if (estimatedBalanceElement) estimatedBalanceElement.textContent = '$ N/A';
            }
        } catch (error) {
            console.error('Error fetching balance:', error.message || error);
            if (estimatedBalanceElement) estimatedBalanceElement.textContent = '$ Error';
        }
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É–ª—é–±–ª–µ–Ω–∏—Ö —Ä–∏–Ω–∫—ñ–≤
    async function loadAndRenderFavouriteMarkets() {
        if (!favouriteMarketsTable) return;

        const header = favouriteMarketsTable.querySelector('.custom-table-header');
        favouriteMarketsTable.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ –≤—Å–µ
        if (header) favouriteMarketsTable.appendChild(header); // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫

        try {
            const data = await fetchProtectedData('/api/markets/favourites');
            if (data.success && data.markets) {
                if (data.markets.length === 0) {
                    favouriteMarketsTable.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">You have no favourite markets yet. <a href="markets.html">Add some</a>!</div>');
                    return;
                }
                data.markets.forEach(market => {
                    const row = document.createElement('div');
                    row.classList.add('custom-table-row');
                    const price = market.currentPrice ? `$${parseFloat(market.currentPrice).toFixed(2)}` : 'N/A';
                    const change = market.change24hPercent ? parseFloat(market.change24hPercent).toFixed(2) + '%' : 'N/A';
                    const changeClass = market.change24hPercent ? (parseFloat(market.change24hPercent) >= 0 ? 'positive-change' : 'negative-change') : '';

                    row.innerHTML = `
                        <span class="coin-name">${market.symbol.split('/')[0]} <span class="coin-symbol-small">(${market.symbol.replace('/', '')})</span></span>
                        <span>${price}</span>
                        <span class="${changeClass}">${change}</span>
                        <span>
                            <a href="trading-page.html?pair=${market.symbol.replace('/', '_')}" class="action-link">Trade</a>
                            <button class="remove-favourite-btn is-favourite" data-market-id="${market.id}" title="Remove from Favourites">‚òÖ</button>
                        </span>
                    `;
                    favouriteMarketsTable.appendChild(row);
                });

                document.querySelectorAll('.remove-favourite-btn').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const marketId = event.currentTarget.dataset.marketId;
                        if (!confirm('Are you sure you want to remove this market from favourites?')) return;
                        try {
                            const deleteResponse = await fetch(`/api/favourites/${marketId}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            const deleteData = await deleteResponse.json();
                            if (deleteResponse.ok && deleteData.success) {
                                event.currentTarget.closest('.custom-table-row').remove();
                                // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –Ω–µ –∑–∞–ª–∏—à–∏–ª–æ—Å—è –∂–æ–¥–Ω–æ–≥–æ —É–ª—é–±–ª–µ–Ω–æ–≥–æ
                                if (favouriteMarketsTable.querySelectorAll('.custom-table-row').length === 0) {
                                     favouriteMarketsTable.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">You have no favourite markets yet. <a href="markets.html">Add some</a>!</div>');
                                }
                            } else {
                                alert(deleteData.message || 'Failed to remove favourite.');
                            }
                        } catch (err) {
                            console.error('Error removing favourite:', err);
                            alert('Error removing favourite.');
                        }
                    });
                });

            } else {
                favouriteMarketsTable.insertAdjacentHTML('beforeend', `<div class="no-data-placeholder">${data.message || 'Could not load favourite markets.'}</div>`);
            }
        } catch (error) {
            console.error('Error fetching favourite markets:', error.message || error);
            favouriteMarketsTable.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">Error loading favourite markets. Please try again.</div>');
        }
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ –¥–∞–Ω—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    loadProfileData();
    loadBalance();
    loadAndRenderFavouriteMarkets();
});
</script>
</body>
</html>