<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - YuMa</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/global.css">
    <!-- <link rel="stylesheet" href="../css/profile.css"> -- –Ø–∫—â–æ —î —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Å—Ç–∏–ª—ñ -->
    <style>
        /* –°—Ç–∏–ª—ñ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ –Ω–∞ –¥–∞—à–±–æ—Ä–¥—ñ, —è–∫ —É –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ */
        .user-avatar-placeholder {
            width: 80px; height: 80px; border-radius: 50%;
            background-color: #e9ecef; margin-right: 20px;
            background-size: cover; background-position: center;
            border: 3px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            color: #6c757d; font-size: 1.3rem; overflow: hidden;
        }
        /* –Ü–Ω—à—ñ —Å—Ç–∏–ª—ñ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –¥–ª—è —É–ª—é–±–ª–µ–Ω–∏—Ö, –∑–º—ñ–Ω —Ü—ñ–Ω–∏ —Ç–æ—â–æ */
        .favourite-btn, .remove-favourite-btn { cursor: pointer; font-size: 1.8rem; color: #ccc; border: none; background: none; padding: 0.2rem 0.5rem; }
        .favourite-btn.is-favourite, .remove-favourite-btn.is-favourite { color: #ffc107; }
        .positive-change { color: green; }
        .negative-change { color: red; }
        .coin-symbol-small { color: #777; font-size: 0.85em; margin-left: 0.3em; }
        .no-data-placeholder a { color: #007bff; text-decoration: underline; }
    </style>
</head>
<body>
    <header>
        <div class="logo"><a href="../../index.html">YuMa</a></div>
        <nav class="header-nav">
            <a href="buy_crypto-page.html" class="nav-button">Buy Crypto</a>
            <a href="markets.html" class="nav-button">Markets</a>
            <a href="trading-page.html" class="nav-button">Trade</a>
        </nav>
        <div class="header-actions">
            <button class="btn-deposit nav-button" onclick="window.location.href='deposit.html'">Deposit</button>
            <div class="icon-placeholder dark-square"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder user-profile-icon"><a href="profile.html" title="Profile" style="text-decoration:none; color:inherit;">üë§</a></div>
            <div class="icon-placeholder"></div>
            <button id="logoutButtonProfile" class="nav-button" style="display: none;">Log out</button>
        </div>
    </header>

    <div class="page-wrapper-profile">
        <aside class="sidebar">
            <nav>
                <a href="profile.html" class="sidebar-button active">dashboard</a>
                <a href="assets.html" class="sidebar-button">assets</a>
                <a href="order.html" class="sidebar-button">order</a>
                <a href="account.html" class="sidebar-button">account</a>
                <a href="settings.html" class="sidebar-button">settings</a>
            </nav>
        </aside>

        <main class="main-content-profile">
            <section class="user-info-header">
                <div class="user-avatar-placeholder" id="userDashboardAvatar">No Pic</div>
                <div class="user-details">
                    <h2 id="userName">Loading...</h2>
                    <span class="uid-placeholder" id="userUID">UID: Loading...</span>
                </div>
            </section>

            <section class="dashboard-cards">
                <div class="profile-card card-balance">
                    <p>Estimated Balance</p>
                    <h3 id="estimatedBalance">$0.00</h3>
                </div>
                <div class="profile-card card-chart">
                    <p>Portfolio Chart</p>
                    <div id="portfolioChartPlaceholder" style="width:100%; height:150px; background:#f0f0f0; display:flex; align-items:center; justify-content:center;">Chart Area</div>
                </div>
            </section>

            <section class="markets-section">
                <h3>My Favourite Markets</h3>
                <div class="market-filters">
                    <button class="filter-button active" data-filter="favourite">Favourite</button>
                </div>
                <div class="custom-table-wrapper" id="favouriteMarketsTable">
                    <div class="custom-table-header">
                        <span>Coin</span>
                        <span>Last Price</span>
                        <span>24h Change</span>
                        <span>Action</span>
                    </div>
                    <div class="no-data-placeholder">Loading favourite markets...</div>
                </div>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    console.log('[ProfilePage] DOMContentLoaded. Script loaded.');
    const token = localStorage.getItem('authToken');

    const userNameElement = document.getElementById('userName');
    const userUIDElement = document.getElementById('userUID');
    const userDashboardAvatarElement = document.getElementById('userDashboardAvatar');
    const estimatedBalanceElement = document.getElementById('estimatedBalance');
    const favouriteMarketsTable = document.getElementById('favouriteMarketsTable');
    const logoutButton = document.getElementById('logoutButtonProfile'); // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤–∏—Ö–æ–¥—É –Ω–∞ —Ü—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ

    if (!token) {
        console.warn('[ProfilePage] No token. Redirecting to login.');
        window.location.href = 'login-page.html';
        return;
    }

    if (logoutButton) {
        logoutButton.style.display = 'inline-block';
        logoutButton.addEventListener('click', async () => {
            const currentToken = localStorage.getItem('authToken');
            localStorage.removeItem('authToken');
            try {
                await fetch('/auth/logout', { method: 'POST', headers: { 'Authorization': `Bearer ${currentToken}` }});
            } catch(e) { console.error('Logout API error', e); }
            window.location.href = 'login-page.html';
        });
    }

    async function fetchApiData(url, options = {}) {
        const currentToken = localStorage.getItem('authToken');
        const requiresAuth = options.requiresAuth !== undefined ? options.requiresAuth : true;
        if (requiresAuth && !currentToken) {
             window.location.href = 'login-page.html';
             return Promise.resolve({ success: false, message: 'Auth token missing, redirecting.', shouldRedirect: true });
        }
        const headers = { 'Content-Type': 'application/json' };
        if (requiresAuth && currentToken) {
            headers['Authorization'] = `Bearer ${currentToken}`;
        }
        const fetchOptions = { ...options, headers: { ...headers, ...options.headers } };
        try {
            const response = await fetch(url, fetchOptions);
            if (!response.ok) {
                if ((response.status === 401 || response.status === 403) && requiresAuth) {
                    localStorage.removeItem('authToken');
                    window.location.href = 'login-page.html';
                    return Promise.resolve({ success: false, message: `Auth error for ${url}. Redirecting.`, shouldRedirect: true });
                }
                try {
                    const errorData = await response.json();
                    return { success: false, ...errorData };
                } catch (jsonError) {
                    const errorText = await response.text();
                    return { success: false, message: `Server error: ${response.status}. Resp: ${errorText.substring(0,100)}`};
                }
            }
            return response.json();
        } catch (error) {
             console.error(`[fetchApiData] Network or other critical error for ${url}:`, error);
             if (error.message && error.message.toLowerCase().includes("failed to fetch")) {
                alert(`Network error: Could not connect to server for ${url}.`);
             }
             return { success: false, message: error.message || `Network error.`, isFetchError: true };
        }
    }

    async function loadProfileData() {
        console.log('[ProfilePage] Attempting to load profile data from /api/profile...');
        try {
            const data = await fetchApiData('/api/profile', { requiresAuth: true });
            console.log('[ProfilePage] Profile data from server:', data); // –õ–æ–≥—É—î–º–æ –æ—Ç—Ä–∏–º–∞–Ω—ñ –¥–∞–Ω—ñ

            if (data && data.success && data.profile) {
                const profile = data.profile;
                if (userNameElement) userNameElement.textContent = profile.username || profile.email.split('@')[0] || 'User';
                if (userUIDElement) userUIDElement.textContent = `UID: ${profile.uid || 'N/A'}`;
                
                if (userDashboardAvatarElement) {
                    if (profile.avatar_url) {
                        userDashboardAvatarElement.style.backgroundImage = `url('${profile.avatar_url}')`;
                        userDashboardAvatarElement.textContent = '';
                    } else {
                        userDashboardAvatarElement.style.backgroundImage = 'none';
                        userDashboardAvatarElement.textContent = 'No Pic';
                    }
                }
                console.log('[ProfilePage] Profile data rendered.');
            } else {
                const errorMsg = data ? data.message : 'Failed to load profile data (undefined response or success:false).';
                console.error('[ProfilePage] Error loading profile data:', errorMsg);
                if (userNameElement) userNameElement.textContent = 'Error (profile)';
                if (userUIDElement) userUIDElement.textContent = 'UID: Error';
                if (userDashboardAvatarElement) userDashboardAvatarElement.textContent = 'Error';
            }
        } catch (error) {
            console.error('[ProfilePage] Critical error in loadProfileData:', error);
            if (userNameElement && (!error.shouldRedirect)) userNameElement.textContent = 'Error (profile)';
            if (userUIDElement && (!error.shouldRedirect)) userUIDElement.textContent = 'UID: Error';
            if (userDashboardAvatarElement && (!error.shouldRedirect)) userDashboardAvatarElement.textContent = 'Error';
        }
    }

    async function loadBalance() {
        console.log('[ProfilePage] Attempting to load balance data...');
        try {
            const data = await fetchApiData('/api/balance', { requiresAuth: true });
            console.log('[ProfilePage] Balance data from server:', data); // –õ–æ–≥—É—î–º–æ –æ—Ç—Ä–∏–º–∞–Ω—ñ –¥–∞–Ω—ñ

            if (data && data.success && data.balance !== undefined) {
                if (estimatedBalanceElement) estimatedBalanceElement.textContent = `$${parseFloat(data.balance).toFixed(2)}`;
                console.log('[ProfilePage] Balance data rendered.');
            } else {
                const errorMsg = data ? data.message : 'Failed to load balance data (undefined response or success:false).';
                console.error('[ProfilePage] Error loading balance:', errorMsg);
                if (estimatedBalanceElement) estimatedBalanceElement.textContent = '$ Error';
            }
        } catch (error) {
            console.error('[ProfilePage] Critical error in loadBalance:', error);
            if (estimatedBalanceElement && (!error.shouldRedirect)) estimatedBalanceElement.textContent = '$ Error';
        }
    }
    
    async function loadAndRenderFavouriteMarkets() {
        if (!favouriteMarketsTable) return;
        console.log('[ProfilePage] Loading favourite markets...');
        let placeholder = favouriteMarketsTable.querySelector('.no-data-placeholder');
        if (placeholder) placeholder.textContent = 'Loading favourite markets...';
        else favouriteMarketsTable.insertAdjacentHTML('afterbegin', '<div class="no-data-placeholder">Loading favourite markets...</div>');
        
        const header = favouriteMarketsTable.querySelector('.custom-table-header');
        const currentRows = favouriteMarketsTable.querySelectorAll('.custom-table-row');
        currentRows.forEach(row => row.remove());

        try {
            const data = await fetchApiData('/api/markets/favourites', { requiresAuth: true });
            console.log('[ProfilePage] Favourite markets data from server:', data);
            placeholder = favouriteMarketsTable.querySelector('.no-data-placeholder'); // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –∑–Ω–æ–≤—É
            if (placeholder) placeholder.remove();

            if (data && data.success && data.markets) {
                if (data.markets.length === 0) {
                    favouriteMarketsTable.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">No favourite markets yet. <a href="markets.html">Add some</a>!</div>');
                    return;
                }
                data.markets.forEach(market => { /* ... –∫–æ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É —Ä—è–¥–∫—ñ–≤ —è–∫ —Ä–∞–Ω—ñ—à–µ, –∑ –∫–Ω–æ–ø–∫–æ—é –≤–∏–¥–∞–ª–µ–Ω–Ω—è ... */ });
                // –î–æ–¥–∞–π—Ç–µ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–∏–¥–∞–ª–µ–Ω–Ω—è, —è–∫ —É –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó profile.html
                document.querySelectorAll('.remove-favourite-btn').forEach(button => {
                    button.addEventListener('click', async (event) => { /* ... –ª–æ–≥—ñ–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è ... */ });
                });
            } else {
                const errorMsg = data ? data.message : 'Could not load favourite markets.';
                favouriteMarketsTable.insertAdjacentHTML('beforeend', `<div class="no-data-placeholder">${errorMsg}</div>`);
            }
        } catch (error) {
            console.error('[ProfilePage] Error loading favourite markets:', error);
            placeholder = favouriteMarketsTable.querySelector('.no-data-placeholder');
            if (placeholder) placeholder.textContent = 'Error loading favourite markets.';
            else favouriteMarketsTable.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">Error loading favourite markets.</div>');
        }
    }

    // –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
    if (token) {
        await loadProfileData();
        await loadBalance();
        await loadAndRenderFavouriteMarkets(); // –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ü—è —Ñ—É–Ω–∫—Ü—ñ—è –ø–æ–≤–Ω—ñ—Å—Ç—é —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞
    }
    console.log('[ProfilePage] Initial data load sequence finished.');
});
</script>
</body>
</html>
