<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - YuMa</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/global.css">
    <!-- <link rel="stylesheet" href="../css/profile.css"> -- –Ø–∫—â–æ —î —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Å—Ç–∏–ª—ñ -->
    <style>
        .favourite-btn, .remove-favourite-btn {
            cursor: pointer; font-size: 1.8rem; color: #ccc;
            border: none; background: none; padding: 0.2rem 0.5rem;
        }
        .favourite-btn.is-favourite, .remove-favourite-btn.is-favourite { color: #ffc107; }
        .positive-change { color: green; }
        .negative-change { color: red; }
        .coin-symbol-small { color: #777; font-size: 0.85em; margin-left: 0.3em; }
        .no-data-placeholder a { color: #007bff; text-decoration: underline; }
    </style>
</head>
<body>
    <header>
        <div class="logo"><a href="../../index.html">YuMa</a></div>
        <nav class="header-nav">
            <a href="buy_crypto-page.html" class="nav-button">Buy Crypto</a>
            <a href="markets.html" class="nav-button">Markets</a>
            <a href="trading-page.html" class="nav-button">Trade</a>
        </nav>
        <div class="header-actions">
            <button class="btn-deposit nav-button">Deposit</button>
            <div class="icon-placeholder dark-square"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder user-profile-icon"><a href="profile.html" title="Profile" style="text-decoration:none; color:inherit;">üë§</a></div>
            <button id="logoutButton" class="nav-button" style="display: none;">Log out</button>
        </div>
    </header>

    <div class="page-wrapper-profile">
        <aside class="sidebar">
            <nav>
                <a href="profile.html" class="sidebar-button active">dashboard</a>
                <a href="assets.html" class="sidebar-button">assets</a>
                <a href="order.html" class="sidebar-button">order</a>
                <a href="account.html" class="sidebar-button">account</a>
                <a href="settings.html" class="sidebar-button">settings</a>
            </nav>
        </aside>

        <main class="main-content-profile">
            <section class="user-info-header">
                <div class="user-avatar-placeholder" id="userAvatar">picture</div>
                <div class="user-details">
                    <h2 id="userName">Loading...</h2>
                    <span class="uid-placeholder" id="userUID">UID: Loading...</span>
                </div>
            </section>

            <section class="dashboard-cards">
                <div class="profile-card card-balance">
                    <p>Estimated Balance</p>
                    <h3 id="estimatedBalance">$0.00 USD</h3>
                </div>
                <div class="profile-card card-chart">
                    <p>Portfolio Chart</p>
                    <div id="portfolioChartPlaceholder" style="width:100%; height:150px; background:#f0f0f0; display:flex; align-items:center; justify-content:center;">Chart Area</div>
                </div>
            </section>

            <section class="markets-section">
                <h3>My Favourite Markets</h3>
                <div class="market-filters">
                    <button class="filter-button active" data-filter="favourite">Favourite</button>
                </div>
                <div class="custom-table-wrapper" id="favouriteMarketsTable">
                    <div class="custom-table-header">
                        <span>Coin</span>
                        <span>Last Price</span>
                        <span>24h Change</span>
                        <span>Action</span>
                    </div>
                    <div class="no-data-placeholder">Loading favourite markets...</div>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[ProfilePage] DOMContentLoaded. Script loaded.');
        
            const token = localStorage.getItem('authToken');
            console.log('[ProfilePage] Token from localStorage on page load:', token ? token.substring(0,30) + '...' : 'NO TOKEN');
        
            const userNameElement = document.getElementById('userName');
            const userUIDElement = document.getElementById('userUID');
            const estimatedBalanceElement = document.getElementById('estimatedBalance');
            const favouriteMarketsTable = document.getElementById('favouriteMarketsTable');
            const logoutButton = document.getElementById('logoutButton');
        
            if (!token) {
                console.warn('[ProfilePage] No token found in localStorage. Redirecting to login page.');
                window.location.href = 'login-page.html';
                return;
            }
        
            console.log('[ProfilePage] Token found. Proceeding to setup page and fetch data.');
        
            if (logoutButton) {
                logoutButton.style.display = 'inline-block';
                logoutButton.addEventListener('click', async () => {
                    console.log('[ProfilePage] Logout button clicked.');
                    const currentTokenForLogout = localStorage.getItem('authToken');
                    localStorage.removeItem('authToken');
                    console.log('[ProfilePage] authToken removed from localStorage.');
                    try {
                        const logoutResponse = await fetch('/auth/logout', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${currentTokenForLogout}` }
                        });
                        const logoutData = await logoutResponse.json();
                        console.log('[ProfilePage] Logout API response:', logoutData);
                    } catch (error) {
                        console.error('[ProfilePage] Error during logout API call:', error);
                    }
                    window.location.href = 'login-page.html';
                });
            } else {
                console.warn('[ProfilePage] Logout button element not found.');
            }
        
            async function fetchProtectedData(url, options = {}) {
                const currentToken = localStorage.getItem('authToken');
                console.log(`[fetchProtectedData] Attempting to fetch ${url}. Token being used:`, currentToken ? currentToken.substring(0,20)+'...' : 'NO TOKEN AT FETCH TIME');
        
                if (!currentToken) {
                    console.error(`[fetchProtectedData] CRITICAL: No token available for protected request to ${url}. Redirecting to login.`);
                    window.location.href = 'login-page.html';
                    return Promise.reject(new Error('No token, redirecting.'));
                }
        
                const defaultHeaders = {
                    'Authorization': `Bearer ${currentToken}`,
                    'Content-Type': 'application/json'
                };
                const fetchOptions = { ...options, headers: { ...defaultHeaders, ...options.headers } };
                console.log(`[fetchProtectedData] Fetching ${url} with options:`, fetchOptions);
        
                try {
                    const response = await fetch(url, fetchOptions);
                    console.log(`[fetchProtectedData] Response status for ${url}: ${response.status}`);
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            console.error(`[fetchProtectedData] Unauthorized (401) or Forbidden (403) for ${url}. Removing token and redirecting.`);
                            localStorage.removeItem('authToken');
                            window.location.href = 'login-page.html';
                            return Promise.reject(new Error(`Unauthorized or Forbidden for ${url}, token removed.`));
                        }
                        const errorData = await response.json().catch(() => ({ message: `HTTP error! Status: ${response.status} for ${url}. Response not JSON.` }));
                        console.error(`[fetchProtectedData] Error data for ${url}:`, errorData);
                        return Promise.reject(errorData);
                    }
                    const responseData = await response.json();
                    console.log(`[fetchProtectedData] Successfully fetched and parsed JSON for ${url}:`, responseData);
                    return responseData;
                } catch (error) {
                     console.error(`[fetchProtectedData] Network or other error for ${url}:`, error);
                     // –Ø–∫—â–æ —Ü–µ –ø–æ–º–∏–ª–∫–∞ —Ç–∏–ø—É "Failed to fetch", —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ –º–µ—Ä–µ–∂–µ–≤–∞ –ø—Ä–æ–±–ª–µ–º–∞ –∞–±–æ CORS,
                     // –∞–±–æ —Å–µ—Ä–≤–µ—Ä –≤–∑–∞–≥–∞–ª—ñ –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–≤, –∞–±–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–µ —î –≤–∞–ª—ñ–¥–Ω–∏–º HTTP.
                     if (error.message === "Failed to fetch") {
                        alert(`Network error: Could not connect to the server to fetch ${url}. Please check your connection or contact support.`);
                     }
                     return Promise.reject(error);
                }
            }
        
            async function loadProfileData() {
                console.log('[ProfilePage] Attempting to load profile data...');
                try {
                    const data = await fetchProtectedData('/api/profile');
                    if (data.success && data.profile) {
                        if (userNameElement) userNameElement.textContent = data.profile.username || data.profile.email.split('@')[0];
                        if (userUIDElement) userUIDElement.textContent = `UID: ${data.profile.uid || 'N/A'}`;
                        console.log('[ProfilePage] Profile data rendered.');
                    } else {
                        console.error('[ProfilePage] Failed to load profile data from server:', data.message || 'No success field in response');
                        if (userNameElement) userNameElement.textContent = 'Error loading profile';
                    }
                } catch (error) {
                    console.error('[ProfilePage] Error in loadProfileData catcher:', error.message || error);
                    if (userNameElement) userNameElement.textContent = 'Error (profile)';
                }
            }
        
            async function loadBalance() {
                // ... (—Å—Ö–æ–∂–∞ –ª–æ–≥—ñ–∫–∞ –∑ console.log –¥–ª—è /api/balance) ...
                 console.log('[ProfilePage] Attempting to load balance data...');
                try {
                    const data = await fetchProtectedData('/api/balance');
                    if (data.success) {
                        if (estimatedBalanceElement) estimatedBalanceElement.textContent = `$${parseFloat(data.balance).toFixed(2)} USD`;
                        console.log('[ProfilePage] Balance data rendered.');
                    } else {
                        console.error('[ProfilePage] Failed to load balance from server:', data.message);
                        if (estimatedBalanceElement) estimatedBalanceElement.textContent = '$ N/A';
                    }
                } catch (error) {
                    console.error('[ProfilePage] Error in loadBalance catcher:', error.message || error);
                    if (estimatedBalanceElement) estimatedBalanceElement.textContent = '$ Error';
                }
            }
        
            async function loadAndRenderFavouriteMarkets() {
                // ... (—Å—Ö–æ–∂–∞ –ª–æ–≥—ñ–∫–∞ –∑ console.log –¥–ª—è /api/markets/favourites —Ç–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–∏–¥–∞–ª–µ–Ω–Ω—è) ...
                if (!favouriteMarketsTable) { console.warn('[ProfilePage] Favourite markets table element not found.'); return; }
                console.log('[ProfilePage] Attempting to load favourite markets data...');
                // ... (—Ä–µ—à—Ç–∞ –≤–∞—à–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó loadAndRenderFavouriteMarkets –∑ –¥–æ–¥–∞–Ω–∏–º–∏ console.log —É –≤–∞–∂–ª–∏–≤–∏—Ö –º—ñ—Å—Ü—è—Ö) ...
                // –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –ø–µ—Ä–µ–¥ fetch, –ø—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è data, –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É, –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ.
            }
        
            console.log('[ProfilePage] Starting initial data load sequence.');
            await loadProfileData();
            await loadBalance();
            await loadAndRenderFavouriteMarkets();
            console.log('[ProfilePage] Initial data load sequence finished.');
        });
        </script>
</body>
</html>