<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - YuMa</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/global.css">
    <style>
        /* ... (–≤–∞—à—ñ —Å—Ç–∏–ª—ñ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è —Ç—É—Ç) ... */
        .favourite-btn, .remove-favourite-btn {
            cursor: pointer; font-size: 1.8rem; color: #ccc;
            border: none; background: none; padding: 0.2rem 0.5rem;
        }
        .favourite-btn.is-favourite, .remove-favourite-btn.is-favourite { color: #ffc107; }
        .positive-change { color: green; }
        .negative-change { color: red; }
        .coin-symbol-small { color: #777; font-size: 0.85em; margin-left: 0.3em; }
        .no-data-placeholder a { color: #007bff; text-decoration: underline; }

        /* –°—Ç–∏–ª—å –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ –Ω–∞ –¥–∞—à–±–æ—Ä–¥—ñ */
        .user-avatar-placeholder {
            width: 80px; /* –¢—Ä–æ—Ö–∏ –±—ñ–ª—å—à–µ –¥–ª—è –¥–∞—à–±–æ—Ä–¥—É */
            height: 80px;
            border-radius: 50%; /* –ö—Ä—É–≥–ª–∏–π */
            background-color: #e9ecef;
            margin-right: 20px; /* –í—ñ–¥—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ */
            background-size: cover;
            background-position: center;
            border: 3px solid #fff; /* –ë—ñ–ª–∞ —Ä–∞–º–∫–∞ */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.3rem;
            overflow: hidden; /* –©–æ–± –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–µ –≤–∏–ª–∞–∑–∏–ª–æ –∑–∞ –º–µ–∂—ñ */
        }
        .user-avatar-placeholder img { /* –Ø–∫—â–æ –±—É–¥–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ <img> –∑–∞–º—ñ—Å—Ç—å background-image */
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo"><a href="../../index.html">YuMa</a></div>
        <nav class="header-nav">
            <a href="buy_crypto-page.html" class="nav-button">Buy Crypto</a>
            <a href="markets.html" class="nav-button">Markets</a>
            <a href="trading-page.html" class="nav-button">Trade</a>
        </nav>
        <div class="header-actions">
            <button class="btn-deposit nav-button">Deposit</button>
            <div class="icon-placeholder dark-square"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder user-profile-icon"><a href="profile.html" title="Profile" style="text-decoration:none; color:inherit;">üë§</a></div>
            <button id="logoutButton" class="nav-button" style="display: none;">Log out</button>
        </div>
    </header>

    <div class="page-wrapper-profile">
        <aside class="sidebar">
            <nav>
                <a href="profile.html" class="sidebar-button active">dashboard</a>
                <a href="assets.html" class="sidebar-button">assets</a>
                <a href="order.html" class="sidebar-button">order</a>
                <a href="account.html" class="sidebar-button">account</a>
                <a href="settings.html" class="sidebar-button">settings</a>
            </nav>
        </aside>

        <main class="main-content-profile">
            <section class="user-info-header">
                <!-- –ó–º—ñ–Ω–µ–Ω–æ userAvatarPlaceholder –Ω–∞ div –∑ id userDashboardAvatar -->
                <div class="user-avatar-placeholder" id="userDashboardAvatar">No Pic</div>
                <div class="user-details">
                    <h2 id="userName">Loading...</h2>
                    <span class="uid-placeholder" id="userUID">UID: Loading...</span>
                </div>
            </section>

            <section class="dashboard-cards">
                <div class="profile-card card-balance">
                    <p>Estimated Balance</p>
                    <h3 id="estimatedBalance">$0.00 USD</h3>
                </div>
                <div class="profile-card card-chart">
                    <p>Portfolio Chart</p>
                    <div id="portfolioChartPlaceholder" style="width:100%; height:150px; background:#f0f0f0; display:flex; align-items:center; justify-content:center;">Chart Area</div>
                </div>
            </section>

            <section class="markets-section">
                <h3>My Favourite Markets</h3>
                <div class="market-filters">
                    <button class="filter-button active" data-filter="favourite">Favourite</button>
                </div>
                <div class="custom-table-wrapper" id="favouriteMarketsTable">
                    <div class="custom-table-header">
                        <span>Coin</span>
                        <span>Last Price</span>
                        <span>24h Change</span>
                        <span>Action</span>
                    </div>
                    <div class="no-data-placeholder">Loading favourite markets...</div>
                </div>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    console.log('[ProfilePage] DOMContentLoaded. Script loaded.');

    const token = localStorage.getItem('authToken');
    console.log('[ProfilePage] Token from localStorage on page load:', token ? token.substring(0,30) + '...' : 'NO TOKEN');

    const userNameElement = document.getElementById('userName');
    const userUIDElement = document.getElementById('userUID');
    const userDashboardAvatarElement = document.getElementById('userDashboardAvatar'); // –ù–æ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç
    const estimatedBalanceElement = document.getElementById('estimatedBalance');
    const favouriteMarketsTable = document.getElementById('favouriteMarketsTable');
    const logoutButton = document.getElementById('logoutButton');

    if (!token) {
        console.warn('[ProfilePage] No token found in localStorage. Redirecting to login page.');
        window.location.href = 'login-page.html';
        return;
    }

    console.log('[ProfilePage] Token found. Proceeding to setup page and fetch data.');

    if (logoutButton) {
        logoutButton.style.display = 'inline-block';
        logoutButton.addEventListener('click', async () => {
            console.log('[ProfilePage] Logout button clicked.');
            const currentTokenForLogout = localStorage.getItem('authToken');
            localStorage.removeItem('authToken');
            console.log('[ProfilePage] authToken removed from localStorage.');
            try {
                const logoutResponse = await fetch('/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${currentTokenForLogout}` }
                });
                const logoutData = await logoutResponse.json();
                console.log('[ProfilePage] Logout API response:', logoutData);
            } catch (error) {
                console.error('[ProfilePage] Error during logout API call:', error);
            }
            window.location.href = 'login-page.html';
        });
    } else {
        console.warn('[ProfilePage] Logout button element not found.');
    }

    async function fetchProtectedData(url, options = {}) {
        // ... (–≤–∞—à–∞ —Ñ—É–Ω–∫—Ü—ñ—è fetchProtectedData –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω) ...
    }

    async function loadProfileData() {
        console.log('[ProfilePage] Attempting to load profile data...');
        try {
            const data = await fetchProtectedData('/api/profile'); // –¶–µ–π –µ–Ω–¥–ø–æ—ñ–Ω—Ç —Ç–µ–ø–µ—Ä –º–∞—î –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ avatar_url
            if (data.success && data.profile) {
                const profile = data.profile;
                if (userNameElement) userNameElement.textContent = profile.username || profile.email.split('@')[0];
                if (userUIDElement) userUIDElement.textContent = `UID: ${profile.uid || 'N/A'}`;
                
                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–≤–∞—Ç–∞—Ä–∞ –Ω–∞ –¥–∞—à–±–æ—Ä–¥—ñ
                if (userDashboardAvatarElement) {
                    if (profile.avatar_url) {
                        userDashboardAvatarElement.style.backgroundImage = `url('${profile.avatar_url}')`;
                        userDashboardAvatarElement.textContent = ''; // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ —Ç–µ–∫—Å—Ç "No Pic", —è–∫—â–æ —î –∫–∞—Ä—Ç–∏–Ω–∫–∞
                    } else {
                        userDashboardAvatarElement.style.backgroundImage = 'none';
                        userDashboardAvatarElement.textContent = 'No Pic'; // –ê–±–æ –∑–∞–ª–∏—à—Ç–µ "picture"
                    }
                }
                console.log('[ProfilePage] Profile data (including avatar) rendered.');
            } else {
                console.error('[ProfilePage] Failed to load profile data from server:', data.message || 'No success field in response');
                if (userNameElement) userNameElement.textContent = 'Error loading profile';
            }
        } catch (error) {
            console.error('[ProfilePage] Error in loadProfileData catcher:', error.message || error);
            if (userNameElement) userNameElement.textContent = 'Error (profile)';
        }
    }

    async function loadProfileData() {
        console.log('[ProfilePage] Attempting to load profile data...');
        try {
            const data = await fetchProtectedData('/api/profile');
            if (data.success && data.profile) {
                if (userNameElement) userNameElement.textContent = data.profile.username || data.profile.email.split('@')[0];
                if (userUIDElement) userUIDElement.textContent = `UID: ${data.profile.uid || 'N/A'}`;
                console.log('[ProfilePage] Profile data rendered.');
            } else {
                console.error('[ProfilePage] Failed to load profile data from server:', data.message || 'No success field in response');
                if (userNameElement) userNameElement.textContent = 'Error loading profile';
            }
        } catch (error) {
            console.error('[ProfilePage] Error in loadProfileData catcher:', error.message || error);
            if (userNameElement) userNameElement.textContent = 'Error (profile)';
        }
    }

    async function loadBalance() {
         console.log('[ProfilePage] Attempting to load balance data...');
        try {
            const data = await fetchProtectedData('/api/balance');
            if (data.success) {
                if (estimatedBalanceElement) estimatedBalanceElement.textContent = `$${parseFloat(data.balance).toFixed(2)} USD`;
                console.log('[ProfilePage] Balance data rendered.');
            } else {
                console.error('[ProfilePage] Failed to load balance from server:', data.message);
                if (estimatedBalanceElement) estimatedBalanceElement.textContent = '$ N/A';
            }
        } catch (error) {
            console.error('[ProfilePage] Error in loadBalance catcher:', error.message || error);
            if (estimatedBalanceElement) estimatedBalanceElement.textContent = '$ Error';
        }
    }

    // --- –§–£–ù–ö–¶–Ü–Ø –î–õ–Ø –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –¢–ê –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –£–õ–Æ–ë–õ–ï–ù–ò–• –†–ò–ù–ö–Ü–í ---
    async function loadAndRenderFavouriteMarkets() {
        if (!favouriteMarketsTable) {
            console.warn('[ProfilePage] Favourite markets table element not found.');
            return;
        }
        console.log('[ProfilePage] Attempting to load favourite markets data...');

        const header = favouriteMarketsTable.querySelector('.custom-table-header');
        // –û—á–∏—â–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ä—è–¥–∫–∏ –¥–∞–Ω–∏—Ö, –∑–∞–ª–∏—à–∞—é—á–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ñ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä "Loading..."
        const currentRows = favouriteMarketsTable.querySelectorAll('.custom-table-row');
        currentRows.forEach(row => row.remove());
        let placeholder = favouriteMarketsTable.querySelector('.no-data-placeholder');
        if (placeholder) {
            placeholder.textContent = 'Loading favourite markets...';
        } else {
            favouriteMarketsTable.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">Loading favourite markets...</div>');
            placeholder = favouriteMarketsTable.querySelector('.no-data-placeholder');
        }


        try {
            const data = await fetchProtectedData('/api/markets/favourites');
            console.log('[ProfilePage] Favourite markets data received from server:', data);

            if (placeholder) placeholder.remove(); // –í–∏–¥–∞–ª—è—î–º–æ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä "Loading..."

            if (data.success && data.markets) {
                if (data.markets.length === 0) {
                    favouriteMarketsTable.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">You have no favourite markets yet. <a href="markets.html">Add some from the Markets page!</a></div>');
                    return;
                }
                data.markets.forEach(market => {
                    const row = document.createElement('div');
                    row.classList.add('custom-table-row');
                    // –ù–∞ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ currentPrice —Ç–∞ change24hPercent –º–æ–∂—É—Ç—å –±—É—Ç–∏ null, —è–∫—â–æ WebSocket —â–µ –Ω–µ –ø—Ä–∞—Ü—é—î
                    // –∞–±–æ —è–∫—â–æ –¥–ª—è —Ü–∏—Ö –ø–∞—Ä –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö —É currentMarketData –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.
                    const price = market.currentPrice ? `$${parseFloat(market.currentPrice).toFixed(2)}` : 'N/A';
                    const change = market.change24hPercent ? parseFloat(market.change24hPercent).toFixed(2) + '%' : 'N/A';
                    const changeClass = market.change24hPercent ? (parseFloat(market.change24hPercent) >= 0 ? 'positive-change' : 'negative-change') : '';

                    row.innerHTML = `
                        <span class="coin-name">${market.symbol.split('/')[0]} <span class="coin-symbol-small">(${market.symbol.replace('/', '')})</span></span>
                        <span>${price}</span>
                        <span class="${changeClass}">${change}</span>
                        <span>
                            <a href="trading-page.html?pair=${market.symbol.replace('/', '_')}" class="action-link">Trade</a>
                            <button class="remove-favourite-btn is-favourite" data-market-id="${market.id}" title="Remove from Favourites">‚òÖ</button>
                        </span>
                    `;
                    favouriteMarketsTable.appendChild(row);
                });

                // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑ —É–ª—é–±–ª–µ–Ω–∏—Ö
                document.querySelectorAll('.remove-favourite-btn').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const marketId = event.currentTarget.dataset.marketId;
                        if (!confirm('Are you sure you want to remove this market from favourites?')) return;
                        
                        console.log(`[ProfilePage] Attempting to remove favourite market ID: ${marketId}`);
                        try {
                            const deleteData = await fetchProtectedData(`/api/favourites/${marketId}`, { method: 'DELETE' });
                            
                            if (deleteData.success) {
                                console.log(`[ProfilePage] Favourite market ID: ${marketId} successfully removed. Reloading favourites.`);
                                loadAndRenderFavouriteMarkets(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ –∑–º—ñ–Ω–∏
                            } else {
                                alert(deleteData.message || 'Failed to remove favourite.');
                                console.error('[ProfilePage] Server failed to remove favourite:', deleteData.message);
                            }
                        } catch (err) {
                            console.error('[ProfilePage] Error sending remove favourite request:', err);
                            alert(err.message || 'Error removing favourite.');
                        }
                    });
                });
                console.log('[ProfilePage] Favourite markets rendered.');
            } else {
                favouriteMarketsTable.insertAdjacentHTML('beforeend', `<div class="no-data-placeholder">${data.message || 'Could not load favourite markets.'}</div>`);
            }
        } catch (error) {
            console.error('[ProfilePage] Error in loadAndRenderFavouriteMarkets catcher:', error.message || error);
            const currentPlaceholderOnError = favouriteMarketsTable.querySelector('.no-data-placeholder');
            if (currentPlaceholderOnError) currentPlaceholderOnError.textContent = 'Error loading favourite markets. Please try again.';
        }
    }

    console.log('[ProfilePage] Starting initial data load sequence.');
    await loadProfileData(); // –¶—è —Ñ—É–Ω–∫—Ü—ñ—è —Ç–µ–ø–µ—Ä –æ–Ω–æ–≤–∏—Ç—å —ñ –∞–≤–∞—Ç–∞—Ä
    await loadBalance();
    await loadAndRenderFavouriteMarkets();
    console.log('[ProfilePage] Initial data load sequence finished.');
});
</script>
</body>
</html>
