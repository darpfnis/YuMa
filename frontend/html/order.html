<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - YuMa</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/orders.css">
</head>
<body>
    <header>
        <div class="header-left">
            <div class="logo"><a href="../../index.html">YuMa</a></div>
            <nav class="main-nav">
                <a href="buy_crypto-page.html">Buy Crypto</a>
                <a href="markets.html" class="active">Markets</a>
                <div class="dropdown-container">
                    <a href="#" class="nav-link dropdown-toggle">Trade</a>
                    <div class="dropdown-content trade-dropdown">
                        <div class="dropdown-column">
                            <a href="spot-page.html">Spot</a>
                            <a href="#">Margin</a>
                            <a href="#">P2P</a>
                            <a href="#">Convert & Block Trade</a>
                        </div>
                    </div>
                </div>
                <div class="dropdown-container">
                    <a href="#" class="nav-link dropdown-toggle">Futures</a>
                    <div class="dropdown-content futures-dropdown">
                        <a href="futures-page.html">USDⓈ-M Futures</a>
                        <a href="#">COIN-M Futures</a>
                        <a href="#">Options</a>
                        <a href="#">Leaderboard</a>
                    </div>
                </div>
                <a href="./frontend/html/faq.html">FAQ</a>
            </nav>
        </div>
        <nav class="user-nav">
            <a href="sign_up-page.html" id="signUpLinkMarkets">Sign up</a>
            <a href="login-page.html" id="loginLinkMarkets">Log in</a>
            <a id="logoutButtonAccount" style="display: none;">Log out</button>
        </nav>
    </header>

        <!-- КОНТЕЙНЕР ДЛЯ ДЕКОРАТИВНИХ SVG ЕЛЕМЕНТІВ -->
    <div class="background-svg-decorations">
        <img src="./frontend/resources/13.svg" alt="Top Left Blob Decoration" class="decor-element decor-blob-tl">
        <img src="./frontend/resources/15.svg" alt="Top Left Ring Decoration" class="decor-element decor-ring-tl"> 
        <img src="./frontend/resources/14.svg" alt="Bottom Right Blob Decoration" class="decor-element decor-blob-br"> 
        <img src="./frontend/resources/16.svg" alt="Bottom Right Ring Decoration" class="decor-element decor-ring-br">
    </div>

    <div class="page-wrapper-profile">
        <aside class="sidebar">
            <nav>
                <a href="profile.html" class="sidebar-button">dashboard</a>
                <a href="assets.html" class="sidebar-button">assets</a>
                <a href="order.html" class="sidebar-button active">order</a>
                <a href="account.html" class="sidebar-button">account</a>
                <a href="settings.html" class="sidebar-button">settings</a>
            </nav>
        </aside>

        <main class="main-content-profile">
            <section class="content-header">
                <h2>Order Management</h2>
            </section>

            <div class="tabs-container">
                <button class="tab-button active" data-tab="open-orders-content">Open Orders</button>
                <button class="tab-button" data-tab="order-history-content">Order History</button>
                <button class="tab-button" data-tab="trade-history-content">Trade History</button>
            </div>

            <!-- Вміст для Відкритих Ордерів -->
            <div id="open-orders-content" class="tab-content active">
                <section class="orders-list-section">
                    <h3>Open Orders</h3>
                     <div class="table-controls">
                        <input type="text" id="searchOpenOrdersPair" placeholder="Search Pair (e.g. BTC/USDT)..." class="search-input large-search">
                        <button id="cancelAllOpenOrdersBtn" class="action-button danger-action">Cancel All Orders</button>
                    </div>
                    <div class="custom-table-wrapper" id="openOrdersTable">
                        <div class="custom-table-header">
                            <span>Date</span>
                            <span>Pair</span>
                            <span>Type</span>
                            <span>Side</span>
                            <span>Price</span>
                            <span>Amount</span>
                            <span>Filled</span>
                            <span>Total</span>
                            <span>Action</span>
                        </div>
                        <div class="no-data-placeholder">Loading open orders...</div>
                    </div>
                </section>
            </div>

            <!-- Вміст для Історії Ордерів -->
            <div id="order-history-content" class="tab-content">
                <section class="orders-list-section">
                    <h3>Order History</h3>
                     <div class="table-controls">
                        <input type="date" id="orderHistoryDateFrom" class="date-input">
                        <span>to</span>
                        <input type="date" id="orderHistoryDateTo" class="date-input">
                        <input type="text" id="orderHistoryPair" placeholder="Pair..." class="search-input small-search">
                        <select id="orderHistoryType" class="filter-select"><option value="">All Types</option><option value="limit">Limit</option><option value="market">Market</option></select>
                        <select id="orderHistorySide" class="filter-select"><option value="">All Sides</option><option value="buy">Buy</option><option value="sell">Sell</option></select>
                        <button id="searchOrderHistoryBtn" class="action-button">Search</button>
                    </div>
                    <div class="custom-table-wrapper" id="orderHistoryTable">
                        <div class="custom-table-header">
                            <span>Date</span>
                            <span>Pair</span>
                            <span>Type</span>
                            <span>Side</span>
                            <span>Avg. Price</span>
                            <span>Executed</span>
                            <span>Amount</span>
                            <span>Total</span>
                            <span>Status</span>
                        </div>
                         <div class="no-data-placeholder">Loading order history...</div>
                    </div>
                </section>
            </div>

            <!-- Вміст для Історії Угод (поки плейсхолдер) -->
            <div id="trade-history-content" class="tab-content">
                <section class="orders-list-section">
                    <h3>Trade History</h3>
                     <div class="table-controls">
                        <!-- Фільтри схожі на Order History -->
                     </div>
                    <div class="custom-table-wrapper" id="tradeHistoryTable">
                        <div class="custom-table-header">
                            <span>Date</span>
                            <span>Pair</span>
                            <span>Side</span>
                            <span>Price</span>
                            <span>Executed</span>
                            <span>Fee</span>
                            <span>Role</span>
                            <span>Total</span>
                        </div>
                        <div class="no-data-placeholder">Trade history feature coming soon.</div>
                    </div>
                </section>
            </div>
        </main>
    </div>
<script>
    // --- START: Auth UI Logic (можна винести в окремий auth-ui.js файл) ---
    function updateHeaderAuthState() {
        const token = localStorage.getItem('authToken');
        const signUpLink = document.getElementById('signUpLinkMarkets');
        const loginLink = document.getElementById('loginLinkMarkets');
        const profileLink = document.getElementById('profileLinkAccount');
        const logoutButtonHeader = document.getElementById('logoutButtonAccount');

        if (token) {
            // Користувач залогінений
            if (signUpLink) signUpLink.style.display = 'none';
            if (loginLink) loginLink.style.display = 'none';
            if (profileLink) profileLink.style.display = 'inline-block'; // або 'block', 'flex' залежно від стилів
            if (logoutButtonHeader) logoutButtonHeader.style.display = 'inline-block'; // або 'block'
        } else {
            // Користувач не залогінений
            if (signUpLink) signUpLink.style.display = 'inline-block';
            if (loginLink) loginLink.style.display = 'inline-block';
            if (profileLink) profileLink.style.display = 'none';
            if (logoutButtonHeader) logoutButtonHeader.style.display = 'none';
        }
    }

    function setupLogoutButton() {
        const logoutButtonHeader = document.getElementById('logoutButtonAccount');
        if (logoutButtonHeader) {
            // Перевіряємо, чи обробник вже не доданий, щоб уникнути дублювання
            if (!logoutButtonHeader.dataset.listenerAttached) {
                logoutButtonHeader.addEventListener('click', async () => {
                    const currentTokenForLogout = localStorage.getItem('authToken');
                    localStorage.removeItem('authToken');
                    // Оновлюємо UI негайно, до перенаправлення
                    updateHeaderAuthState();
                    try {
                        if (currentTokenForLogout) {
                            await fetch('/auth/logout', {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${currentTokenForLogout}` }
                            });
                        }
                    } catch (e) {
                        console.error('Logout API error', e);
                    }
                    window.location.href = 'login-page.html';
                });
                logoutButtonHeader.dataset.listenerAttached = 'true'; // Позначаємо, що обробник додано
            }
        }
    }
    // --- END: Auth UI Logic ---

    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Ініціалізуємо стан UI хедера на основі токена
        updateHeaderAuthState();
        // 2. Налаштовуємо кнопку виходу
        setupLogoutButton();

        const token = localStorage.getItem('authToken'); // Отримуємо токен ще раз для логіки перенаправлення

        // 3. Перевірка авторизації для сторінки (ця частина специфічна для сторінок, що вимагають логін)
        // Якщо це сторінка order.html, і токен відсутній, перенаправляємо.
        // Для публічних сторінок (наприклад, головна, логін, реєстрація) ця перевірка не потрібна або буде іншою.
        if (!token && window.location.pathname.includes('order.html')) { // Приклад умови для захищеної сторінки
            window.location.href = 'login-page.html';
            return; // Зупиняємо подальше виконання скрипта для цієї сторінки
        }

        // --- Решта коду для сторінки order.html (завантаження даних, таби і т.д.) ---

        const openOrdersTableContainer = document.getElementById('openOrdersTable');
        const orderHistoryTableContainer = document.getElementById('orderHistoryTable');

        async function fetchProtectedData(url, options = {}) {
            const currentToken = localStorage.getItem('authToken');
            if (!currentToken) {
                updateHeaderAuthState(); // Оновлюємо хедер, якщо токен зник
                window.location.href = 'login-page.html';
                return Promise.reject(new Error('No token, redirecting.'));
            }
            const defaultHeaders = {
                'Authorization': `Bearer ${currentToken}`,
                'Content-Type': 'application/json'
            };
            const fetchOptions = { ...options, headers: { ...defaultHeaders, ...options.headers } };
            const response = await fetch(url, fetchOptions);
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('authToken');
                    updateHeaderAuthState(); // Оновлюємо хедер
                    window.location.href = 'login-page.html';
                    return Promise.reject(new Error('Unauthorized or Forbidden.'));
                }
                const errorData = await response.json().catch(() => ({ message: `HTTP error! Status: ${response.status}` }));
                return Promise.reject(errorData);
            }
            return response.json();
        }

        async function loadOpenOrders() {
            if (!openOrdersTableContainer) return;
            const header = openOrdersTableContainer.querySelector('.custom-table-header');
            openOrdersTableContainer.innerHTML = '';
            if (header) openOrdersTableContainer.appendChild(header);
            openOrdersTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">Loading open orders...</div>');

            try {
                const data = await fetchProtectedData('/api/orders/open');
                const placeholder = openOrdersTableContainer.querySelector('.no-data-placeholder');
                if (placeholder) placeholder.remove();

                if (data.success && data.orders) {
                    if (data.orders.length === 0) {
                        openOrdersTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">No open orders.</div>');
                        return;
                    }
                    data.orders.forEach(order => {
                        const row = document.createElement('div');
                        row.classList.add('custom-table-row', 'order-row');
                        const filledPercent = (parseFloat(order.filled_amount_base) / parseFloat(order.amount) * 100).toFixed(0);
                        const totalValue = order.price && order.amount ? (parseFloat(order.price) * parseFloat(order.amount)).toFixed(2) : 'N/A';
                        const orderDate = new Date(order.created_at).toLocaleString();

                        row.innerHTML = `
                            <span>${orderDate}</span>
                            <span>${order.pair}</span>
                            <span>${order.type}</span>
                            <span class="side-${order.side.toLowerCase()}">${order.side.toUpperCase()}</span>
                            <span>${order.price ? '$' + parseFloat(order.price).toFixed(2) : 'Market'}</span>
                            <span>${parseFloat(order.amount).toFixed(6)} ${order.pair.split('/')[0]}</span>
                            <span>${filledPercent}%</span>
                            <span>${totalValue !== 'N/A' ? '$' + totalValue : 'N/A'}</span>
                            <span><a href="#" class="action-link danger-link cancel-order-btn" data-order-id="${order.id}">Cancel</a></span>
                        `;
                        openOrdersTableContainer.appendChild(row);
                    });
                } else {
                    openOrdersTableContainer.insertAdjacentHTML('beforeend', `<div class="no-data-placeholder">${data.message || 'Could not load open orders.'}</div>`);
                }
            } catch (error) {
                console.error('Error fetching open orders:', error);
                if (error.message !== 'Unauthorized or Forbidden.' && error.message !== 'No token, redirecting.') {
                    const placeholder = openOrdersTableContainer.querySelector('.no-data-placeholder');
                    if(placeholder) placeholder.remove();
                    openOrdersTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">Error loading open orders.</div>');
                }
            }
        }

        async function loadOrderHistory() {
            if (!orderHistoryTableContainer) return;
            const header = orderHistoryTableContainer.querySelector('.custom-table-header');
            orderHistoryTableContainer.innerHTML = '';
            if (header) orderHistoryTableContainer.appendChild(header);
            orderHistoryTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">Loading order history...</div>');

            try {
                const data = await fetchProtectedData(`/api/orders/history`);
                const placeholder = orderHistoryTableContainer.querySelector('.no-data-placeholder');
                if (placeholder) placeholder.remove();

                if (data.success && data.orders) {
                    if (data.orders.length === 0) {
                        orderHistoryTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">No order history found.</div>');
                        return;
                    }
                    data.orders.forEach(order => {
                        const row = document.createElement('div');
                        row.classList.add('custom-table-row', 'order-row');
                        const orderDate = new Date(order.created_at).toLocaleString();
                        const avgPrice = order.avg_fill_price ? '$' + parseFloat(order.avg_fill_price).toFixed(2) : 'N/A';
                        const executedAmount = order.filled_amount_base ? parseFloat(order.filled_amount_base).toFixed(6) + ' ' + order.pair.split('/')[0] : 'N/A';
                        const totalExecuted = order.avg_fill_price && order.filled_amount_base ? '$' + (parseFloat(order.avg_fill_price) * parseFloat(order.filled_amount_base)).toFixed(2) : 'N/A';

                        row.innerHTML = `
                            <span>${orderDate}</span>
                            <span>${order.pair}</span>
                            <span>${order.type}</span>
                            <span class="side-${order.side.toLowerCase()}">${order.side.toUpperCase()}</span>
                            <span>${avgPrice}</span>
                            <span>${executedAmount}</span>
                            <span>${parseFloat(order.amount).toFixed(6)} ${order.pair.split('/')[0]}</span>
                            <span>${totalExecuted}</span>
                            <span class="status-${order.status.toLowerCase().replace('_', '')}">${order.status.replace('_', ' ').toUpperCase()}</span>
                        `;
                        orderHistoryTableContainer.appendChild(row);
                    });
                } else {
                    orderHistoryTableContainer.insertAdjacentHTML('beforeend', `<div class="no-data-placeholder">${data.message || 'Could not load order history.'}</div>`);
                }
            } catch (error) {
                console.error('Error fetching order history:', error);
                if (error.message !== 'Unauthorized or Forbidden.' && error.message !== 'No token, redirecting.') {
                    const placeholder = orderHistoryTableContainer.querySelector('.no-data-placeholder');
                    if(placeholder) placeholder.remove();
                    orderHistoryTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">Error loading order history.</div>');
                }
            }
        }

        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        function activateTab(tabId) {
            tabContents.forEach(content => content.classList.remove('active'));
            tabs.forEach(tab => tab.classList.remove('active'));

            const activeContent = document.getElementById(tabId);
            const activeButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);

            if (activeContent) activeContent.classList.add('active');
            if (activeButton) activeButton.classList.add('active');

            if (tabId === 'open-orders-content') {
                loadOpenOrders();
            } else if (tabId === 'order-history-content') {
                loadOrderHistory();
            } else if (tabId === 'trade-history-content') {
                const tradeHistoryPlaceholder = document.querySelector('#trade-history-content .no-data-placeholder');
                if (tradeHistoryPlaceholder) tradeHistoryPlaceholder.textContent = 'Trade history will be available soon.';
            }
        }

        tabs.forEach(button => {
            button.addEventListener('click', () => {
                activateTab(button.dataset.tab);
            });
        });

        // Завантажуємо дані для початкового активного таба, тільки якщо користувач авторизований
        // (перевірка на токен і `return` вище це забезпечують)
        activateTab('open-orders-content');
    });
</script>
</body>
</html>
