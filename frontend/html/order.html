<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - YuMa</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/global.css">
    <!-- <link rel="stylesheet" href="../css/orders.css"> -- –Ø–∫—â–æ —î —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Å—Ç–∏–ª—ñ -->
    <style>
        /* –°—Ç–∏–ª—ñ –¥–ª—è —Å—Ç–∞—Ç—É—Å—ñ–≤, —Å—Ç–æ—Ä—ñ–Ω (–º–æ–∂–Ω–∞ –≤–∏–Ω–µ—Å—Ç–∏ –≤ CSS) */
        .side-buy { color: green; font-weight: bold; }
        .side-sell { color: red; font-weight: bold; }
        .status-filled { color: green; }
        .status-canceled { color: #6c757d; }
        .status-open, .status-partially_filled { color: #ffc107; } /* –ñ–æ–≤—Ç–∏–π –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö/—á–∞—Å—Ç–∫–æ–≤–æ –≤–∏–∫–æ–Ω–∞–Ω–∏—Ö */
        .action-link.danger-link { color: #dc3545; }
        .action-link.danger-link:hover { color: #c82333; }
    </style>
</head>
<body>
    <header>
        <div class="logo"><a href="../../index.html">YuMa</a></div>
        <nav class="header-nav">
            <a href="buy_crypto-page.html" class="nav-button">Buy Crypto</a>
            <a href="markets.html" class="nav-button">Markets</a>
            <a href="trading-page.html" class="nav-button">Trade</a>
        </nav>
        <div class="header-actions">
            <button class="btn-deposit nav-button" onclick="window.location.href='deposit.html'">Deposit</button>
            <div class="icon-placeholder dark-square"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder user-profile-icon"><a href="profile.html" title="Profile" style="text-decoration:none; color:inherit;">üë§</a></div>
            <button id="logoutButtonOrders" class="nav-button" style="display: none;">Log out</button>
        </div>
    </header>

    <div class="page-wrapper-profile">
        <aside class="sidebar">
            <nav>
                <a href="profile.html" class="sidebar-button">dashboard</a>
                <a href="assets.html" class="sidebar-button">assets</a>
                <a href="order.html" class="sidebar-button active">order</a>
                <a href="account.html" class="sidebar-button">account</a>
                <a href="settings.html" class="sidebar-button">settings</a>
            </nav>
        </aside>

        <main class="main-content-profile">
            <section class="content-header">
                <h2>Order Management</h2>
            </section>

            <div class="tabs-container">
                <button class="tab-button active" data-tab="open-orders-content">Open Orders</button>
                <button class="tab-button" data-tab="order-history-content">Order History</button>
                <button class="tab-button" data-tab="trade-history-content">Trade History</button>
            </div>

            <!-- –í–º—ñ—Å—Ç –¥–ª—è –í—ñ–¥–∫—Ä–∏—Ç–∏—Ö –û—Ä–¥–µ—Ä—ñ–≤ -->
            <div id="open-orders-content" class="tab-content active">
                <section class="orders-list-section">
                    <h3>Open Orders</h3>
                     <div class="table-controls">
                        <input type="text" id="searchOpenOrdersPair" placeholder="Search Pair (e.g. BTC/USDT)..." class="search-input large-search">
                        <button id="cancelAllOpenOrdersBtn" class="action-button danger-action">Cancel All Orders</button>
                    </div>
                    <div class="custom-table-wrapper" id="openOrdersTable">
                        <div class="custom-table-header">
                            <span>Date</span>
                            <span>Pair</span>
                            <span>Type</span>
                            <span>Side</span>
                            <span>Price</span>
                            <span>Amount</span>
                            <span>Filled</span>
                            <span>Total</span>
                            <span>Action</span>
                        </div>
                        <div class="no-data-placeholder">Loading open orders...</div>
                        <!-- –†—è–¥–∫–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                    </div>
                </section>
            </div>

            <!-- –í–º—ñ—Å—Ç –¥–ª—è –Ü—Å—Ç–æ—Ä—ñ—ó –û—Ä–¥–µ—Ä—ñ–≤ -->
            <div id="order-history-content" class="tab-content">
                <section class="orders-list-section">
                    <h3>Order History</h3>
                     <div class="table-controls">
                        <input type="date" id="orderHistoryDateFrom" class="date-input">
                        <span>to</span>
                        <input type="date" id="orderHistoryDateTo" class="date-input">
                        <input type="text" id="orderHistoryPair" placeholder="Pair..." class="search-input small-search">
                        <select id="orderHistoryType" class="filter-select"><option value="">All Types</option><option value="limit">Limit</option><option value="market">Market</option></select>
                        <select id="orderHistorySide" class="filter-select"><option value="">All Sides</option><option value="buy">Buy</option><option value="sell">Sell</option></select>
                        <button id="searchOrderHistoryBtn" class="action-button">Search</button>
                    </div>
                    <div class="custom-table-wrapper" id="orderHistoryTable">
                        <div class="custom-table-header">
                            <span>Date</span>
                            <span>Pair</span>
                            <span>Type</span>
                            <span>Side</span>
                            <span>Avg. Price</span>
                            <span>Executed</span>
                            <span>Amount</span>
                            <span>Total</span>
                            <span>Status</span>
                        </div>
                         <div class="no-data-placeholder">Loading order history...</div>
                        <!-- –†—è–¥–∫–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                    </div>
                </section>
            </div>
            
            <!-- –í–º—ñ—Å—Ç –¥–ª—è –Ü—Å—Ç–æ—Ä—ñ—ó –£–≥–æ–¥ (–ø–æ–∫–∏ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä) -->
            <div id="trade-history-content" class="tab-content">
                <section class="orders-list-section">
                    <h3>Trade History</h3>
                     <div class="table-controls">
                        <!-- –§—ñ–ª—å—Ç—Ä–∏ —Å—Ö–æ–∂—ñ –Ω–∞ Order History -->
                     </div>
                    <div class="custom-table-wrapper" id="tradeHistoryTable">
                        <div class="custom-table-header">
                            <span>Date</span>
                            <span>Pair</span>
                            <span>Side</span>
                            <span>Price</span>
                            <span>Executed</span>
                            <span>Fee</span>
                            <span>Role</span>
                            <span>Total</span>
                        </div>
                        <div class="no-data-placeholder">Trade history feature coming soon.</div>
                    </div>
                </section>
            </div>
        </main>
    </div>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('authToken');
    const logoutButton = document.getElementById('logoutButtonOrders');

    // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—å
    const openOrdersTableContainer = document.getElementById('openOrdersTable');
    const orderHistoryTableContainer = document.getElementById('orderHistoryTable');
    // const tradeHistoryTableContainer = document.getElementById('tradeHistoryTable'); // –î–ª—è –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ

    if (!token) {
        window.location.href = 'login-page.html';
        return;
    }

    if (logoutButton) {
        logoutButton.style.display = 'inline-block';
        logoutButton.addEventListener('click', async () => {
            localStorage.removeItem('authToken');
            try {
                await fetch('/auth/logout', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }});
            } catch(e) { console.error('Logout API error', e); }
            window.location.href = 'login-page.html';
        });
    }

    // --- –£—Ç–∏–ª—ñ—Ç–∞ –¥–ª—è –∑–∞–ø–∏—Ç—ñ–≤ ---
    async function fetchProtectedData(url, options = {}) {
        const currentToken = localStorage.getItem('authToken');
        if (!currentToken) {
            window.location.href = 'login-page.html';
            return Promise.reject(new Error('No token, redirecting.'));
        }
        const defaultHeaders = {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
        };
        const fetchOptions = { ...options, headers: { ...defaultHeaders, ...options.headers } };
        const response = await fetch(url, fetchOptions);
        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('authToken');
                window.location.href = 'login-page.html';
                return Promise.reject(new Error('Unauthorized or Forbidden.'));
            }
            const errorData = await response.json().catch(() => ({ message: `HTTP error! Status: ${response.status}` }));
            return Promise.reject(errorData);
        }
        return response.json();
    }

    // --- –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –í—ñ–¥–∫—Ä–∏—Ç–∏—Ö –û—Ä–¥–µ—Ä—ñ–≤ ---
    async function loadOpenOrders() {
        if (!openOrdersTableContainer) return;
        const header = openOrdersTableContainer.querySelector('.custom-table-header');
        openOrdersTableContainer.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ
        if (header) openOrdersTableContainer.appendChild(header);
        openOrdersTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">Loading open orders...</div>');

        try {
            const data = await fetchProtectedData('/api/orders/open');
            const placeholder = openOrdersTableContainer.querySelector('.no-data-placeholder');
            if (placeholder) placeholder.remove();

            if (data.success && data.orders) {
                if (data.orders.length === 0) {
                    openOrdersTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">No open orders.</div>');
                    return;
                }
                data.orders.forEach(order => {
                    const row = document.createElement('div');
                    row.classList.add('custom-table-row', 'order-row');
                    const filledPercent = (parseFloat(order.filled_amount_base) / parseFloat(order.amount) * 100).toFixed(0);
                    const totalValue = order.price && order.amount ? (parseFloat(order.price) * parseFloat(order.amount)).toFixed(2) : 'N/A';
                    // –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–∞—Ç–∏ (–º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É —Ç–∏–ø—É date-fns –∞–±–æ moment.js)
                    const orderDate = new Date(order.created_at).toLocaleString();

                    row.innerHTML = `
                        <span>${orderDate}</span>
                        <span>${order.pair}</span>
                        <span>${order.type}</span>
                        <span class="side-${order.side.toLowerCase()}">${order.side.toUpperCase()}</span>
                        <span>${order.price ? '$' + parseFloat(order.price).toFixed(2) : 'Market'}</span>
                        <span>${parseFloat(order.amount).toFixed(6)} ${order.pair.split('/')[0]}</span>
                        <span>${filledPercent}%</span>
                        <span>${totalValue !== 'N/A' ? '$' + totalValue : 'N/A'}</span>
                        <span><a href="#" class="action-link danger-link cancel-order-btn" data-order-id="${order.id}">Cancel</a></span>
                    `;
                    openOrdersTableContainer.appendChild(row);
                });
                // –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "Cancel" (–ø–æ–∫–∏ –Ω–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ API)
            } else {
                 openOrdersTableContainer.insertAdjacentHTML('beforeend', `<div class="no-data-placeholder">${data.message || 'Could not load open orders.'}</div>`);
            }
        } catch (error) {
            console.error('Error fetching open orders:', error);
            const placeholder = openOrdersTableContainer.querySelector('.no-data-placeholder');
            if(placeholder) placeholder.remove();
            openOrdersTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">Error loading open orders.</div>');
        }
    }

    // --- –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –Ü—Å—Ç–æ—Ä—ñ—ó –û—Ä–¥–µ—Ä—ñ–≤ ---
    async function loadOrderHistory() {
        if (!orderHistoryTableContainer) return;
        const header = orderHistoryTableContainer.querySelector('.custom-table-header');
        orderHistoryTableContainer.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ
        if (header) orderHistoryTableContainer.appendChild(header);
        orderHistoryTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">Loading order history...</div>');

        // TODO: –û—Ç—Ä–∏–º–∞—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤, —è–∫—â–æ –≤–æ–Ω–∏ —î, —ñ –¥–æ–¥–∞—Ç–∏ —ó—Ö –¥–æ URL –∑–∞–ø–∏—Ç—É
        // const dateFrom = document.getElementById('orderHistoryDateFrom').value;
        // const dateTo = document.getElementById('orderHistoryDateTo').value;
        // const pair = document.getElementById('orderHistoryPair').value;
        // ... —ñ —Ç.–¥.
        // let queryParams = '?';
        // if (dateFrom) queryParams += `dateFrom=${dateFrom}&`;
        // –î–æ–¥–∞—Ç–∏ —ñ–Ω—à—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏...

        try {
            const data = await fetchProtectedData(`/api/orders/history`); // –î–æ–¥–∞—Ç–∏ queryParams, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
            const placeholder = orderHistoryTableContainer.querySelector('.no-data-placeholder');
            if (placeholder) placeholder.remove();

            if (data.success && data.orders) {
                 if (data.orders.length === 0) {
                    orderHistoryTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">No order history found.</div>');
                    return;
                }
                data.orders.forEach(order => {
                    const row = document.createElement('div');
                    row.classList.add('custom-table-row', 'order-row');
                    const orderDate = new Date(order.created_at).toLocaleString();
                    const avgPrice = order.avg_fill_price ? '$' + parseFloat(order.avg_fill_price).toFixed(2) : 'N/A';
                    const executedAmount = order.filled_amount_base ? parseFloat(order.filled_amount_base).toFixed(6) + ' ' + order.pair.split('/')[0] : 'N/A';
                    const totalExecuted = order.avg_fill_price && order.filled_amount_base ? '$' + (parseFloat(order.avg_fill_price) * parseFloat(order.filled_amount_base)).toFixed(2) : 'N/A';

                    row.innerHTML = `
                        <span>${orderDate}</span>
                        <span>${order.pair}</span>
                        <span>${order.type}</span>
                        <span class="side-${order.side.toLowerCase()}">${order.side.toUpperCase()}</span>
                        <span>${avgPrice}</span>
                        <span>${executedAmount}</span>
                        <span>${parseFloat(order.amount).toFixed(6)} ${order.pair.split('/')[0]}</span>
                        <span>${totalExecuted}</span>
                        <span class="status-${order.status.toLowerCase().replace('_', '')}">${order.status.replace('_', ' ').toUpperCase()}</span>
                    `;
                    orderHistoryTableContainer.appendChild(row);
                });
            } else {
                orderHistoryTableContainer.insertAdjacentHTML('beforeend', `<div class="no-data-placeholder">${data.message || 'Could not load order history.'}</div>`);
            }
        } catch (error) {
            console.error('Error fetching order history:', error);
            const placeholder = orderHistoryTableContainer.querySelector('.no-data-placeholder');
            if(placeholder) placeholder.remove();
            orderHistoryTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">Error loading order history.</div>');
        }
    }


    // --- –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ç–∞–±—ñ–≤ —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö ---
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    function activateTab(tabId) {
        tabContents.forEach(content => content.classList.remove('active'));
        tabs.forEach(tab => tab.classList.remove('active'));

        const activeContent = document.getElementById(tabId);
        const activeButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);

        if (activeContent) activeContent.classList.add('active');
        if (activeButton) activeButton.classList.add('active');

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–∞–±–∞
        if (tabId === 'open-orders-content') {
            loadOpenOrders();
        } else if (tabId === 'order-history-content') {
            loadOrderHistory();
        } else if (tabId === 'trade-history-content') {
            // loadTradeHistory(); // –î–ª—è –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ
            const tradeHistoryPlaceholder = document.querySelector('#trade-history-content .no-data-placeholder');
            if (tradeHistoryPlaceholder) tradeHistoryPlaceholder.textContent = 'Trade history will be available soon.';
        }
    }

    tabs.forEach(button => {
        button.addEventListener('click', () => {
            activateTab(button.dataset.tab);
        });
    });

    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–∞–±–∞
    activateTab('open-orders-content');

    // TODO: –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ —Ç–∞ –ø–æ—à—É–∫—É, —è–∫—ñ –± –≤–∏–∫–ª–∏–∫–∞–ª–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó load... –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    // const searchOrderHistoryBtn = document.getElementById('searchOrderHistoryBtn');
    // if(searchOrderHistoryBtn) searchOrderHistoryBtn.addEventListener('click', loadOrderHistory);

});
</script>
</body>
</html>