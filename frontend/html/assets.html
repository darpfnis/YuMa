<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Assets - YuMa</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/global.css">
    <!-- <link rel="stylesheet" href="../css/assets.css"> -- –Ø–∫—â–æ —î —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Å—Ç–∏–ª—ñ -->
    <style>
        /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ (–º–æ–∂–Ω–∞ –≤–∏–Ω–µ—Å—Ç–∏ –≤ CSS) */
        .total-value-dynamic { color: #007bff; font-weight: bold; }
        .available-value-dynamic { color: #28a745; }
         .coin-icon-placeholder { /* –°—Ç–∏–ª—ñ –¥–ª—è —ñ–∫–æ–Ω–∫–∏, —è–∫—â–æ –≤–æ–Ω–∏ —â–µ –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω—ñ */
            width: 24px; height: 24px; background-color: #ddd;
            border-radius: 50%; display: inline-block;
            margin-right: 8px; vertical-align: middle;
        }
        .coin-name-full { font-weight: 500; vertical-align: middle;}
        .coin-symbol { color: #777; font-size: 0.9em; vertical-align: middle;}
    </style>
</head>
<body>
    <header>
        <div class="logo"><a href="../../index.html">YuMa</a></div>
        <nav class="header-nav">
            <a href="buy_crypto-page.html" class="nav-button">Buy Crypto</a>
            <a href="markets.html" class="nav-button">Markets</a>
            <a href="trading-page.html" class="nav-button">Trade</a>
        </nav>
        <div class="header-actions">
            <!-- –ü—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ deposit.html —ñ—Å–Ω—É—î –≤ frontend/html/ -->
            <button class="btn-deposit nav-button" onclick="window.location.href='deposit.html'">Deposit</button>
            <div class="icon-placeholder dark-square"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder"></div>
            <!-- –î–æ–¥–∞–º–æ –∫–Ω–æ–ø–∫—É –≤–∏—Ö–æ–¥—É, —è–∫—â–æ —ó—ó –Ω–µ–º–∞—î –≤ —Ö–µ–¥–µ—Ä—ñ –ø–æ –≤—Å—å–æ–º—É —Å–∞–π—Ç—É -->
            <div class="icon-placeholder user-profile-icon"><a href="profile.html" title="Profile" style="text-decoration:none; color:inherit;">üë§</a></div>
            <button id="logoutButtonAssets" class="nav-button" style="display: none;">Log out</button>
        </div>
    </header>

    <div class="page-wrapper-profile">
        <aside class="sidebar">
            <nav>
                <a href="profile.html" class="sidebar-button">dashboard</a>
                <a href="assets.html" class="sidebar-button active">assets</a>
                <a href="order.html" class="sidebar-button">order</a>
                <a href="account.html" class="sidebar-button">account</a>
                <a href="settings.html" class="sidebar-button">settings</a>
            </nav>
        </aside>

        <main class="main-content-profile">
            <section class="content-header">
                <h2>My Assets</h2>
                <button class="action-button primary-action">View Transaction History</button>
            </section>

            <section class="profile-card asset-overview">
                <div class="overview-item">
                    <span class="label">Total Portfolio Value (USD):</span>
                    <!-- ID –¥–ª—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è -->
                    <span class="value total-value-dynamic" id="totalPortfolioValue">$0.00</span>
                </div>
                <div class="overview-item">
                    <span class="label">Total Available for Withdrawal (USD):</span>
                     <!-- ID –¥–ª—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è -->
                    <span class="value available-value-dynamic" id="totalAvailableValue">$0.00</span>
                </div>
            </section>

            <section class="assets-list-section">
                <div class="table-controls">
                    <input type="text" id="searchAssetInput" placeholder="Search Coin..." class="search-input">
                    <label class="checkbox-label">
                        <input type="checkbox" id="hideZeroBalancesCheckbox"> Hide Zero Balances
                    </label>
                </div>

                <div class="custom-table-wrapper" id="assetsTableContainer"> <!-- ID –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ñ -->
                    <div class="custom-table-header">
                        <span>Coin</span>
                        <span>Total Balance</span>
                        <span>Available</span>
                        <span>In Order</span>
                        <span>Value (USD)</span>
                        <span>Actions</span>
                    </div>
                    <div class="no-data-placeholder">Loading assets...</div> <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
                    <!-- –†—è–¥–∫–∏ –∞–∫—Ç–∏–≤—ñ–≤ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
                </div>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    console.log('[AssetsPage] DOMContentLoaded. Script loaded.');
    const token = localStorage.getItem('authToken');

    const totalPortfolioValueElement = document.getElementById('totalPortfolioValue');
    const totalAvailableValueElement = document.getElementById('totalAvailableValue');
    const assetsTableContainer = document.getElementById('assetsTableContainer');
    const searchAssetInput = document.getElementById('searchAssetInput');
    const hideZeroBalancesCheckbox = document.getElementById('hideZeroBalancesCheckbox');
    const logoutButton = document.getElementById('logoutButtonAssets');

    let allFetchedAssets = []; // –î–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –≤—Å—ñ—Ö –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö –∞–∫—Ç–∏–≤—ñ–≤ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó

    if (!token) {
        console.warn('[AssetsPage] No token. Redirecting to login.');
        window.location.href = 'login-page.html';
        return;
    }

    if (logoutButton) {
        logoutButton.style.display = 'inline-block';
        logoutButton.addEventListener('click', async () => {
            console.log('[AssetsPage] Logout button clicked.');
            const currentToken = localStorage.getItem('authToken');
            localStorage.removeItem('authToken');
            try {
                await fetch('/auth/logout', { method: 'POST', headers: { 'Authorization': `Bearer ${currentToken}` }});
            } catch (e) { console.error('Logout API call failed', e); }
            window.location.href = 'login-page.html';
        });
    }

    async function fetchProtectedData(url, options = {}) {
        const currentToken = localStorage.getItem('authToken');
        if (!currentToken) {
            window.location.href = 'login-page.html';
            return Promise.reject(new Error('No token, redirecting.'));
        }
        const defaultHeaders = {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
        };
        const fetchOptions = { ...options, headers: { ...defaultHeaders, ...options.headers } };
        const response = await fetch(url, fetchOptions);
        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('authToken');
                window.location.href = 'login-page.html';
                return Promise.reject(new Error('Unauthorized or Forbidden.'));
            }
            const errorData = await response.json().catch(() => ({ message: `HTTP error! Status: ${response.status}` }));
            return Promise.reject(errorData);
        }
        return response.json();
    }

    function renderAssets(assetsToRender) {
        const header = assetsTableContainer.querySelector('.custom-table-header');
        assetsTableContainer.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ –≤—Å–µ, –≤–∫–ª—é—á–∞—é—á–∏ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
        if (header) assetsTableContainer.appendChild(header); // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫

        if (!assetsToRender || assetsToRender.length === 0) {
            assetsTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">No assets to display.</div>');
            return;
        }

        let calculatedTotalPortfolioValue = 0;
        let calculatedTotalAvailableValue = 0; // –ü–æ–∫–∏ –Ω–µ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –æ–∫—Ä–µ–º–æ

        assetsToRender.forEach(asset => {
            const row = document.createElement('div');
            row.classList.add('custom-table-row', 'asset-row');
            const valueUSD = parseFloat(asset.value_usd) || 0;
            calculatedTotalPortfolioValue += valueUSD;

            row.innerHTML = `
                <span class="coin-details">
                    <span class="coin-icon-placeholder"></span> <!-- TODO: Add real icons -->
                    <span class="coin-name-full">${asset.coin_symbol} <span class="coin-symbol">(${asset.coin_symbol})</span></span>
                </span>
                <span>${parseFloat(asset.total_balance).toFixed(8)}</span>
                <span>${parseFloat(asset.available_balance).toFixed(8)}</span>
                <span>${parseFloat(asset.in_order_balance).toFixed(8)}</span>
                <span>$${valueUSD.toFixed(2)}</span>
                <span class="asset-actions">
                    <a href="#" class="action-link">Deposit</a>
                    <a href="#" class="action-link">Withdraw</a>
                    <a href="trading-page.html?pair=${asset.coin_symbol}USDT" class="action-link">Trade</a> <!-- –ü—Ä–∏–∫–ª–∞–¥ –ø–∞—Ä–∏ –¥–ª—è —Ç–æ—Ä–≥—ñ–≤–ª—ñ -->
                </span>
            `;
            assetsTableContainer.appendChild(row);
        });

        if (totalPortfolioValueElement) {
            totalPortfolioValueElement.textContent = `$${calculatedTotalPortfolioValue.toFixed(2)}`;
        }
        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ totalAvailableValue –ø–æ—Ç—Ä–µ–±—É—î –¥–∞–Ω–∏—Ö –ø—Ä–æ —Ü—ñ–Ω–∏ –¥–ª—è available_balance
        if (totalAvailableValueElement) {
             // –ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, —â–æ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å - —Ü–µ —á–∞—Å—Ç–∏–Ω–∞ –≤—ñ–¥ –∑–∞–≥–∞–ª—å–Ω–æ—ó, –∞–±–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –æ–∫—Ä–µ–º–∞ –ª–æ–≥—ñ–∫–∞
            totalAvailableValueElement.textContent = `$${(calculatedTotalPortfolioValue * 0.8).toFixed(2)}`; // –¢–∏–º—á–∞—Å–æ–≤–æ
        }
    }

    function filterAndRenderAssets() {
        const searchTerm = searchAssetInput.value.toLowerCase();
        const hideZero = hideZeroBalancesCheckbox.checked;

        const filteredAssets = allFetchedAssets.filter(asset => {
            const matchesSearch = asset.coin_symbol.toLowerCase().includes(searchTerm) ||
                                (asset.name && asset.name.toLowerCase().includes(searchTerm));
            const nonZeroBalance = parseFloat(asset.total_balance) > 0;
            return matchesSearch && (!hideZero || nonZeroBalance);
        });
        renderAssets(filteredAssets);
    }

    async function loadAssets() {
        console.log('[AssetsPage] Attempting to load assets data...');
        try {
            const data = await fetchProtectedData('/api/assets');
            console.log('[AssetsPage] Assets data received from server:', data);
            if (data.success && data.assets) {
                allFetchedAssets = data.assets; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—Å—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –∞–∫—Ç–∏–≤–∏
                filterAndRenderAssets(); // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —ó—Ö (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ñ—ñ–ª—å—Ç—Ä—ñ–≤)
                console.log('[AssetsPage] Assets data rendered.');
            } else {
                console.error('[AssetsPage] Failed to load assets from server:', data.message);
                assetsTableContainer.innerHTML = `<div class="no-data-placeholder">${data.message || 'Could not load assets.'}</div>`;
            }
        } catch (error) {
            console.error('[AssetsPage] Error in loadAssets catcher:', error.message || error);
            const placeholder = assetsTableContainer.querySelector('.no-data-placeholder');
            if(placeholder) placeholder.remove();
            assetsTableContainer.insertAdjacentHTML('beforeend', '<div class="no-data-placeholder">Error loading assets. Please try again.</div>');
        }
    }

    // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    if(searchAssetInput) searchAssetInput.addEventListener('input', filterAndRenderAssets);
    if(hideZeroBalancesCheckbox) hideZeroBalancesCheckbox.addEventListener('change', filterAndRenderAssets);

    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    loadAssets();
});
</script>
</body>
</html>