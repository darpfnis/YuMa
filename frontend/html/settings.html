<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Settings - YuMa</title>
    <link rel="stylesheet" href="../css/styles.css"> 
    <link rel="stylesheet" href="../css/header.css"> 
    <link rel="stylesheet" href="../css/global.css"> 
    <link rel="stylesheet" href="../css/settings.css"> 
</head>
<body>
    <header>
        <div class="header-left">
            <div class="logo"><a href="../../index.html">YuMa</a></div>
            <nav class="main-nav">
                <a href="buy_crypto-page.html">Buy Crypto</a>
                <!-- Додаємо клас active до посилання Markets -->
                <a href="markets.html" class="active">Markets</a> 
                <div class="dropdown-container">
                    <a href="#" class="nav-link dropdown-toggle">Trade</a>
                    <div class="dropdown-content trade-dropdown">
                        <div class="dropdown-column">
                            <a href="spot-page.html">Spot</a>
                            <a href="#">Margin</a>
                            <a href="#">P2P</a>
                            <a href="#">Convert & Block Trade</a>
                        </div>
                    </div>
                </div>
                <div class="dropdown-container">
                    <a href="#" class="nav-link dropdown-toggle">Futures</a>
                    <div class="dropdown-content futures-dropdown">
                        <a href="futures-page.html">USDⓈ-M Futures</a>
                        <a href="#">COIN-M Futures</a>
                        <a href="#">Options</a>
                        <a href="#">Leaderboard</a>
                    </div>
                </div>
                <a href="./frontend/html/faq.html">FAQ</a>
            </nav>
        </div>
        <nav class="user-nav">
            <a href="sign_up-page.html" id="signUpLinkMarkets">Sign up</a>
            <a href="login-page.html" id="loginLinkMarkets">Log in</a>
            <a id="logoutButtonAccount" style="display: none;">Log out</a>
        </nav>
    </header>
    <div class="background-svg-decorations">
        <img src="../resources/13.svg" alt="Top Left Blob Decoration" class="decor-element decor-blob-tl">
        <img src="../resources/15.svg" alt="Top Left Ring Decoration" class="decor-element decor-ring-tl"> <!-- УВАГА: Ти використала 15.svg тут, можливо, мало бути 14.svg? -->
        <img src="../resources/14.svg" alt="Bottom Right Blob Decoration" class="decor-element decor-blob-br"> <!-- УВАГА: Ти використала 14.svg тут, можливо, мало бути 15.svg? -->
        <img src="../resources/16.svg" alt="Bottom Right Ring Decoration" class="decor-element decor-ring-br">
    </div>

    <div class="page-wrapper-profile">
        <aside class="sidebar">
            <nav>
                <a href="profile.html" class="sidebar-button">Dashboard</a>
                <a href="assets.html" class="sidebar-button">Assets</a>
                <a href="order.html" class="sidebar-button">Order</a>
                <a href="account.html" class="sidebar-button">Account</a>
                <a href="settings.html" class="sidebar-button active">Settings</a>
            </nav>
        </aside>

        <main class="main-content-profile">
            <section class="content-header">
                <h2>General Settings</h2>
            </section>

            <section class="profile-card settings-section">
                <h3>Profile Settings</h3>
                <div class="settings-form">
                    <div class="form-group">
                        <label for="avatarUrlInput">Profile Picture URL:</label>
                        <div id="avatarPreview" class="avatar-preview">No Image</div>
                        <input type="url" id="avatarUrlInput" name="avatarUrl" placeholder="Enter image URL (e.g., https://.../image.png)">
                        <small>For MVP, we use URL. File upload will be added later.</small>
                    </div>
                    <button type="button" id="saveAvatarBtn" class="action-button">Save Avatar</button>
                    <div id="avatarMessage" class="form-message"></div>
                </div>

                <form id="usernameSettingsForm" class="settings-form">
                    <div class="form-group">
                        <label for="usernameInput">Username:</label>
                        <span class="current-value" id="currentUsername">Loading...</span>
                        <input type="text" id="usernameInput" name="username" placeholder="Enter new username" minlength="3" required>
                    </div>
                    <button type="submit" class="action-button">Save Username</button>
                    <div id="usernameMessage" class="form-message"></div>
                </form>
            </section>

            <section class="profile-card settings-section">
                <h3>Preferences</h3>
                <form id="preferencesForm" class="settings-form">
                    <div class="form-group">
                        <label for="language">Language:</label>
                        <select id="language" name="language">
                            <option value="en">English</option>
                            <option value="ua" selected>Українська</option>
                            <option value="es">Español</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="currency">Default Currency Display:</label>
                        <select id="currency" name="currency">
                            <option value="usd">USD</option>
                            <option value="eur">EUR</option>
                            <option value="uah">UAH</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="timezone">Timezone:</label>
                        <select id="timezone" name="timezone">
                            <option value="utc">UTC</option>
                            <option value="gmt3">(GMT+03:00) Kyiv</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="theme-label">
                            <span>Theme:</span>
                            <label class="theme-switch">
                                <input type="checkbox" id="themeToggle">
                                <span class="theme-slider"></span>
                            </label>
                        </div>
                        <small id="themeStatus">Current theme: Light</small>
                    </div>
                    <button type="submit" class="action-button">Save Preferences</button>
                    <div id="preferencesMessage" class="form-message"></div>
                </form>
            </section>

            <section class="profile-card settings-section">
                <h3>Notification Settings</h3>
                <form id="notificationsForm" class="settings-form">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="email_trades" checked> Email on Trade Execution</label>
                        </div>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="email_deposits" checked> Email on Deposit/Withdrawal</label>
                        </div>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="email_news"> Email for News & Announcements</label>
                        </div>
                    </div>
                    <button type="submit" class="action-button">Save Notifications</button>
                    <div id="notificationsMessage" class="form-message"></div>
                </form>
            </section>
        </main>
    </div>

<script>
// --- START: Auth UI Logic (для хедера) ---
function updateHeaderAuthState() {
    const token = localStorage.getItem('authToken');
    const signUpLink = document.getElementById('signUpLinkMarkets');
    const loginLink = document.getElementById('loginLinkMarkets');
    const logoutButton = document.getElementById('logoutButtonAccount'); // Використовуємо ID з HTML

    if (token) {
        if (signUpLink) signUpLink.style.display = 'none';
        if (loginLink) loginLink.style.display = 'none';
        if (logoutButton) logoutButton.style.display = 'inline-block';
    } else {
        if (signUpLink) signUpLink.style.display = 'inline-block';
        if (loginLink) loginLink.style.display = 'inline-block';
        if (logoutButton) logoutButton.style.display = 'none';
    }
}

function setupLogoutButton() {
    const logoutButton = document.getElementById('logoutButtonAccount'); // Використовуємо ID з HTML
    if (logoutButton) {
        if (!logoutButton.dataset.listenerAttached) {
            logoutButton.addEventListener('click', async (event) => {
                event.preventDefault();
                const currentTokenForLogout = localStorage.getItem('authToken');
                localStorage.removeItem('authToken');
                updateHeaderAuthState(); // Оновлюємо UI

                try {
                    if (currentTokenForLogout) {
                        await fetch('/auth/logout', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${currentTokenForLogout}` }
                        });
                    }
                } catch (e) {
                    console.error('Logout API error', e);
                }
                window.location.href = 'login-page.html';
            });
            logoutButton.dataset.listenerAttached = 'true';
        }
    }
}
// --- END: Auth UI Logic ---

document.addEventListener('DOMContentLoaded', async () => {
    console.log('[SettingsPage] DOMContentLoaded.');

    // 1. Ініціалізуємо стан UI хедера
    updateHeaderAuthState();
    // 2. Налаштовуємо кнопку виходу
    setupLogoutButton();

    const token = localStorage.getItem('authToken');

    const avatarPreview = document.getElementById('avatarPreview');
    const avatarUrlInput = document.getElementById('avatarUrlInput');
    const saveAvatarBtn = document.getElementById('saveAvatarBtn');
    const avatarMessage = document.getElementById('avatarMessage');

    const currentUsernameElement = document.getElementById('currentUsername');
    const usernameInput = document.getElementById('usernameInput');
    const usernameSettingsForm = document.getElementById('usernameSettingsForm');
    const usernameMessage = document.getElementById('usernameMessage');

    const preferencesForm = document.getElementById('preferencesForm');
    const preferencesMessage = document.getElementById('preferencesMessage');
    const notificationsForm = document.getElementById('notificationsForm');
    const notificationsMessage = document.getElementById('notificationsMessage');

    // const logoutButton = document.getElementById('logoutButtonSettings'); // Цей ID не існує в HTML, і логіка перенесена

    if (!token) {
        // updateHeaderAuthState(); // Вже викликано вище
        window.location.href = 'login-page.html';
        return;
    }

    // Видаляємо цей блок, оскільки його функціональність тепер в setupLogoutButton
    /*
    if (logoutButton) { // logoutButton тут посилався на неіснуючий ID logoutButtonSettings
        logoutButton.style.display = 'inline-block';
        logoutButton.addEventListener('click', async () => {
            const currentToken = localStorage.getItem('authToken');
            localStorage.removeItem('authToken');
            // updateHeaderAuthState(); // Додамо, щоб UI оновився
            try {
                await fetch('/auth/logout', { method: 'POST', headers: { 'Authorization': `Bearer ${currentToken}` }});
            } catch(e) { console.error('Logout API error', e); }
            window.location.href = 'login-page.html';
        });
    }
    */

    async function fetchApiData(url, options = {}) {
        const currentToken = localStorage.getItem('authToken');
        const requiresAuth = options.requiresAuth !== undefined ? options.requiresAuth : true;

        if (requiresAuth && !currentToken) {
             updateHeaderAuthState(); // Оновлюємо хедер перед перенаправленням
             window.location.href = 'login-page.html';
             return Promise.resolve({ success: false, message: 'Auth token missing, redirecting.', shouldRedirect: true });
        }
        const headers = { 'Content-Type': 'application/json' };
        if (requiresAuth && currentToken) {
            headers['Authorization'] = `Bearer ${currentToken}`;
        }
        const fetchOptions = { ...options, headers: { ...headers, ...options.headers } };
        try {
            const response = await fetch(url, fetchOptions);
            if (!response.ok) {
                if ((response.status === 401 || response.status === 403) && requiresAuth) {
                    localStorage.removeItem('authToken');
                    updateHeaderAuthState(); // Оновлюємо хедер перед перенаправленням
                    window.location.href = 'login-page.html';
                    return Promise.resolve({ success: false, message: `Auth error. Redirecting.`, shouldRedirect: true });
                }
                try {
                    const errorData = await response.json();
                    return { success: false, ...errorData, status: response.status };
                } catch (jsonError) {
                    const errorText = await response.text();
                    return { success: false, message: `Server error: ${response.status}. Resp: ${errorText.substring(0,100)}`, status: response.status};
                }
            }
            return response.json();
        } catch (error) {
             console.error(`[fetchApiData] Network error for ${url}:`, error);
             if (error.message && error.message.toLowerCase().includes("failed to fetch")) {
                alert(`Network error: Could not connect to server for ${url}.`);
             }
             return { success: false, message: error.message || `Network error.`, isFetchError: true };
        }
    }

    async function loadCurrentProfileSettings() {
        if(avatarMessage) avatarMessage.textContent = '';
        if(usernameMessage) usernameMessage.textContent = '';
        try {
            const data = await fetchApiData('/api/profile', { requiresAuth: true });
            if (data.shouldRedirect) return; // Перевірка, чи не відбулося перенаправлення

            if (data && data.success && data.profile) {
                const profile = data.profile;
                if (currentUsernameElement) currentUsernameElement.textContent = `Current: ${profile.username || 'Not set'}`;
                if (usernameInput) usernameInput.value = profile.username || '';

                if (avatarUrlInput) avatarUrlInput.value = profile.avatar_url || '';
                if (avatarPreview) {
                    if (profile.avatar_url) {
                        avatarPreview.style.backgroundImage = `url('${profile.avatar_url}')`;
                        avatarPreview.textContent = '';
                    } else {
                        avatarPreview.style.backgroundImage = 'none';
                        avatarPreview.textContent = 'No Image';
                    }
                }
            } else {
                const errorMsg = data ? data.message : 'Failed to load profile settings (undefined response).';
                // Не показуємо alert, якщо це була проблема з авторизацією і користувача перенаправили
                if (!data || !data.shouldRedirect) {
                    alert(errorMsg);
                     // Можна додати відображення помилки на сторінці
                    const mainContent = document.querySelector('.main-content-profile');
                    if (mainContent) mainContent.innerHTML = `<p class="no-data-placeholder">${errorMsg}</p>`;
                }
            }
        } catch (error) {
            if (error.shouldRedirect) return; // Перевірка, чи не відбулося перенаправлення
            alert(error.message || 'Could not load profile settings due to an error.');
            const mainContent = document.querySelector('.main-content-profile');
            if (mainContent) mainContent.innerHTML = `<p class="no-data-placeholder">${error.message || 'Error loading profile settings.'}</p>`;
        }
    }

    if (saveAvatarBtn) {
        saveAvatarBtn.addEventListener('click', async () => {
            const newAvatarUrl = avatarUrlInput.value.trim();
            avatarMessage.textContent = 'Saving...';
            avatarMessage.className = 'form-message';

            try {
                const data = await fetchApiData('/api/profile/avatar', {
                    method: 'PUT',
                    body: JSON.stringify({ avatarUrl: newAvatarUrl }),
                    requiresAuth: true
                });
                if (data.shouldRedirect) return;

                if (data && data.success) {
                    avatarMessage.textContent = data.message || 'Avatar updated!';
                    avatarMessage.classList.add('success');
                    if (avatarPreview && data.avatarUrl !== undefined) {
                        if (data.avatarUrl) {
                            avatarPreview.style.backgroundImage = `url('${data.avatarUrl}')`;
                            avatarPreview.textContent = '';
                        } else {
                            avatarPreview.style.backgroundImage = 'none';
                            avatarPreview.textContent = 'No Image';
                        }
                    }
                } else {
                    avatarMessage.textContent = data.message || 'Failed to update avatar.';
                    avatarMessage.classList.add('error');
                }
            } catch (error) {
                if (error.shouldRedirect) return;
                avatarMessage.textContent = error.message || 'Error updating avatar.';
                avatarMessage.classList.add('error');
            }
        });
    }

    if (usernameSettingsForm) {
        usernameSettingsForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const newUsername = usernameInput.value.trim();
            usernameMessage.textContent = 'Saving...';
            usernameMessage.className = 'form-message';

            if (newUsername.length < 3) {
                usernameMessage.textContent = 'Username must be at least 3 characters.';
                usernameMessage.classList.add('error');
                return;
            }

            try {
                const data = await fetchApiData('/api/profile/username', {
                    method: 'PUT',
                    body: JSON.stringify({ newUsername: newUsername }),
                    requiresAuth: true
                });
                if (data.shouldRedirect) return;

                if (data && data.success) {
                    usernameMessage.textContent = data.message || 'Username updated!';
                    usernameMessage.classList.add('success');
                    if (currentUsernameElement && data.user) currentUsernameElement.textContent = `Current: ${data.user.username}`;
                    if (usernameInput && data.user) usernameInput.value = data.user.username;

                    if (data.token) {
                        localStorage.setItem('authToken', data.token);
                        console.log('[SettingsPage] New JWT token saved after username update.');
                    }
                } else {
                    usernameMessage.textContent = data.message || 'Failed to update username.';
                    usernameMessage.classList.add('error');
                }
            } catch (error) {
                if (error.shouldRedirect) return;
                usernameMessage.textContent = error.message || 'Error updating username.';
                usernameMessage.classList.add('error');
            }
        });
    }

    function showNotImplementedMessage(form, messageElement) {
        if (form && messageElement) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                messageElement.textContent = 'This feature is not implemented yet.';
                messageElement.className = 'form-message';
                messageElement.style.color = 'orange';
            });
        }
    }
    showNotImplementedMessage(preferencesForm, preferencesMessage);
    showNotImplementedMessage(notificationsForm, notificationsMessage);

    // Завантажуємо дані, тільки якщо є токен (перевірка вже є на початку)
    if (token) {
        loadCurrentProfileSettings();
    }
});
</script>
</body>
</html>
