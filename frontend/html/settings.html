<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Settings - YuMa</title>
    <link rel="stylesheet" href="../css/styles.css"> <!-- –ì–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª —Å—Ç–∏–ª—ñ–≤ -->
    <link rel="stylesheet" href="../css/header.css"> <!-- –°—Ç–∏–ª—ñ –¥–ª—è —Ö–µ–¥–µ—Ä–∞ -->
    <link rel="stylesheet" href="../css/global.css"> <!-- –ì–ª–æ–±–∞–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ -->
    <!-- <link rel="stylesheet" href="../css/settings.css"> -- –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏, —è–∫—â–æ —î -->
    <style>
        /* –¢–∏–º—á–∞—Å–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Å—Ç–∞—Ä—Ç—É, –∫—Ä–∞—â–µ –≤–∏–Ω–µ—Å—Ç–∏ –≤ CSS */
        .avatar-preview {
            width: 100px; height: 100px; border-radius: 50%;
            background-color: #e9ecef; margin-bottom: 1rem;
            background-size: cover; background-position: center;
            border: 2px solid #ced4da;
            display: flex; align-items: center; justify-content: center;
            color: #6c757d; font-size: 1.2rem;
        }
        .settings-form input[type="url"], .settings-form input[type="text"], .settings-form select {
            margin-bottom: 1rem; /* –í—ñ–¥—Å—Ç—É–ø –ø—ñ–¥ —ñ–Ω–ø—É—Ç–∞–º–∏/—Å–µ–ª–µ–∫—Ç–∞–º–∏ */
        }
        .settings-form small { display: block; margin-top: -0.5rem; margin-bottom: 1rem; font-size: 1.2rem; color: #6c757d; }
        .form-message { font-size: 1.3rem; margin-top: 1rem; padding: 0.5rem 0; }
        .form-message.success { color: #28a745; }
        .form-message.error { color: #dc3545; }
        .current-value {
            font-style: italic;
            color: #495057; /* –¢—Ä–æ—Ö–∏ —Ç–µ–º–Ω—ñ—à–µ */
            font-size: 1.4rem; /* –¢—Ä–æ—Ö–∏ –±—ñ–ª—å—à–µ */
            margin-bottom: 0.8rem; /* –í—ñ–¥—Å—Ç—É–ø –ø—ñ–¥ –ø–æ—Ç–æ—á–Ω–∏–º –∑–Ω–∞—á–µ–Ω–Ω—è–º */
            display: block;
        }
        .settings-section hr {
            border: 0;
            border-top: 1px solid #dee2e6; /* –°–≤—ñ—Ç–ª—ñ—à–∏–π —Ä–æ–∑–¥—ñ–ª—é–≤–∞—á */
            margin: 2.5rem 0;
        }
        .settings-form button.action-button {
             margin-top: 0.5rem; /* –ù–µ–≤–µ–ª–∏–∫–∏–π –≤—ñ–¥—Å—Ç—É–ø –Ω–∞–¥ –∫–Ω–æ–ø–∫–∞–º–∏ */
        }
        .profile-card.settings-section { /* –î–æ–¥–∞–º–æ —Ç—Ä–æ—Ö–∏ –±—ñ–ª—å—à–µ –ø–∞–¥—ñ–Ω–≥—É –¥–æ —Å–µ–∫—Ü—ñ–π */
            padding: 2.5rem;
        }
        .form-group { /* –î–æ–¥–∞–º–æ –≤—ñ–¥—Å—Ç—É–ø –¥–ª—è –≥—Ä—É–ø –ø–æ–ª—ñ–≤ */
            margin-bottom: 2rem;
        }
        .form-group:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo"><a href="../../index.html">YuMa</a></div>
        <nav class="header-nav">
            <a href="buy_crypto-page.html" class="nav-button">Buy Crypto</a>
            <a href="markets.html" class="nav-button">Markets</a>
            <a href="trading-page.html" class="nav-button">Trade</a>
        </nav>
        <div class="header-actions">
            <button class="btn-deposit nav-button" onclick="window.location.href='deposit.html'">Deposit</button>
            <div class="icon-placeholder dark-square"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder user-profile-icon"><a href="profile.html" title="Profile" style="text-decoration:none; color:inherit;">üë§</a></div>
            <div class="icon-placeholder"></div>
            <button id="logoutButtonSettings" class="nav-button" style="display: none;">Log out</button>
        </div>
    </header>

    <div class="page-wrapper-profile">
        <aside class="sidebar">
            <nav>
                <a href="profile.html" class="sidebar-button">dashboard</a>
                <a href="assets.html" class="sidebar-button">assets</a>
                <a href="order.html" class="sidebar-button">order</a>
                <a href="account.html" class="sidebar-button">account</a>
                <a href="settings.html" class="sidebar-button active">settings</a>
            </nav>
        </aside>

        <main class="main-content-profile">
            <section class="content-header">
                <h2>General Settings</h2>
            </section>

            <section class="profile-card settings-section">
                <h3>Profile Settings</h3>
                <div class="settings-form"> <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞, –Ω–µ —Ñ–æ—Ä–º–∞ -->
                    <div class="form-group">
                        <label for="avatarUrlInput">Profile Picture URL:</label>
                        <div id="avatarPreview" class="avatar-preview">No Image</div>
                        <input type="url" id="avatarUrlInput" name="avatarUrl" placeholder="Enter image URL (e.g., https://.../image.png)">
                        <small>For MVP, we use URL. File upload will be added later.</small>
                    </div>
                    <button type="button" id="saveAvatarBtn" class="action-button">Save Avatar</button>
                    <div id="avatarMessage" class="form-message"></div>
                </div>


                <form id="usernameSettingsForm" class="settings-form">
                     <div class="form-group">
                        <label for="usernameInput">Username:</label>
                        <span class="current-value" id="currentUsername">Loading...</span>
                        <input type="text" id="usernameInput" name="username" placeholder="Enter new username" minlength="3" required>
                    </div>
                    <button type="submit" class="action-button primary-action">Save Username</button>
                    <div id="usernameMessage" class="form-message"></div>
                </form>
            </section>

            <section class="profile-card settings-section">
                <h3>Preferences</h3>
                <form id="preferencesForm" class="settings-form">
                    <div class="form-group">
                        <label for="language">Language:</label>
                        <select id="language" name="language">
                            <option value="en">English</option>
                            <option value="ua" selected>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                            <option value="es">Espa√±ol</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="currency">Default Currency Display:</label>
                        <select id="currency" name="currency">
                            <option value="usd">USD</option>
                            <option value="eur">EUR</option>
                            <option value="uah">UAH</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="timezone">Timezone:</label>
                        <select id="timezone" name="timezone">
                            <option value="utc">UTC</option>
                            <option value="gmt3">(GMT+03:00) Kyiv</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label>Theme:</label>
                        <div class="radio-group">
                            <label><input type="radio" name="theme" value="light" checked> Light</label>
                            <label><input type="radio" name="theme" value="dark"> Dark</label>
                        </div>
                    </div>
                    <button type="submit" class="action-button primary-action">Save Preferences</button>
                     <div id="preferencesMessage" class="form-message"></div>
                </form>
            </section>

            <section class="profile-card settings-section">
                <h3>Notification Settings</h3>
                <form id="notificationsForm" class="settings-form">
                    <div class="form-group checkbox-group">
                        <label><input type="checkbox" name="email_trades" checked> Email on Trade Execution</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <label><input type="checkbox" name="email_deposits" checked> Email on Deposit/Withdrawal</label>
                    </div>
                     <div class="form-group checkbox-group">
                        <label><input type="checkbox" name="email_news"> Email for News & Announcements</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <label><input type="checkbox" name="push_alerts" disabled> Push Notifications for Price Alerts (App Only)</label>
                    </div>
                    <button type="submit" class="action-button primary-action">Save Notifications</button>
                     <div id="notificationsMessage" class="form-message"></div>
                </form>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    console.log('[SettingsPage] DOMContentLoaded.');
    const token = localStorage.getItem('authToken');

    const avatarPreview = document.getElementById('avatarPreview');
    const avatarUrlInput = document.getElementById('avatarUrlInput');
    const saveAvatarBtn = document.getElementById('saveAvatarBtn');
    const avatarMessage = document.getElementById('avatarMessage');

    const currentUsernameElement = document.getElementById('currentUsername');
    const usernameInput = document.getElementById('usernameInput');
    const usernameSettingsForm = document.getElementById('usernameSettingsForm');
    const usernameMessage = document.getElementById('usernameMessage');

    const preferencesForm = document.getElementById('preferencesForm');
    const preferencesMessage = document.getElementById('preferencesMessage');
    const notificationsForm = document.getElementById('notificationsForm');
    const notificationsMessage = document.getElementById('notificationsMessage');

    const logoutButton = document.getElementById('logoutButtonSettings');

    if (!token) {
        window.location.href = 'login-page.html'; // –®–ª—è—Ö –¥–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –≤—Ö–æ–¥—É
        return;
    }

    if (logoutButton) {
        logoutButton.style.display = 'inline-block';
        logoutButton.addEventListener('click', async () => {
            const currentToken = localStorage.getItem('authToken');
            localStorage.removeItem('authToken');
            try {
                await fetch('/auth/logout', { method: 'POST', headers: { 'Authorization': `Bearer ${currentToken}` }});
            } catch(e) { console.error('Logout API error', e); }
            window.location.href = 'login-page.html';
        });
    }

    async function fetchApiData(url, options = {}) {
        const currentToken = localStorage.getItem('authToken');
        const requiresAuth = options.requiresAuth !== undefined ? options.requiresAuth : true;

        if (requiresAuth && !currentToken) {
             window.location.href = 'login-page.html';
             return Promise.resolve({ success: false, message: 'Auth token missing, redirecting.', shouldRedirect: true });
        }
        const headers = { 'Content-Type': 'application/json' };
        if (requiresAuth && currentToken) {
            headers['Authorization'] = `Bearer ${currentToken}`;
        }
        const fetchOptions = { ...options, headers: { ...headers, ...options.headers } };
        try {
            const response = await fetch(url, fetchOptions);
            if (!response.ok) {
                if ((response.status === 401 || response.status === 403) && requiresAuth) {
                    localStorage.removeItem('authToken');
                    window.location.href = 'login-page.html';
                    return Promise.resolve({ success: false, message: `Auth error. Redirecting.`, shouldRedirect: true });
                }
                try {
                    const errorData = await response.json();
                    return { success: false, ...errorData };
                } catch (jsonError) {
                    const errorText = await response.text();
                    return { success: false, message: `Server error: ${response.status}. Resp: ${errorText.substring(0,100)}`};
                }
            }
            return response.json();
        } catch (error) {
             console.error(`[fetchApiData] Network error for ${url}:`, error);
             if (error.message && error.message.toLowerCase().includes("failed to fetch")) {
                alert(`Network error: Could not connect to server for ${url}.`);
             }
             return { success: false, message: error.message || `Network error.`, isFetchError: true };
        }
    }

    async function loadCurrentProfileSettings() {
        if(avatarMessage) avatarMessage.textContent = ''; 
        if(usernameMessage) usernameMessage.textContent = '';
        try {
            const data = await fetchApiData('/api/profile', { requiresAuth: true });
            if (data && data.success && data.profile) {
                const profile = data.profile;
                if (currentUsernameElement) currentUsernameElement.textContent = `Current: ${profile.username || 'Not set'}`;
                if (usernameInput) usernameInput.value = profile.username || '';
                
                if (avatarUrlInput) avatarUrlInput.value = profile.avatar_url || '';
                if (avatarPreview) {
                    if (profile.avatar_url) {
                        avatarPreview.style.backgroundImage = `url('${profile.avatar_url}')`;
                        avatarPreview.textContent = '';
                    } else {
                        avatarPreview.style.backgroundImage = 'none';
                        avatarPreview.textContent = 'No Image';
                    }
                }
            } else {
                const errorMsg = data ? data.message : 'Failed to load profile settings (undefined response).';
                alert(errorMsg);
            }
        } catch (error) {
            alert(error.message || 'Could not load profile settings due to an error.');
        }
    }

    if (saveAvatarBtn) {
        saveAvatarBtn.addEventListener('click', async () => {
            const newAvatarUrl = avatarUrlInput.value.trim();
            avatarMessage.textContent = 'Saving...';
            avatarMessage.className = 'form-message';

            try {
                const data = await fetchApiData('/api/profile/avatar', {
                    method: 'PUT',
                    body: JSON.stringify({ avatarUrl: newAvatarUrl }),
                    requiresAuth: true
                });
                if (data && data.success) {
                    avatarMessage.textContent = data.message || 'Avatar updated!';
                    avatarMessage.classList.add('success');
                    if (avatarPreview && data.avatarUrl !== undefined) {
                        if (data.avatarUrl) {
                            avatarPreview.style.backgroundImage = `url('${data.avatarUrl}')`;
                            avatarPreview.textContent = '';
                        } else {
                            avatarPreview.style.backgroundImage = 'none';
                            avatarPreview.textContent = 'No Image';
                        }
                    }
                } else {
                    avatarMessage.textContent = data.message || 'Failed to update avatar.';
                    avatarMessage.classList.add('error');
                }
            } catch (error) {
                avatarMessage.textContent = error.message || 'Error updating avatar.';
                avatarMessage.classList.add('error');
            }
        });
    }

    if (usernameSettingsForm) {
        usernameSettingsForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const newUsername = usernameInput.value.trim();
            usernameMessage.textContent = 'Saving...';
            usernameMessage.className = 'form-message';

            if (newUsername.length < 3) {
                usernameMessage.textContent = 'Username must be at least 3 characters.';
                usernameMessage.classList.add('error');
                return;
            }

            try {
                const data = await fetchApiData('/api/profile/username', {
                    method: 'PUT',
                    body: JSON.stringify({ newUsername: newUsername }),
                    requiresAuth: true
                });
                if (data && data.success) {
                    usernameMessage.textContent = data.message || 'Username updated!';
                    usernameMessage.classList.add('success');
                    if (currentUsernameElement && data.user) currentUsernameElement.textContent = `Current: ${data.user.username}`;
                    // –û—á–∏—â–∞—î–º–æ –ø–æ–ª–µ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∞–±–æ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è
                    if (usernameInput && data.user) usernameInput.value = data.user.username; 
                    
                    if (data.token) {
                        localStorage.setItem('authToken', data.token);
                        console.log('[SettingsPage] New JWT token saved after username update.');
                    }
                } else {
                    usernameMessage.textContent = data.message || 'Failed to update username.';
                    usernameMessage.classList.add('error');
                }
            } catch (error) {
                usernameMessage.textContent = error.message || 'Error updating username.';
                usernameMessage.classList.add('error');
            }
        });
    }
    
    // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∏ –¥–ª—è —ñ–Ω—à–∏—Ö —Ñ–æ—Ä–º
    function showNotImplementedMessage(form, messageElement) {
        if (form && messageElement) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                messageElement.textContent = 'This feature is not implemented yet.';
                messageElement.className = 'form-message'; // –°–∫–∏–¥–∞—î–º–æ –∫–ª–∞—Å–∏
                messageElement.style.color = 'orange';
            });
        }
    }
    showNotImplementedMessage(preferencesForm, preferencesMessage);
    showNotImplementedMessage(notificationsForm, notificationsMessage);

    loadCurrentProfileSettings();
});
</script>
</body>
</html>
