<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Settings - YuMa</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/global.css">
    <style>
        .avatar-preview {
            width: 100px; height: 100px; border-radius: 50%;
            background-color: #e0e0e0; margin-bottom: 1rem;
            background-size: cover; background-position: center;
            border: 2px solid #ccc;
            display: flex; align-items: center; justify-content: center;
            color: #777; font-size: 1.2rem;
        }
        .settings-form input[type="file"] { margin-top: 0.5rem; }
        .form-group .current-value {
            font-style: italic;
            color: #555;
            font-size: 0.9em;
            margin-bottom: 0.5em;
            display: block;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo"><a href="../../index.html">YuMa</a></div>
        <nav class="header-nav">
            <a href="buy_crypto-page.html" class="nav-button">Buy Crypto</a>
            <a href="markets.html" class="nav-button">Markets</a>
            <a href="trading-page.html" class="nav-button">Trade</a>
        </nav>
        <div class="header-actions">
            <button class="btn-deposit nav-button" onclick="window.location.href='deposit.html'">Deposit</button>
            <div class="icon-placeholder dark-square"></div>
            <div class="icon-placeholder"></div>
            <div class="icon-placeholder user-profile-icon"><a href="profile.html" title="Profile" style="text-decoration:none; color:inherit;">üë§</a></div>
            <div class="icon-placeholder"></div>
            <button id="logoutButtonSettings" class="nav-button" style="display: none;">Log out</button>
        </div>
    </header>

    <div class="page-wrapper-profile">
        <aside class="sidebar">
            <nav>
                <a href="profile.html" class="sidebar-button">dashboard</a>
                <a href="assets.html" class="sidebar-button">assets</a>
                <a href="order.html" class="sidebar-button">order</a>
                <a href="account.html" class="sidebar-button">account</a>
                <a href="settings.html" class="sidebar-button active">settings</a>
            </nav>
        </aside>

        <main class="main-content-profile">
            <section class="content-header">
                <h2>General Settings</h2>
            </section>

            <!-- –°–µ–∫—Ü—ñ—è –ü—Ä–æ—Ñ—ñ–ª—é -->
            <section class="profile-card settings-section">
                <h3>Profile Settings</h3>
                <form id="profileSettingsForm" class="settings-form">
                    <div class="form-group">
                        <label for="avatarUrl">Profile Picture URL:</label>
                        <div id="avatarPreview" class="avatar-preview">No Image</div>
                        <input type="url" id="avatarUrl" name="avatarUrl" placeholder="Enter image URL (e.g., https://.../image.png)">
                        <small>For MVP, we use URL. File upload will be added later.</small>
                    </div>
                    <button type="button" id="saveAvatarBtn" class="action-button">Save Avatar</button>
                    <div id="avatarMessage" class="form-message" style="margin-top:0.5rem;"></div>
                </form>
                <hr style="margin: 2rem 0;">
                <form id="usernameSettingsForm" class="settings-form">
                     <div class="form-group">
                        <label for="username">Username:</label>
                        <span class="current-value" id="currentUsername">Loading...</span>
                        <input type="text" id="username" name="username" placeholder="Enter new username" minlength="3">
                    </div>
                    <button type="submit" class="action-button primary-action">Save Username</button>
                    <div id="usernameMessage" class="form-message" style="margin-top:0.5rem;"></div>
                </form>
            </section>

            <!-- –°–µ–∫—Ü—ñ—è –ü–µ—Ä–µ–≤–∞–≥ (–∑–∞–ª–∏—à–∞—î–º–æ —è–∫ –±—É–ª–æ, –∞–ª–µ –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è/–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è) -->
            <section class="profile-card settings-section">
                <h3>Preferences</h3>
                <form id="preferencesForm" class="settings-form">
                    <div class="form-group">
                        <label for="language">Language:</label>
                        <select id="language" name="language">
                            <option value="en">English</option>
                            <option value="ua" selected>–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                            <option value="es">Espa√±ol</option>
                        </select>
                    </div>
                    <!-- ... —ñ–Ω—à—ñ –ø–æ–ª—è –ø–µ—Ä–µ–≤–∞–≥ ... -->
                    <button type="submit" class="action-button primary-action">Save Preferences</button>
                     <div id="preferencesMessage" class="form-message" style="margin-top:0.5rem;"></div>
                </form>
            </section>

            <!-- –°–µ–∫—Ü—ñ—è –°–ø–æ–≤—ñ—â–µ–Ω—å (–∑–∞–ª–∏—à–∞—î–º–æ —è–∫ –±—É–ª–æ, –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è/–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è) -->
            <section class="profile-card settings-section">
                <h3>Notification Settings</h3>
                <form id="notificationsForm" class="settings-form">
                    <!-- ... –ø–æ–ª—è —Å–ø–æ–≤—ñ—â–µ–Ω—å ... -->
                    <button type="submit" class="action-button primary-action">Save Notifications</button>
                     <div id="notificationsMessage" class="form-message" style="margin-top:0.5rem;"></div>
                </form>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    console.log('[SettingsPage] DOMContentLoaded.');
    const token = localStorage.getItem('authToken');

    const avatarPreview = document.getElementById('avatarPreview');
    const avatarUrlInput = document.getElementById('avatarUrlInput'); // –û–Ω–æ–≤–ª–µ–Ω–æ ID
    const saveAvatarBtn = document.getElementById('saveAvatarBtn');
    const avatarMessage = document.getElementById('avatarMessage');

    const currentUsernameElement = document.getElementById('currentUsername');
    const usernameInput = document.getElementById('usernameInput'); // –û–Ω–æ–≤–ª–µ–Ω–æ ID
    const usernameSettingsForm = document.getElementById('usernameSettingsForm');
    const usernameMessage = document.getElementById('usernameMessage');

    const logoutButton = document.getElementById('logoutButtonSettings');

    if (!token) {
        window.location.href = 'login-page.html';
        return;
    }

    if (logoutButton) {
        logoutButton.style.display = 'inline-block';
        logoutButton.addEventListener('click', async () => { /* ... –ª–æ–≥—ñ–∫–∞ –≤–∏—Ö–æ–¥—É ... */ });
    }

    async function fetchApiData(url, options = {}) {
        const currentToken = localStorage.getItem('authToken');
        const requiresAuth = options.requiresAuth !== undefined ? options.requiresAuth : true;
        console.log(`[fetchApiData] Fetching ${url}. Auth: ${requiresAuth}`);

        if (requiresAuth && !currentToken) {
             window.location.href = 'login-page.html';
             return Promise.resolve({ success: false, message: 'Auth token missing, redirecting.', shouldRedirect: true });
        }
        const headers = { 'Content-Type': 'application/json' };
        if (requiresAuth && currentToken) {
            headers['Authorization'] = `Bearer ${currentToken}`;
        }
        const fetchOptions = { ...options, headers: { ...headers, ...options.headers } };
        try {
            const response = await fetch(url, fetchOptions);
            // console.log(`[fetchApiData] Response status for ${url}: ${response.status}`);
            if (!response.ok) {
                if ((response.status === 401 || response.status === 403) && requiresAuth) {
                    localStorage.removeItem('authToken');
                    window.location.href = 'login-page.html';
                    return Promise.resolve({ success: false, message: `Unauthorized/Forbidden for ${url}. Redirecting.`, shouldRedirect: true });
                }
                try {
                    const errorData = await response.json();
                    console.error(`[fetchApiData] Server error for ${url} (status ${response.status}):`, errorData);
                    return { success: false, ...errorData }; // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ–±'—î–∫—Ç –ø–æ–º–∏–ª–∫–∏ –∑ —Å–µ—Ä–≤–µ—Ä–∞
                } catch (jsonError) {
                    const errorText = await response.text();
                    console.error(`[fetchApiData] Server error for ${url} (status ${response.status}). Resp not JSON:`, errorText);
                    return { success: false, message: `Server error: ${response.status}. Resp: ${errorText.substring(0,100)}`};
                }
            }
            return response.json(); // –ü–æ–≤–µ—Ä—Ç–∞—î Promise, —è–∫–∏–π —Ä–æ–∑–≤'—è–∑—É—î—Ç—å—Å—è –≤ JSON
        } catch (error) {
             console.error(`[fetchApiData] Network or other critical error for ${url}:`, error);
             if (error.message && error.message.toLowerCase().includes("failed to fetch")) {
                alert(`Network error: Could not connect to server for ${url}.`);
             }
             return { success: false, message: error.message || `Network error or unable to fetch ${url}.`, isFetchError: true };
        }
    }

    async function loadCurrentProfileSettings() {
        console.log('[SettingsPage] Loading current profile settings...');
        avatarMessage.textContent = ''; usernameMessage.textContent = ''; // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        try {
            const data = await fetchApiData('/api/profile', { requiresAuth: true });
            console.log('[SettingsPage] Profile data from server:', data);
            if (data && data.success && data.profile) {
                const profile = data.profile;
                if (currentUsernameElement) currentUsernameElement.textContent = `Current: ${profile.username || 'Not set'}`;
                if (usernameInput) usernameInput.placeholder = profile.username || 'Enter new username';
                
                if (avatarUrlInput) avatarUrlInput.value = profile.avatar_url || '';
                if (avatarPreview) {
                    if (profile.avatar_url) {
                        avatarPreview.style.backgroundImage = `url('${profile.avatar_url}')`;
                        avatarPreview.textContent = '';
                    } else {
                        avatarPreview.style.backgroundImage = 'none';
                        avatarPreview.textContent = 'No Image';
                    }
                }
            } else {
                const errorMsg = data ? data.message : 'Failed to load profile settings (undefined response).';
                console.error('[SettingsPage]', errorMsg);
                alert(errorMsg); // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
            }
        } catch (error) { // –¶–µ–π catch —Å–ø—Ä–∞—Ü—é—î, —è–∫—â–æ fetchApiData –ø–æ–≤–µ—Ä–Ω—É–ª–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–∏–π Promise
            console.error('[SettingsPage] Error loading profile settings in catch:', error);
            alert(error.message || 'Could not load profile settings due to an error.');
        }
    }

    if (saveAvatarBtn) {
        saveAvatarBtn.addEventListener('click', async () => {
            const newAvatarUrl = avatarUrlInput.value.trim();
            console.log('[SettingsPage] Save Avatar clicked. URL:', newAvatarUrl);
            avatarMessage.textContent = 'Saving...';
            avatarMessage.className = 'form-message'; // –°–∫–∏–¥–∞—î–º–æ –∫–ª–∞—Å

            try {
                const data = await fetchApiData('/api/profile/avatar', {
                    method: 'PUT',
                    body: JSON.stringify({ avatarUrl: newAvatarUrl }),
                    requiresAuth: true
                });
                console.log('[SettingsPage] Save Avatar response:', data);

                if (data && data.success) { // –ó–ê–í–ñ–î–ò –ü–ï–†–ï–í–Ü–†–Ø–ô–¢–ï –ù–ê–Ø–í–ù–Ü–°–¢–¨ data –ü–ï–†–ï–î data.success
                    avatarMessage.textContent = data.message || 'Avatar updated successfully!';
                    avatarMessage.classList.add('success');
                    if (avatarPreview) {
                        if (data.avatarUrl) { // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ URL –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å–µ—Ä–≤–µ—Ä–∞
                            avatarPreview.style.backgroundImage = `url('${data.avatarUrl}')`;
                            avatarPreview.textContent = '';
                        } else {
                            avatarPreview.style.backgroundImage = 'none';
                            avatarPreview.textContent = 'No Image';
                        }
                    }
                } else {
                    avatarMessage.textContent = data.message || 'Failed to update avatar.';
                    avatarMessage.classList.add('error');
                }
            } catch (error) { // –¶–µ–π catch —Å–ø—Ä–∞—Ü—é—î –¥–ª—è –ø–æ–º–∏–ª–æ–∫, —è–∫—ñ –ø–æ–≤–µ—Ä–Ω—É–ª–∞ fetchApiData
                console.error('[SettingsPage] Error saving avatar in catch:', error);
                avatarMessage.textContent = error.message || 'Error updating avatar.';
                avatarMessage.classList.add('error');
            }
        });
    }

    if (usernameSettingsForm) {
        usernameSettingsForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const newUsername = usernameInput.value.trim();
            console.log('[SettingsPage] Save Username submitted. New Username:', newUsername);
            usernameMessage.textContent = 'Saving...';
            usernameMessage.className = 'form-message';


            if (newUsername.length < 3) {
                usernameMessage.textContent = 'Username must be at least 3 characters.';
                usernameMessage.classList.add('error');
                return;
            }

            try {
                const data = await fetchApiData('/api/profile/username', {
                    method: 'PUT',
                    body: JSON.stringify({ newUsername: newUsername }),
                    requiresAuth: true
                });
                console.log('[SettingsPage] Save Username response:', data);

                if (data && data.success) {
                    usernameMessage.textContent = data.message || 'Username updated!';
                    usernameMessage.classList.add('success');
                    if (currentUsernameElement && data.user) currentUsernameElement.textContent = `Current: ${data.user.username}`;
                    if (usernameInput) usernameInput.value = '';
                    if (data.token) {
                        localStorage.setItem('authToken', data.token);
                        console.log('[SettingsPage] New JWT token saved after username update.');
                    }
                } else {
                    usernameMessage.textContent = data.message || 'Failed to update username.';
                    usernameMessage.classList.add('error');
                }
            } catch (error) {
                console.error('[SettingsPage] Error saving username in catch:', error);
                usernameMessage.textContent = error.message || 'Error updating username.';
                usernameMessage.classList.add('error');
            }
        });
    }
    
    
    // –û–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è —ñ–Ω—à–∏—Ö —Ñ–æ—Ä–º (–ø–æ–∫–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—É—é—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è)
    if(preferencesForm) {
        preferencesForm.addEventListener('submit', (e) => {
            e.preventDefault();
            preferencesMessage.textContent = 'Preferences saving not implemented yet.';
            preferencesMessage.style.color = 'orange';
        });
    }
    if(notificationsForm) {
        notificationsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            notificationsMessage.textContent = 'Notification settings saving not implemented yet.';
            notificationsMessage.style.color = 'orange';
        });
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    loadCurrentProfileSettings();
});
</script>
</body>
</html>
